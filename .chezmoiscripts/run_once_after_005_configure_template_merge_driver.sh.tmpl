#!/usr/bin/env sh

# Script: run_once_after_005_configure_template_merge_driver.sh.tmpl
# Purpose: Configure git merge driver for template files to prevent variable rendering during merges
# Requirements: Arch Linux, git

{{ includeTemplate "log_start" "Configuring git merge driver for template files..." }}

set -euo pipefail

# Make the merge driver script executable
chmod +x "{{ .chezmoi.sourceDir }}/.scripts/template-merge-driver.sh"

# Change to the chezmoi source directory to run git commands
cd "{{ .chezmoi.sourceDir }}"

# Configure git to use our custom merge driver for template files
{{ includeTemplate "log_step" "Registering chezmoi-template merge driver..." }}

git config merge.chezmoi-template.name "Chezmoi template merge driver"
git config merge.chezmoi-template.driver "{{ .chezmoi.sourceDir }}/.scripts/template-merge-driver.sh %O %A %B %L %P"

{{ includeTemplate "log_step" "Verifying merge driver configuration..." }}

# Verify the configuration was set correctly
if git config --get merge.chezmoi-template.driver >/dev/null 2>&1; then
    {{ includeTemplate "log_success" "Template merge driver configured successfully" }}
    {{ includeTemplate "log_info" "Template files (.tmpl) will now preserve variable syntax during merges" }}
else
    {{ includeTemplate "log_error" "Failed to configure template merge driver" }}
    exit 1
fi

{{ includeTemplate "log_complete" "Template merge protection is now active" }}