#!/usr/bin/env bash

# Script: run_once_after_010_setup_optional_services.sh.tmpl
# Purpose: Consolidated optional services setup (Voxtype STT, Home Backup)
# Requirements: Arch Linux, optional packages (voxtype-bin, restic)
# Execution: Runs AFTER file application to configure optional services
#
# This script consolidates:
# - Voxtype speech-to-text with Parakeet + CUDA
# - Restic home backup repository initialization
#
# Benefits of consolidation:
# - Single pass for optional service configuration
# - Consistent pattern: check package → configure → enable service
# - Graceful handling of missing packages (skip vs error)

{{ includeTemplate "log_start" "Setting up optional services (Voxtype, Home Backup)..." }}

set -euo pipefail

SERVICES_CONFIGURED=false

# ============================================================================
# SECTION 1: VOXTYPE SPEECH-TO-TEXT
# ============================================================================

echo ""
echo "════════════════════════════════════════════════════════════════"
echo "  SECTION 1: Voxtype Speech-to-Text"
echo "════════════════════════════════════════════════════════════════"
echo ""

VOXTYPE_CONFIGURED=false

if ! command -v voxtype >/dev/null 2>&1; then
    {{ includeTemplate "log_skip" "Voxtype not installed" }}
else
    # Input group (required for built-in hotkey)
    {{- $username := .chezmoi.username }}
    {{ includeTemplate "log_step" "Checking input group membership..." }}

    if id -nG {{ $username }} | grep -qw input; then
        {{ includeTemplate "log_skip" "User already in input group" }}
    else
        sudo usermod -aG input {{ $username }}
        {{ includeTemplate "log_success" "User added to input group" }}
        {{ includeTemplate "log_warning" "Logout/login required for group change" }}
    fi

    # GPU Detection (User-Level, No Sudo)
    {{ includeTemplate "log_step" "Detecting NVIDIA GPU..." }}

    NVIDIA_GPU=false
    CUDA_AVAILABLE=false

    if ! lspci | grep -i 'vga\|3d\|display' | grep -iq nvidia; then
        {{ includeTemplate "log_skip" "No NVIDIA GPU detected" }}
    else
        NVIDIA_GPU=true
        {{ includeTemplate "log_success" "NVIDIA GPU detected" }}

        if pacman -Q cuda >/dev/null 2>&1; then
            CUDA_AVAILABLE=true
        else
            {{ includeTemplate "log_warning" "CUDA package not installed" }}
        fi
    fi

    # GPU Acceleration Enablement (Requires Sudo)
    {{ includeTemplate "log_step" "Enabling GPU acceleration..." }}

    CURRENT_SYMLINK=$(readlink /usr/bin/voxtype)
    ENGINE_ENABLED=""
    BACKEND_USED=""

    if [ "$NVIDIA_GPU" = true ]; then
        if [ "$CUDA_AVAILABLE" = true ]; then
            if [ "$CURRENT_SYMLINK" = "/usr/lib/voxtype/voxtype-onnx-cuda" ]; then
                {{ includeTemplate "log_skip" "Parakeet engine already enabled" }}
                ENGINE_ENABLED="Parakeet"
                BACKEND_USED="ONNX CUDA"
            else
                sudo voxtype setup parakeet --enable
                {{ includeTemplate "log_success" "Parakeet engine enabled (CUDA)" }}
                ENGINE_ENABLED="Parakeet"
                BACKEND_USED="ONNX CUDA"
            fi
        else
            if [ "$CURRENT_SYMLINK" = "/usr/lib/voxtype/voxtype-vulkan" ]; then
                {{ includeTemplate "log_skip" "Vulkan GPU already enabled" }}
                ENGINE_ENABLED="Whisper"
                BACKEND_USED="Vulkan"
            else
                sudo voxtype setup gpu --enable
                {{ includeTemplate "log_success" "Whisper GPU acceleration enabled (Vulkan)" }}
                ENGINE_ENABLED="Whisper"
                BACKEND_USED="Vulkan"
            fi
        fi
    else
        {{ includeTemplate "log_skip" "No NVIDIA GPU - skipping GPU acceleration" }}
    fi

    # Download STT Model
    {{ includeTemplate "log_step" "Checking for STT model..." }}

    VOXTYPE_DATA="$HOME/.local/share/voxtype"

    if [ -d "$VOXTYPE_DATA" ] && [ "$(ls -A $VOXTYPE_DATA 2>/dev/null)" ]; then
        {{ includeTemplate "log_skip" "Model already downloaded" }}
    else
        {{ includeTemplate "log_step" "Downloading STT model (this may take a moment)..." }}
        voxtype setup model
        {{ includeTemplate "log_success" "STT model downloaded" }}
    fi

    # Enable Systemd User Service
    {{ includeTemplate "log_step" "Enabling voxtype systemd service..." }}

    if systemctl --user is-enabled --quiet voxtype; then
        {{ includeTemplate "log_skip" "Service already enabled" }}
    else
        systemctl --user enable --now voxtype
        {{ includeTemplate "log_success" "Voxtype service enabled" }}
    fi

    if systemctl --user is-active --quiet voxtype; then
        {{ includeTemplate "log_success" "Voxtype service running" }}
    else
        {{ includeTemplate "log_warning" "Voxtype service not active" }}
        {{ includeTemplate "log_info" "Check status: systemctl --user status voxtype" }}
    fi

    VOXTYPE_CONFIGURED=true
    SERVICES_CONFIGURED=true
fi

# ============================================================================
# SECTION 2: RESTIC HOME BACKUP
# ============================================================================

echo ""
echo "════════════════════════════════════════════════════════════════"
echo "  SECTION 2: Home Backup Repository"
echo "════════════════════════════════════════════════════════════════"
echo ""

BACKUP_CONFIGURED=false
PASSWORD_FILE="{{ .chezmoi.homeDir }}/.local/share/backups/.restic-password"
REPO="{{ .chezmoi.homeDir }}/.local/share/backups/home-backup"

if ! command -v restic >/dev/null 2>&1; then
    {{ includeTemplate "log_skip" "restic not installed — skipping home backup init" }}
    {{ includeTemplate "log_info" "To enable: add 'restic' to packages.yaml and run 'chezmoi apply'" }}
else
    {{ includeTemplate "log_success" "restic is installed" }}

    {{ includeTemplate "log_step" "Check if password file is available..." }}

    if [[ ! -f "$PASSWORD_FILE" ]]; then
        {{ includeTemplate "log_skip" "Password file not found at $PASSWORD_FILE — skipping init" }}
        {{ includeTemplate "log_info" "The encrypted password was not decrypted (missing age key?)" }}
        {{ includeTemplate "log_info" "To initialize manually: home-backup init" }}
    else
        {{ includeTemplate "log_success" "Password file found" }}

        {{ includeTemplate "log_step" "Check if repository already initialized..." }}

        if [[ -d "$REPO" ]]; then
            {{ includeTemplate "log_skip" "Repository already exists at $REPO — skipping init" }}
        else
            {{ includeTemplate "log_step" "Initializing home backup repository..." }}

            home-backup init --non-interactive

            {{ includeTemplate "log_success" "Repository initialized at $REPO" }}
            BACKUP_CONFIGURED=true
            SERVICES_CONFIGURED=true
        fi
    fi
fi

# ============================================================================
# SUMMARY
# ============================================================================

echo ""
echo "════════════════════════════════════════════════════════════════"
echo "  Optional Services Setup Complete"
echo "════════════════════════════════════════════════════════════════"
echo ""

if [ "$VOXTYPE_CONFIGURED" = true ]; then
    echo "  Voxtype Speech-to-Text:"
    echo "    Usage: Hold Super+T, speak, release"
    echo "    Text appears in clipboard - paste with Ctrl+V"
    if [ -n "$ENGINE_ENABLED" ]; then
        echo "    Engine: $ENGINE_ENABLED"
        echo "    Backend: $BACKEND_USED"
    fi
    echo ""
fi

if [ "$BACKUP_CONFIGURED" = true ]; then
    echo "  Home Backup:"
    echo "    Repository: $REPO"
    echo "    Schedule: daily at 2am (home-backup.timer)"
    echo "    Manual run: home-backup backup"
    echo ""
fi

if [ "$SERVICES_CONFIGURED" = false ]; then
    echo "  No optional services configured (packages not installed)"
    echo ""
fi

echo "════════════════════════════════════════════════════════════════"
echo ""

{{ includeTemplate "log_complete" "Optional services setup completed" }}
