#!/bin/sh

# Script: run_once_before_001_setup_logging.sh.tmpl
# Purpose: Set up unified logging system directory structure
# Requirements: Linux
# This script runs before all other scripts to ensure logging is available

{{- template "chezmoi_logger_setup" . }}

{{ if eq .chezmoi.os "linux" }}

log_system_operation "Setting up dual-output logging system"

# Create log directory structure
LOG_DIR="$(dirname "$LOG_FILE")"
log_file_operation "creating" "log directory"
mkdir -p "$LOG_DIR"

# Create initial log file
log_file_operation "initializing" "log file"
touch "$LOG_FILE"

# Set appropriate permissions
chmod 755 "$LOG_DIR"
chmod 644 "$LOG_FILE"

# Create log rotation script
log_file_operation "creating" "log rotation script"
cat > "$LOG_DIR/rotate_logs.sh" << 'EOF'
#!/bin/sh
# Log rotation script for chezmoi logs

LOG_DIR="$1"
MAX_FILES="${2:-10}"

if [ ! -d "$LOG_DIR" ]; then
    echo "Log directory does not exist: $LOG_DIR"
    exit 1
fi

# Rotate main log file
if [ -f "$LOG_DIR/chezmoi-setup.log" ]; then
    # Create dated backup
    DATE=$(date '+%Y-%m-%d')
    cp "$LOG_DIR/chezmoi-setup.log" "$LOG_DIR/chezmoi-setup-$DATE.log"
    
    # Clear main log file
    > "$LOG_DIR/chezmoi-setup.log"
    
    # Remove old log files (keep only MAX_FILES)
    find "$LOG_DIR" -name "chezmoi-setup-*.log" -type f | \
        sort -r | \
        tail -n +$((MAX_FILES + 1)) | \
        xargs rm -f
fi

echo "Log rotation completed"
EOF

chmod +x "$LOG_DIR/rotate_logs.sh"

# Log system information for debugging (only to file to keep console clean)
_log_to_file "DEBUG" "ðŸ”§" "Logging system configuration" "log_dir=$LOG_DIR log_file=$LOG_FILE log_level=$CURRENT_LOG_LEVEL console_colors=$CONSOLE_COLORS console_logging=$LOG_TO_CONSOLE file_logging=$LOG_TO_FILE"

log_success "Dual-output logging system ready"

{{ else }}
    echo "ERROR: This script is only supported on Linux systems"
    echo "Required: OS 'linux'"
    echo "Detected: '{{ .chezmoi.os }}'"
    echo "Script: $(basename "$0")"
    exit 1
{{ end }}
