#!/usr/bin/env sh

# Script: run_once_before_000_preflight_checks.sh.tmpl
# Purpose: Verify critical prerequisites before installation begins
# Requirements: Arch Linux base system

{{ includeTemplate "log_start" "Running preflight checks for fresh installation..." }}

set -euo pipefail

# Track if any checks fail
PREFLIGHT_FAILED=false

# ============================================================================
# CHECK 1: SUDO PRIVILEGES
# ============================================================================

{{ includeTemplate "log_step" "Verifying sudo privileges..." }}

if sudo -v >/dev/null 2>&1; then
    {{ includeTemplate "log_success" "User has sudo privileges" }}
else
    {{ includeTemplate "log_error" "User does not have sudo privileges" }}
    {{ includeTemplate "log_info" "Fix: Add user to wheel group and configure /etc/sudoers" }}
    {{ includeTemplate "log_info" "  1. sudo usermod -aG wheel $USER" }}
    {{ includeTemplate "log_info" "  2. sudo visudo (uncomment %wheel line)" }}
    PREFLIGHT_FAILED=true
fi

# ============================================================================
# CHECK 2: CRITICAL SYSTEM COMMANDS
# ============================================================================

{{ includeTemplate "log_step" "Verifying critical system commands..." }}

REQUIRED_COMMANDS="sudo git systemctl"
MISSING_COMMANDS=""

for cmd in $REQUIRED_COMMANDS; do
    if ! command -v "$cmd" >/dev/null 2>&1; then
        {{ includeTemplate "log_error" "Required command not found: $cmd" }}
        MISSING_COMMANDS="$MISSING_COMMANDS $cmd"
        PREFLIGHT_FAILED=true
    fi
done

if [ -z "$MISSING_COMMANDS" ]; then
    {{ includeTemplate "log_success" "All critical commands available: $REQUIRED_COMMANDS" }}
else
    {{ includeTemplate "log_error" "Missing commands:$MISSING_COMMANDS" }}
    {{ includeTemplate "log_info" "Fix: Install base system packages" }}
    {{ includeTemplate "log_info" "  sudo pacman -S base base-devel git" }}
fi

# ============================================================================
# CHECK 3: INTERNET CONNECTIVITY
# ============================================================================

{{ includeTemplate "log_step" "Verifying internet connectivity..." }}

# Test DNS resolution and connectivity to Arch Linux
if ping -c 1 -W 5 archlinux.org >/dev/null 2>&1; then
    {{ includeTemplate "log_success" "Internet connectivity verified (archlinux.org reachable)" }}
elif ping -c 1 -W 5 8.8.8.8 >/dev/null 2>&1; then
    {{ includeTemplate "log_warning" "Network accessible but DNS may have issues" }}
    {{ includeTemplate "log_info" "Can reach 8.8.8.8 but not archlinux.org" }}
    {{ includeTemplate "log_info" "Check DNS configuration in /etc/resolv.conf" }}
else
    {{ includeTemplate "log_error" "No internet connectivity detected" }}
    {{ includeTemplate "log_info" "Fix: Verify network connection" }}
    {{ includeTemplate "log_info" "  - Check network cable or WiFi connection" }}
    {{ includeTemplate "log_info" "  - Verify NetworkManager: systemctl status NetworkManager" }}
    {{ includeTemplate "log_info" "  - Test manually: ping 8.8.8.8" }}
    PREFLIGHT_FAILED=true
fi

# ============================================================================
# CHECK 4: PACKAGE MANAGER AVAILABILITY
# ============================================================================

{{ includeTemplate "log_step" "Verifying package manager..." }}

if command -v pacman >/dev/null 2>&1; then
    {{ includeTemplate "log_success" "pacman package manager available" }}

    # Check if pacman database is locked
    if [ -f /var/lib/pacman/db.lck ]; then
        {{ includeTemplate "log_warning" "pacman database is locked" }}
        {{ includeTemplate "log_info" "Another package operation may be in progress" }}
        {{ includeTemplate "log_info" "If stuck, remove lock: sudo rm /var/lib/pacman/db.lck" }}
    fi
else
    {{ includeTemplate "log_error" "pacman not found - not an Arch Linux system?" }}
    PREFLIGHT_FAILED=true
fi

# ============================================================================
# PREFLIGHT SUMMARY
# ============================================================================

echo ""
echo "════════════════════════════════════════════════════════════════"
echo "  Preflight Check Summary"
echo "════════════════════════════════════════════════════════════════"
echo ""

if [ "$PREFLIGHT_FAILED" = true ]; then
    {{ includeTemplate "log_error" "❌ PREFLIGHT FAILED - Fix issues above before proceeding" }}
    echo ""
    echo "  Critical issues detected. Installation cannot continue."
    echo "  Review error messages above and fix the problems."
    echo ""
    echo "  After fixing issues, run: chezmoi apply"
    echo ""
    echo "════════════════════════════════════════════════════════════════"
    echo ""
    exit 1
else
    {{ includeTemplate "log_success" "✅ ALL PREFLIGHT CHECKS PASSED" }}
    echo ""
    echo "  System prerequisites verified:"
    echo "    ✓ Sudo privileges available"
    echo "    ✓ Critical commands present (sudo, git, systemctl)"
    echo "    ✓ Internet connectivity confirmed"
    echo "    ✓ Package manager ready"
    echo ""
    echo "  Proceeding with installation..."
    echo ""
    echo "════════════════════════════════════════════════════════════════"
    echo ""
fi

{{ includeTemplate "log_complete" "Preflight checks completed successfully" }}
