#!/usr/bin/env sh

# Script: run_once_after_999_switch_to_ssh_remote.sh.tmpl
# Purpose: Switch git remote origin from HTTPS to SSH for the dotfiles repository
# Requirements: SSH keys must be already set up
# OS Support: linux-arch

set -euo pipefail

{{ includeTemplate "log_start" "Switching repository remote from HTTPS to SSH" }}

cd ~/.local/share/chezmoi

# Get current remote URL
current_url=$(git remote get-url origin)
{{ includeTemplate "log_info" "Current remote URL: $current_url" }}

# Check if already using SSH
if echo "$current_url" | grep -q "^git@"; then
    {{ includeTemplate "log_info" "Repository is already using SSH remote" }}
    exit 0
fi

# Verify SSH key is configured and working
{{ includeTemplate "log_step" "Verifying SSH key access to GitLab..." }}

if ssh -T git@gitlab.com 2>&1 | grep -qi "welcome"; then
    {{ includeTemplate "log_success" "SSH key authenticated successfully with GitLab" }}
elif ssh -T git@gitlab.com 2>&1 | grep -qi "successfully authenticated"; then
    {{ includeTemplate "log_success" "SSH key authenticated successfully with GitLab" }}
else
    {{ includeTemplate "log_warning" "SSH key not configured or not added to GitLab" }}
    {{ includeTemplate "log_info" "" }}
    {{ includeTemplate "log_info" "To use SSH remote, you need to:" }}
    {{ includeTemplate "log_info" "  1. Generate SSH key (if not exists): ssh-keygen -t ed25519 -C 'your_email@example.com'" }}
    {{ includeTemplate "log_info" "  2. Copy public key: cat ~/.ssh/id_ed25519.pub" }}
    {{ includeTemplate "log_info" "  3. Add to GitLab: https://gitlab.com/-/profile/keys" }}
    {{ includeTemplate "log_info" "  4. Test connection: ssh -T git@gitlab.com" }}
    {{ includeTemplate "log_info" "" }}
    {{ includeTemplate "log_info" "After configuring SSH key, manually switch remote:" }}
    {{ includeTemplate "log_info" "  cd ~/.local/share/chezmoi" }}
    {{ includeTemplate "log_info" "  git remote set-url origin git@gitlab.com:amoconst/dotfiles.git" }}
    {{ includeTemplate "log_info" "" }}
    {{ includeTemplate "log_skip" "Skipping SSH remote switch - will continue using HTTPS" }}
    {{ includeTemplate "log_info" "Installation can continue normally with HTTPS remote" }}
    exit 0
fi

# Switch to SSH remote
ssh_url="git@gitlab.com:amoconst/dotfiles.git"
{{ includeTemplate "log_step" "Switching to SSH URL: $ssh_url" }}

git remote set-url origin "$ssh_url"

# Verify the change
new_url=$(git remote get-url origin)
{{ includeTemplate "log_success" "Remote URL updated to: $new_url" }}
