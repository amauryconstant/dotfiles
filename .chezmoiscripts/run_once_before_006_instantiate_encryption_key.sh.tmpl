#!/bin/sh

{{ includeTemplate "arch_linux_check" . }}

{{ includeTemplate "log_start" "Setting up encryption key from vault..." }}

{{ includeTemplate "log_step" "Configuring rbw vault settings..." }}
rbw config set email {{ .personalEmail }}
rbw config set base_url {{ .privateServer | replace "www" "vaultwarden" }}

{{ includeTemplate "log_step" "Logging into vault..." }}
rbw login

{{ includeTemplate "log_step" "Syncing vault data..." }}
rbw sync

{{ includeTemplate "log_step" "Retrieving dotfiles encryption key..." }}
rbw get dotfiles-key > $HOME/.keys/dotfiles-key.txt

{{ includeTemplate "log_step" "Securing vault session..." }}
rbw lock

{{ includeTemplate "log_step" "Setting secure permissions on keys..." }}
chmod 600 ~/.keys/*

{{ includeTemplate "log_complete" "Encryption key setup completed" }}
