#!/bin/sh
# Chezmoi orchestrator script for write globals

{{- template "chezmoi_logger_setup" . }}

{{ if eq .chezmoi.os "linux" }}
    
    log_step "Preparing environment for writing global variables"
    
    # Export all necessary environment variables
    export CHEZMOI_OS_ID="{{ .osId }}"
    export CHEZMOI_DESTINATION="{{ .destination }}"
    export CHEZMOI_SOURCE_DIR="{{ .chezmoi.sourceDir }}"
    export CHEZMOI_FIRSTNAME="{{ .firstname }}"
    export CHEZMOI_FULLNAME="{{ .fullname }}"
    export CHEZMOI_DRY_RUN="${CHEZMOI_DRY_RUN:-false}"
    export CHEZMOI_VERBOSE="${CHEZMOI_VERBOSE:-false}"
    
    # Convert globals to comma-separated format for the pure shell script
    export CHEZMOI_GLOBALS_DATA="{{- $first := true -}}{{- range $key, $value := .globals.linux -}}{{- if not $first -}},{{- end -}}{{ $key }}={{ $value }}{{- $first = false -}}{{- end -}}"
    
    # Determine script path
    SCRIPT_PATH="${CHEZMOI_SOURCE_DIR}/.chezmoiscripts/.lib/system/write-globals.sh"
    
    log_info "Executing: $(basename "$SCRIPT_PATH")"
    
    # Execute with error handling
    if [ -x "$SCRIPT_PATH" ]; then
        if ! "$SCRIPT_PATH"; then
            handle_error "Script execution failed: $(basename "$SCRIPT_PATH")" $?
        fi
    else
        log_error "Script not found or not executable: $SCRIPT_PATH"
        exit 1
    fi
    
    log_success "Global variables setup completed successfully"
    
{{ else }}
    log_error "Unsupported OS: {{ .chezmoi.os }}"
    log_error "This script requires: linux"
    exit 1
{{ end }}
