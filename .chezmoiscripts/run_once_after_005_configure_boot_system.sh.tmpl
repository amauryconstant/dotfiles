#!/usr/bin/env bash

# Script: run_once_after_005_configure_boot_system.sh.tmpl
# Purpose: Consolidated boot system configuration (GPU + Plymouth + SDDM + Hibernation)
# Requirements: Arch Linux, Plymouth, SDDM, Hyprland, Btrfs
# Execution: Runs AFTER file application to configure complete boot stack
#
# This script consolidates:
# - GPU driver configuration (NVIDIA DKMS)
# - Plymouth graphical boot splash
# - SDDM display manager
# - Hibernation (Btrfs swapfile + resume)
#
# Benefits of consolidation:
# - Single mkinitcpio -P rebuild (instead of 4×)
# - Atomic boot configuration changes
# - Consistent backup/rollback strategy

{{ includeTemplate "log_start" "Configure complete boot system (GPU + Plymouth + SDDM + Hibernation)" }}

# Set strict error handling
set -euo pipefail

# Add error trap for cleanup guidance
trap 'echo "❌ [ERROR] Boot system configuration failed - check logs above" >&2; echo "ℹ️  [INFO] To rollback: sudo cp /etc/kernel/cmdline.backup /etc/kernel/cmdline && sudo mkinitcpio -P"; exit 1' ERR

# ============================================================================
# SECTION 1: GPU DRIVER CONFIGURATION (NVIDIA)
# ============================================================================

echo ""
{{ includeTemplate "log_info" "════════════════════════════════════════════════════════════════" }}
{{ includeTemplate "log_info" "  SECTION 1: GPU Driver Configuration" }}
{{ includeTemplate "log_info" "════════════════════════════════════════════════════════════════" }}
echo ""

# Initialize variables for NVIDIA DKMS information (available in summary)
KERNELS_BUILT_COUNT=0
ALL_BUILT=""

{{ includeTemplate "log_step" "Detect GPU vendor" }}

# Detect GPU using lspci
GPU_VENDOR=$(lspci | grep -i 'vga\|3d\|display' | grep -i nvidia || true)
NVIDIA_DETECTED=false

if [ -z "$GPU_VENDOR" ]; then
    {{ includeTemplate "log_skip" "No NVIDIA GPU detected - skipping NVIDIA configuration" }}
else
    {{ includeTemplate "log_info" "NVIDIA GPU detected: $GPU_VENDOR" }}
    NVIDIA_DETECTED=true

    {{ includeTemplate "log_step" "Configure initramfs NVIDIA modules BEFORE package installation" }}

    # CRITICAL: Configure mkinitcpio BEFORE installing nvidia-open-dkms
    # This ensures DKMS builds modules with the correct configuration from the start

    # Create mkinitcpio configuration directory
    sudo mkdir -p /etc/mkinitcpio.conf.d

    # Check if initramfs configuration already exists and is correct
    NVIDIA_CONF="/etc/mkinitcpio.conf.d/nvidia.conf"
    NVIDIA_CONF_NEEDS_UPDATE=false

    if [ -f "$NVIDIA_CONF" ]; then
        # Check if existing file has correct content (flexible whitespace handling)
        # Must include i915 for hybrid graphics
        # Use sudo to read file (owned by root)
        if sudo grep -Eq "^MODULES=\(i915 nvidia nvidia_modeset nvidia_uvm nvidia_drm\)\s*$" "$NVIDIA_CONF"; then
            {{ includeTemplate "log_success" "Initramfs NVIDIA configuration already correct" }}
        else
            {{ includeTemplate "log_info" "Updating initramfs NVIDIA configuration..." }}
            NVIDIA_CONF_NEEDS_UPDATE=true
        fi
    else
        {{ includeTemplate "log_info" "Creating initramfs NVIDIA configuration..." }}
        NVIDIA_CONF_NEEDS_UPDATE=true
    fi

    # Create/update NVIDIA-specific module configuration if needed
    if [ "$NVIDIA_CONF_NEEDS_UPDATE" = true ]; then
        # CRITICAL: With DKMS, we KEEP 'kms' in HOOKS (early kernel mode setting)
        # CRITICAL: On hybrid graphics (Intel + NVIDIA), load i915 BEFORE nvidia modules
        #           This prevents Electron/Chromium apps from stalling ~1min after boot
        sudo tee "$NVIDIA_CONF" > /dev/null <<'EOF'
# NVIDIA DKMS module configuration
# These modules enable early kernel mode setting (KMS) for NVIDIA GPUs
# IMPORTANT: DO NOT remove 'kms' from HOOKS when using DKMS
# IMPORTANT: i915 loaded first to prevent Electron/Chromium stalling on hybrid graphics
MODULES=(i915 nvidia nvidia_modeset nvidia_uvm nvidia_drm)
EOF
        sudo chmod 644 "$NVIDIA_CONF"
        {{ includeTemplate "log_success" "Created/updated $NVIDIA_CONF" }}
        {{ includeTemplate "log_info" "NVIDIA kernel modules loaded via extramodules" }}
    fi

    {{ includeTemplate "log_step" "Verify NVIDIA drivers installed" }}

    # Check if NVIDIA packages are installed
    NVIDIA_PACKAGES=("nvidia-utils" "nvidia-open" "nvidia-open-lts")
    ALL_INSTALLED=true

    for pkg in "${NVIDIA_PACKAGES[@]}"; do
        if ! pacman -Q "$pkg" >/dev/null 2>&1; then
            {{ includeTemplate "log_error" "Package not installed: $pkg" }}
            ALL_INSTALLED=false
        fi
    done

    if [ "$ALL_INSTALLED" = true ]; then
        {{ includeTemplate "log_success" "All NVIDIA packages installed" }}
    else
        {{ includeTemplate "log_error" "Some NVIDIA packages missing" }}
        exit 1
    fi

    {{ includeTemplate "log_step" "Enable NVIDIA power management services" }}

    # Re-enable NVIDIA power management services (removed during package reinstall)
    # These services handle suspend/resume/hibernate for NVIDIA GPUs
    NVIDIA_SERVICES=(
        "nvidia-suspend.service"
        "nvidia-hibernate.service"
        "nvidia-resume.service"
    )

    for service in "${NVIDIA_SERVICES[@]}"; do
        if systemctl list-unit-files "$service" >/dev/null 2>&1; then
            if systemctl is-enabled "$service" >/dev/null 2>&1; then
                {{ includeTemplate "log_success" "$service already enabled" }}
            else
                sudo systemctl enable "$service"
                {{ includeTemplate "log_success" "$service enabled" }}
            fi
        else
            {{ includeTemplate "log_warning" "$service not found" }}
        fi
    done

    {{ includeTemplate "log_success" "GPU driver configuration complete" }}
fi

# ============================================================================
# SECTION 2: PLYMOUTH CONFIGURATION
# ============================================================================

echo ""
{{ includeTemplate "log_info" "════════════════════════════════════════════════════════════════" }}
{{ includeTemplate "log_info" "  SECTION 2: Plymouth Graphical Boot Splash" }}
{{ includeTemplate "log_info" "════════════════════════════════════════════════════════════════" }}
echo ""

{{ includeTemplate "log_step" "Verify Plymouth installation" }}

if ! command -v plymouth >/dev/null 2>&1; then
    {{ includeTemplate "log_skip" "Plymouth not installed - skipping Plymouth configuration" }}
    PLYMOUTH_INSTALLED=false
else
    {{ includeTemplate "log_success" "Plymouth is installed" }}
    PLYMOUTH_INSTALLED=true

    {{ includeTemplate "log_step" "Configure mkinitcpio hooks for Plymouth" }}

    MKINITCPIO_CONF="/etc/mkinitcpio.conf"
    MKINITCPIO_BACKUP="${MKINITCPIO_CONF}.backup"

    # Detect if system uses encryption (encrypt or sd-encrypt hook)
    USES_ENCRYPTION=false
    if grep -Eq "^HOOKS=.*(encrypt|sd-encrypt)" "$MKINITCPIO_CONF"; then
        USES_ENCRYPTION=true
        {{ includeTemplate "log_info" "System uses disk encryption - plymouth will be added before encrypt hook" }}
    else
        {{ includeTemplate "log_info" "System does not use disk encryption - plymouth will be added before filesystems hook" }}
    fi

    # Check if plymouth hook is already configured correctly
    if [ "$USES_ENCRYPTION" = true ]; then
        # For encrypted systems: plymouth must be before encrypt/sd-encrypt
        if grep -Eq "^HOOKS=.*plymouth.*(encrypt|sd-encrypt)" "$MKINITCPIO_CONF"; then
            {{ includeTemplate "log_success" "Plymouth hook already configured before encrypt hook" }}
            PLYMOUTH_HOOK_CHANGED=false
        else
            {{ includeTemplate "log_info" "Adding plymouth hook before encrypt in mkinitcpio.conf..." }}

            # Create backup only if it doesn't already exist
            if [ ! -f "$MKINITCPIO_BACKUP" ]; then
                sudo cp "$MKINITCPIO_CONF" "$MKINITCPIO_BACKUP"
                {{ includeTemplate "log_info" "Created backup: $MKINITCPIO_BACKUP" }}
            fi

            # Insert plymouth before encrypt or sd-encrypt in HOOKS array
            # Handles both: encrypt and sd-encrypt
            sudo sed -i 's/\(HOOKS=([^)]*block\) \(encrypt\|sd-encrypt\)/\1 plymouth \2/' "$MKINITCPIO_CONF"

            # Verify the change was successful
            if grep -Eq "^HOOKS=.*plymouth.*(encrypt|sd-encrypt)" "$MKINITCPIO_CONF"; then
                {{ includeTemplate "log_success" "Plymouth hook added successfully before encrypt hook" }}
                PLYMOUTH_HOOK_CHANGED=true
            else
                {{ includeTemplate "log_error" "Failed to add plymouth hook - manual intervention required" }}
                {{ includeTemplate "log_info" "Please manually edit $MKINITCPIO_CONF to add 'plymouth' before 'encrypt' or 'sd-encrypt' in HOOKS" }}
                exit 1
            fi
        fi
    else
        # For non-encrypted systems: plymouth should be before filesystems
        if grep -q "^HOOKS=.*plymouth.*filesystems" "$MKINITCPIO_CONF"; then
            {{ includeTemplate "log_success" "Plymouth hook already configured before filesystems hook" }}
            PLYMOUTH_HOOK_CHANGED=false
        else
            {{ includeTemplate "log_info" "Adding plymouth hook before filesystems in mkinitcpio.conf..." }}

            # Create backup only if it doesn't already exist
            if [ ! -f "$MKINITCPIO_BACKUP" ]; then
                sudo cp "$MKINITCPIO_CONF" "$MKINITCPIO_BACKUP"
                {{ includeTemplate "log_info" "Created backup: $MKINITCPIO_BACKUP" }}
            fi

            # Insert plymouth before filesystems in HOOKS array
            # Current: HOOKS=(base udev autodetect microcode modconf kms keyboard keymap consolefont block filesystems fsck)
            # Target:  HOOKS=(base udev autodetect microcode modconf kms keyboard keymap consolefont block plymouth filesystems fsck)
            sudo sed -i 's/\(HOOKS=([^)]*block\) \(filesystems\)/\1 plymouth \2/' "$MKINITCPIO_CONF"

            # Verify the change was successful
            if grep -q "^HOOKS=.*plymouth.*filesystems" "$MKINITCPIO_CONF"; then
                {{ includeTemplate "log_success" "Plymouth hook added successfully before filesystems hook" }}
                PLYMOUTH_HOOK_CHANGED=true
            else
                {{ includeTemplate "log_error" "Failed to add plymouth hook - manual intervention required" }}
                {{ includeTemplate "log_info" "Please manually edit $MKINITCPIO_CONF to add 'plymouth' before 'filesystems' in HOOKS" }}
                exit 1
            fi
        fi
    fi

    {{ includeTemplate "log_step" "Configure Plymouth kernel parameters" }}

    CMDLINE_FILE="/etc/kernel/cmdline"

    if [ -f "$CMDLINE_FILE" ]; then
        # Check if Plymouth parameters are already present
        if grep -q "splash" "$CMDLINE_FILE" && grep -q "quiet" "$CMDLINE_FILE"; then
            {{ includeTemplate "log_success" "Plymouth kernel parameters already configured" }}
            PLYMOUTH_CMDLINE_CHANGED=false
        else
            {{ includeTemplate "log_info" "Adding splash and quiet parameters to kernel cmdline..." }}

            # Create backup only if it doesn't already exist
            if [ ! -f "${CMDLINE_FILE}.backup" ]; then
                sudo cp "$CMDLINE_FILE" "${CMDLINE_FILE}.backup"
                {{ includeTemplate "log_info" "Created backup: ${CMDLINE_FILE}.backup" }}
            fi

            # Read current cmdline
            CURRENT_CMDLINE=$(cat "$CMDLINE_FILE")

            # Add splash and quiet parameters
            NEW_CMDLINE="$CURRENT_CMDLINE"
            if ! echo "$CURRENT_CMDLINE" | grep -q "splash"; then
                NEW_CMDLINE="$NEW_CMDLINE splash"
            fi
            if ! echo "$CURRENT_CMDLINE" | grep -q "quiet"; then
                NEW_CMDLINE="$NEW_CMDLINE quiet"
            fi

            # Write updated cmdline
            echo "$NEW_CMDLINE" | sudo tee "$CMDLINE_FILE" > /dev/null

            {{ includeTemplate "log_success" "Plymouth kernel parameters added to $CMDLINE_FILE" }}
            PLYMOUTH_CMDLINE_CHANGED=true
        fi
    else
        {{ includeTemplate "log_warning" "No /etc/kernel/cmdline found - skipping Plymouth kernel parameters" }}
        PLYMOUTH_CMDLINE_CHANGED=false
    fi

    {{ includeTemplate "log_step" "Set Plymouth theme" }}

    DESIRED_THEME="{{ .globals.plymouth.theme }}"
    CURRENT_THEME=$(plymouth-set-default-theme)

    if [ "$CURRENT_THEME" = "$DESIRED_THEME" ]; then
        {{ includeTemplate "log_success" "Plymouth theme already set to: $DESIRED_THEME" }}
        PLYMOUTH_THEME_CHANGED=false
    else
        {{ includeTemplate "log_info" "Setting Plymouth theme to: $DESIRED_THEME (current: $CURRENT_THEME)" }}

        # Set theme (don't rebuild yet - we'll do it once at the end)
        sudo plymouth-set-default-theme "$DESIRED_THEME"

        {{ includeTemplate "log_success" "Plymouth theme set to: $DESIRED_THEME" }}
        PLYMOUTH_THEME_CHANGED=true
    fi

    {{ includeTemplate "log_success" "Plymouth configuration complete" }}
fi

# ============================================================================
# SECTION 3: SDDM CONFIGURATION
# ============================================================================

echo ""
{{ includeTemplate "log_info" "════════════════════════════════════════════════════════════════" }}
{{ includeTemplate "log_info" "  SECTION 3: SDDM Display Manager" }}
{{ includeTemplate "log_info" "════════════════════════════════════════════════════════════════" }}
echo ""

{{ includeTemplate "log_step" "Verify SDDM installation" }}

if ! command -v sddm >/dev/null 2>&1; then
    {{ includeTemplate "log_skip" "SDDM not installed - skipping SDDM configuration" }}
    SDDM_INSTALLED=false
else
    {{ includeTemplate "log_success" "SDDM is installed" }}
    SDDM_INSTALLED=true

    {{ includeTemplate "log_step" "Create SDDM configuration directory" }}

    SDDM_CONF_DIR="/etc/sddm.conf.d"

    if [ ! -d "$SDDM_CONF_DIR" ]; then
        {{ includeTemplate "log_info" "Creating $SDDM_CONF_DIR..." }}
        sudo mkdir -p "$SDDM_CONF_DIR"
        {{ includeTemplate "log_success" "Created $SDDM_CONF_DIR" }}
    else
        {{ includeTemplate "log_success" "$SDDM_CONF_DIR already exists" }}
    fi

    {{ includeTemplate "log_step" "Backup original SDDM configuration" }}

    SDDM_CONF="/etc/sddm.conf"
    SDDM_BACKUP="${SDDM_CONF}.backup"

    if [ -f "$SDDM_CONF" ] && [ ! -f "$SDDM_BACKUP" ]; then
        {{ includeTemplate "log_info" "Creating backup: $SDDM_BACKUP" }}
        sudo cp "$SDDM_CONF" "$SDDM_BACKUP"
        {{ includeTemplate "log_success" "Backup created" }}
    elif [ -f "$SDDM_BACKUP" ]; then
        {{ includeTemplate "log_success" "Backup already exists: $SDDM_BACKUP" }}
    else
        {{ includeTemplate "log_info" "No existing $SDDM_CONF to backup" }}
    fi

    {{ includeTemplate "log_step" "Configure SDDM for Hyprland/Wayland" }}

    SDDM_HYPRLAND_CONF="$SDDM_CONF_DIR/10-hyprland.conf"
    DESIRED_THEME="{{ .globals.sddm.theme }}"
    _DESIRED_DISPLAY_SERVER="{{ .globals.sddm.display_server }}"  # Unused: hardcoded in heredoc

    {{ includeTemplate "log_info" "Creating $SDDM_HYPRLAND_CONF..." }}

    # Create modular SDDM configuration optimized for Hyprland
    sudo tee "$SDDM_HYPRLAND_CONF" > /dev/null << 'EOF'
# SDDM Configuration for Hyprland
# Managed by chezmoi - DO NOT EDIT MANUALLY
# To modify: Edit .chezmoidata/globals.yaml and run 'chezmoi apply'

[General]
# Use X11 display server (fixes Wayland→Wayland handoff crash on first login)
DisplayServer={{ .globals.sddm.display_server }}

# Enable NumLock by default
Numlock=on

[Theme]
# Current theme
Current={{ .globals.sddm.theme }}

# Enable user avatars
EnableAvatars=true

[Users]
# Remember last session (Hyprland)
RememberLastSession=true

# Remember last user
RememberLastUser=true

# Restore session instead of creating new
ReuseSession=true

[Wayland]
# Wayland compositor for SDDM greeter
# Note: This is for the greeter only, NOT Hyprland itself
# Hyprland starts after successful login via SessionCommand
CompositorCommand=weston --shell=fullscreen-shell.so

# Enable Qt's automatic high-DPI scaling
EnableHiDPI=true

# Session directories (includes Hyprland.desktop)
SessionDir=/usr/local/share/wayland-sessions,/usr/share/wayland-sessions

# Session log location
SessionLogFile=.local/share/sddm/wayland-session.log
EOF

    {{ includeTemplate "log_success" "Created $SDDM_HYPRLAND_CONF" }}

    {{ includeTemplate "log_step" "Verify SDDM theme installation" }}

    THEME_DIR="/usr/share/sddm/themes/$DESIRED_THEME"

    if [ ! -d "$THEME_DIR" ]; then
        {{ includeTemplate "log_error" "Theme not found: $THEME_DIR" }}
        {{ includeTemplate "log_info" "Available themes:" }}
        ls -1 /usr/share/sddm/themes/
        {{ includeTemplate "log_info" "Install the theme or update globals.yaml with an available theme" }}
        exit 1
    fi

    {{ includeTemplate "log_success" "Theme installed at $THEME_DIR" }}

    {{ includeTemplate "log_step" "Verify Hyprland session availability" }}

    if [ -f /usr/share/wayland-sessions/hyprland.desktop ]; then
        {{ includeTemplate "log_success" "Hyprland Wayland session available" }}
    elif [ -f /usr/share/wayland-sessions/hyprland-uwsm.desktop ]; then
        {{ includeTemplate "log_success" "Hyprland UWSM-managed session available" }}
    else
        {{ includeTemplate "log_error" "No Hyprland Wayland session found" }}
        {{ includeTemplate "log_info" "Available sessions:" }}
        ls -1 /usr/share/wayland-sessions/ || {{ includeTemplate "log_info" "No Wayland sessions found" }}
        exit 1
    fi

    {{ includeTemplate "log_step" "Verify SDDM service status" }}

    if systemctl is-enabled sddm.service >/dev/null 2>&1; then
        {{ includeTemplate "log_success" "SDDM service is enabled" }}
    else
        {{ includeTemplate "log_info" "SDDM service is not enabled - enabling now..." }}
        sudo systemctl enable sddm.service
        {{ includeTemplate "log_success" "SDDM service enabled" }}
    fi

    {{ includeTemplate "log_success" "SDDM configuration complete" }}
fi

# ============================================================================
# SECTION 4: HIBERNATION CONFIGURATION
# ============================================================================

echo ""
{{ includeTemplate "log_info" "════════════════════════════════════════════════════════════════" }}
{{ includeTemplate "log_info" "  SECTION 4: Hibernation Configuration" }}
{{ includeTemplate "log_info" "════════════════════════════════════════════════════════════════" }}
echo ""

HIBERNATION_ENABLED=false
SWAP_ENABLED=false
HIBERNATION_CHANGED=false
MEM_SIZE_HUMAN=""
SWAP_SIZE_HUMAN=""

SWAP_SUBVOLUME="/swap"
SWAP_FILE="$SWAP_SUBVOLUME/swapfile"
RESUME_CONF="/etc/mkinitcpio.conf.d/resume.conf"

# Detect unsupported configurations
HIBERNATION_UNSUPPORTED=""
ROOT_DEV=$(findmnt -n -o SOURCE /)

# Check for device-mapper (LUKS, LVM)
if [[ "$ROOT_DEV" == /dev/mapper/* ]]; then
    {{ includeTemplate "log_skip" "Root on device-mapper ($ROOT_DEV) — Btrfs swapfile not supported" }}
    HIBERNATION_UNSUPPORTED="device-mapper"
fi

# Check for multi-device Btrfs
if [[ -z "$HIBERNATION_UNSUPPORTED" ]] && command -v btrfs &>/dev/null; then
    DEVICE_COUNT=$(btrfs filesystem show / 2>/dev/null | grep -c "devid" || echo 0)
    if [ "$DEVICE_COUNT" -gt 1 ]; then
        {{ includeTemplate "log_skip" "Multi-device Btrfs ($DEVICE_COUNT devices) — swapfile not supported" }}
        HIBERNATION_UNSUPPORTED="multi-device"
    fi
fi

if [[ -z "$HIBERNATION_UNSUPPORTED" ]]; then
    {{ includeTemplate "log_step" "Check hibernation support" }}

if [[ ! -f /sys/power/image_size ]]; then
    {{ includeTemplate "log_skip" "Hibernation not supported on this system" }}
else
    {{ includeTemplate "log_success" "Hibernation is supported" }}

    {{ includeTemplate "log_step" "Check existing configuration" }}

    HIBERNATION_CONFIGURED=false
    SWAP_EXISTS=false

    if [ -f "$RESUME_CONF" ] && grep -q "^HOOKS+=(resume)$" "$RESUME_CONF"; then
        HIBERNATION_CONFIGURED=true
        {{ includeTemplate "log_success" "Hibernation already configured" }}
        HIBERNATION_ENABLED=true
        SWAP_SIZE_HUMAN=$(free -h | awk '/Mem/ {print $2}')
    elif sudo swaplabel "$SWAP_FILE" &>/dev/null; then
        SWAP_EXISTS=true
        SWAP_SIZE_HUMAN=$(ls -lh "$SWAP_FILE" | awk '{print $5}')
        {{ includeTemplate "log_info" "Swapfile exists but hibernation not configured" }}
    fi

    if [ "$HIBERNATION_CONFIGURED" = false ]; then
        if [ "$SWAP_EXISTS" = true ]; then
            {{ includeTemplate "log_step" "Enable hibernation on existing swapfile?" }}

            if [[ "${1:-}" != "--force" ]]; then
                if gum confirm "Enable hibernation on existing swapfile?"; then
                    HIBERNATION_ENABLED=true
                    SWAP_ENABLED=true
                fi
            else
                HIBERNATION_ENABLED=true
                SWAP_ENABLED=true
            fi
        else
            {{ includeTemplate "log_step" "Gather system information" }}

            MEM_SIZE_HUMAN=$(free -h | awk '/Mem/ {print $2}')
            MEM_TOTAL_KB=$(awk '/MemTotal/ {print $2}' /proc/meminfo)
            SWAP_SIZE_FULL_KB="$MEM_TOTAL_KB"
            SWAP_SIZE_HALF_KB=$((MEM_TOTAL_KB / 2))
            SWAP_SIZE_FULL_HUMAN="$MEM_SIZE_HUMAN"
            SWAP_SIZE_HALF_HUMAN=$(numfmt --to=iec --suffix=B $((SWAP_SIZE_HALF_KB * 1024)) | sed 's/B$/i/')

            DISK_INFO=$(df -h --output=size,used,avail / | tail -1)
            DISK_TOTAL=$(echo "$DISK_INFO" | awk '{print $1}')
            DISK_USED=$(echo "$DISK_INFO" | awk '{print $2}')
            DISK_AVAIL=$(echo "$DISK_INFO" | awk '{print $3}')

            echo ""
            {{ includeTemplate "log_info" "System Information:" }}
            {{ includeTemplate "log_info" "  RAM: $MEM_SIZE_HUMAN" }}
            {{ includeTemplate "log_info" "  Boot drive: $DISK_TOTAL total, $DISK_USED used, $DISK_AVAIL available" }}
            echo ""

            {{ includeTemplate "log_step" "Configure swap" }}

            if [[ "${1:-}" != "--force" ]]; then
                if gum confirm "Create $SWAP_SIZE_FULL_HUMAN swapfile with hibernation support?"; then
                    HIBERNATION_ENABLED=true
                    SWAP_ENABLED=true
                    SWAP_SIZE_HUMAN="$SWAP_SIZE_FULL_HUMAN"
                    SWAP_SIZE_KB="${SWAP_SIZE_FULL_KB}k"
                elif gum confirm "Create $SWAP_SIZE_HALF_HUMAN swapfile (swap only, no hibernation)?"; then
                    SWAP_ENABLED=true
                    SWAP_SIZE_HUMAN="$SWAP_SIZE_HALF_HUMAN"
                    SWAP_SIZE_KB="${SWAP_SIZE_HALF_KB}k"
                else
                    {{ includeTemplate "log_skip" "Swap creation declined by user" }}
                fi
            else
                HIBERNATION_ENABLED=true
                SWAP_ENABLED=true
                SWAP_SIZE_HUMAN="$SWAP_SIZE_FULL_HUMAN"
                SWAP_SIZE_KB="${SWAP_SIZE_FULL_KB}k"
            fi
        fi

        if [ "$SWAP_ENABLED" = true ]; then
            {{ includeTemplate "log_step" "Create swap subvolume" }}

            if sudo btrfs subvolume show "$SWAP_SUBVOLUME" &>/dev/null; then
                {{ includeTemplate "log_success" "Swap subvolume already exists: $SWAP_SUBVOLUME" }}
            else
                sudo btrfs subvolume create "$SWAP_SUBVOLUME"
                sudo chattr +C "$SWAP_SUBVOLUME"
                {{ includeTemplate "log_success" "Created swap subvolume: $SWAP_SUBVOLUME (CoW disabled)" }}
            fi

            {{ includeTemplate "log_step" "Create swapfile" }}

            if [ "$SWAP_EXISTS" = true ]; then
                {{ includeTemplate "log_success" "Using existing swapfile: $SWAP_FILE" }}
            else
                sudo btrfs filesystem mkswapfile -s "$SWAP_SIZE_KB" "$SWAP_FILE"
                {{ includeTemplate "log_success" "Created swapfile: $SWAP_FILE ($SWAP_SIZE_HUMAN)" }}
            fi

            {{ includeTemplate "log_step" "Add swapfile to fstab" }}

            if grep -Fq "$SWAP_FILE" /etc/fstab; then
                {{ includeTemplate "log_success" "Swapfile already in /etc/fstab" }}
            else
                sudo cp -a /etc/fstab "/etc/fstab.$(date +%Y%m%d%H%M%S).back"
                if [ "$HIBERNATION_ENABLED" = true ]; then
                    printf "\n# Btrfs swapfile for system hibernation\n%s none swap defaults,pri=0 0 0\n" "$SWAP_FILE" | sudo tee -a /etc/fstab >/dev/null
                else
                    printf "\n# Btrfs swapfile\n%s none swap defaults,pri=0 0 0\n" "$SWAP_FILE" | sudo tee -a /etc/fstab >/dev/null
                fi
                {{ includeTemplate "log_success" "Added swapfile to /etc/fstab" }}
            fi

            {{ includeTemplate "log_step" "Enable swap" }}

            if swapon --show | grep -q "$SWAP_FILE"; then
                {{ includeTemplate "log_success" "Swap already enabled" }}
            else
                sudo swapon -p 0 "$SWAP_FILE"
                {{ includeTemplate "log_success" "Enabled swap on $SWAP_FILE" }}
            fi
        fi

        if [ "$HIBERNATION_ENABLED" = true ]; then
            {{ includeTemplate "log_step" "Add resume hook to mkinitcpio" }}

            sudo mkdir -p /etc/mkinitcpio.conf.d
            echo "HOOKS+=(resume)" | sudo tee "$RESUME_CONF" >/dev/null
            {{ includeTemplate "log_success" "Created $RESUME_CONF" }}

            {{ includeTemplate "log_step" "Configure kernel cmdline for resume" }}

            RESUME_OFFSET=$(sudo btrfs inspect-internal map-swapfile -r "$SWAP_FILE")
            RESUME_UUID=$(findmnt -n -o UUID /)

            CMDLINE_FILE="/etc/kernel/cmdline"
            RESUME_PARAMS="resume=UUID=$RESUME_UUID resume_offset=$RESUME_OFFSET"

            if [ -f "$CMDLINE_FILE" ]; then
                if grep -q "resume=UUID=$RESUME_UUID" "$CMDLINE_FILE"; then
                    {{ includeTemplate "log_success" "Resume parameters already in $CMDLINE_FILE" }}
                else
                    if [ ! -f "${CMDLINE_FILE}.backup" ]; then
                        sudo cp "$CMDLINE_FILE" "${CMDLINE_FILE}.backup"
                        {{ includeTemplate "log_info" "Created backup: ${CMDLINE_FILE}.backup" }}
                    fi

                    CURRENT_CMDLINE=$(cat "$CMDLINE_FILE")
                    echo "$CURRENT_CMDLINE $RESUME_PARAMS" | sudo tee "$CMDLINE_FILE" >/dev/null
                    {{ includeTemplate "log_success" "Added resume parameters to $CMDLINE_FILE" }}
                    HIBERNATION_CHANGED=true
                fi
            else
                {{ includeTemplate "log_info" "Creating $CMDLINE_FILE from /proc/cmdline" }}

                EXISTING_PARAMS=$(cat /proc/cmdline | tr ' ' '\n' | grep -v -E '^(BOOT_IMAGE=|initrd=)' | tr '\n' ' ' | sed 's/ $//')

                echo "$EXISTING_PARAMS $RESUME_PARAMS" | sudo tee "$CMDLINE_FILE" >/dev/null
                {{ includeTemplate "log_success" "Created $CMDLINE_FILE with resume parameters" }}
                HIBERNATION_CHANGED=true
            fi

            HIBERNATION_CHANGED=true
            {{ includeTemplate "log_success" "Hibernation configuration complete" }}
        elif [ "$SWAP_ENABLED" = true ]; then
            {{ includeTemplate "log_success" "Swap configuration complete (hibernation disabled)" }}
        fi
    fi
fi
fi  # End HIBERNATION_UNSUPPORTED check

# ============================================================================
# SECTION 5: SINGLE INITRAMFS REBUILD
# ============================================================================

echo ""
{{ includeTemplate "log_info" "════════════════════════════════════════════════════════════════" }}
{{ includeTemplate "log_info" "  SECTION 5: Initramfs Rebuild (Consolidate all changes)" }}
{{ includeTemplate "log_info" "════════════════════════════════════════════════════════════════" }}
echo ""

{{ includeTemplate "log_step" "Checking if initramfs rebuild is needed..." }}

# Check if any changes were made that require rebuild
REBUILD_NEEDED=false

if [ "$PLYMOUTH_INSTALLED" = true ]; then
    if [ "${PLYMOUTH_HOOK_CHANGED:-false}" = true ] || [ "${PLYMOUTH_CMDLINE_CHANGED:-false}" = true ] || [ "${PLYMOUTH_THEME_CHANGED:-false}" = true ]; then
        {{ includeTemplate "log_info" "Plymouth configuration changed - rebuild required" }}
        REBUILD_NEEDED=true
    fi
fi

if [ "${HIBERNATION_CHANGED:-false}" = true ]; then
    {{ includeTemplate "log_info" "Hibernation configuration changed - rebuild required" }}
    REBUILD_NEEDED=true
fi

if [ "$REBUILD_NEEDED" = true ]; then
    {{ includeTemplate "log_step" "Rebuilding initramfs and UKI images (consolidated rebuild)..." }}

    {{ includeTemplate "log_info" "This rebuilds ALL kernels with ALL changes (GPU + Plymouth + Hibernation)" }}

    # Rebuild all kernels (mkinitcpio includes NVIDIA modules if they're installed)
    # DKMS modules were built automatically by pacman hooks during package installation
    sudo mkinitcpio -P

    {{ includeTemplate "log_success" "Initramfs and UKI images rebuilt successfully" }}
else
    {{ includeTemplate "log_skip" "No changes detected - skipping initramfs rebuild" }}
fi

# ============================================================================
# FINAL SUMMARY
# ============================================================================

echo ""
{{ includeTemplate "log_info" "════════════════════════════════════════════════════════════════" }}
{{ includeTemplate "log_info" "  Boot System Configuration Complete" }}
{{ includeTemplate "log_info" "════════════════════════════════════════════════════════════════" }}
echo ""

# GPU Summary
if [ "$NVIDIA_DETECTED" = true ]; then
    {{ includeTemplate "log_info" "GPU Configuration:" }}
    {{ includeTemplate "log_info" "  ✓ NVIDIA GPU detected and configured" }}
    {{ includeTemplate "log_info" "  ✓ DKMS modules verified for $KERNELS_BUILT_COUNT kernel(s): $ALL_BUILT" }}
    {{ includeTemplate "log_info" "  ✓ Kernel parameters set via modprobe.d (nvidia-utils)" }}
    {{ includeTemplate "log_info" "  ✓ Power management services enabled (suspend/resume/hibernate)" }}
    echo ""
fi

# Plymouth Summary
if [ "$PLYMOUTH_INSTALLED" = true ]; then
    {{ includeTemplate "log_info" "Plymouth Configuration:" }}
    {{ includeTemplate "log_info" "  ✓ Theme: {{ .globals.plymouth.theme }}" }}
    {{ includeTemplate "log_info" "  ✓ Kernel parameters: splash quiet" }}
    if [ "${USES_ENCRYPTION:-false}" = true ]; then
        {{ includeTemplate "log_info" "  ✓ Hooks: plymouth (before encrypt hook)" }}
    else
        {{ includeTemplate "log_info" "  ✓ Hooks: plymouth (before filesystems hook)" }}
    fi
    echo ""
fi

# SDDM Summary
if [ "$SDDM_INSTALLED" = true ]; then
    {{ includeTemplate "log_info" "SDDM Configuration:" }}
    {{ includeTemplate "log_info" "  ✓ Theme: {{ .globals.sddm.theme }}" }}
    {{ includeTemplate "log_info" "  ✓ Display server: {{ .globals.sddm.display_server }}" }}
    {{ includeTemplate "log_info" "  ✓ Hyprland session available" }}
    echo ""
fi

# Hibernation Summary
if [ "${HIBERNATION_ENABLED:-false}" = true ]; then
    {{ includeTemplate "log_info" "Hibernation Configuration:" }}
    {{ includeTemplate "log_info" "  ✓ Swap subvolume: /swap (CoW disabled)" }}
    {{ includeTemplate "log_info" "  ✓ Swapfile: $SWAP_SIZE_HUMAN" }}
    {{ includeTemplate "log_info" "  ✓ Resume hook: /etc/mkinitcpio.conf.d/resume.conf" }}
    {{ includeTemplate "log_info" "  ✓ Resume params: resume=UUID=... resume_offset=..." }}
    echo ""
elif [ "${SWAP_ENABLED:-false}" = true ]; then
    {{ includeTemplate "log_info" "Swap Configuration:" }}
    {{ includeTemplate "log_info" "  ✓ Swap subvolume: /swap (CoW disabled)" }}
    {{ includeTemplate "log_info" "  ✓ Swapfile: $SWAP_SIZE_HUMAN" }}
    echo ""
fi

{{ includeTemplate "log_warning" "⚠️  REBOOT REQUIRED for all changes to take effect" }}
echo ""
{{ includeTemplate "log_info" "Boot sequence after reboot:" }}
if [ "$PLYMOUTH_INSTALLED" = true ] && [ "$SDDM_INSTALLED" = true ]; then
    if [ "${USES_ENCRYPTION:-false}" = true ]; then
        {{ includeTemplate "log_info" "  Firmware → Plymouth (LUKS password) → [Brief TTY flash] → SDDM → Hyprland" }}
    else
        {{ includeTemplate "log_info" "  Firmware → Plymouth (boot splash) → [Brief TTY flash] → SDDM → Hyprland" }}
    fi
elif [ "$SDDM_INSTALLED" = true ]; then
    {{ includeTemplate "log_info" "  Firmware → SDDM → Hyprland" }}
else
    {{ includeTemplate "log_info" "  Firmware → TTY/DM → Session" }}
fi
echo ""
{{ includeTemplate "log_info" "════════════════════════════════════════════════════════════════" }}
echo ""

{{ includeTemplate "log_complete" "Complete boot system configuration finished - REBOOT REQUIRED" }}
