#!/bin/sh

# Script: run_onchange_before_update_arch_packages.sh.tmpl
# Purpose: Orchestrator for Arch Linux package updates based on destination configuration
# Requirements: Arch Linux
# Supported Distributions: Arch Linux, EndeavourOS

{{- template "chezmoi_logger_setup" . }}

{{ if eq .osId "linux-arch" }}
    {{- $destinationConfig := index .destinations .destination }}

# Generate hash for chezmoi run_onchange detection
# Hash: {{ include ".chezmoidata/packages.yaml" | sha256sum }}{{ range $name, $config := .packages.install.arch.packages }}{{ range $config.list }}{{ . }}{{ end }}{{ end }}

    log_step "Preparing environment for {{ .destination }} destination package updates"
    
    # Export all necessary environment variables
    export CHEZMOI_OS_ID="{{ .osId }}"
    export CHEZMOI_DESTINATION="{{ .destination }}"
    export CHEZMOI_SOURCE_DIR="{{ .chezmoi.sourceDir }}"
    export CHEZMOI_FIRSTNAME="{{ .firstname }}"
    export CHEZMOI_FULLNAME="{{ .fullname }}"
    export CHEZMOI_WORK_EMAIL="{{ .workEmail }}"
    export CHEZMOI_PERSONAL_EMAIL="{{ .personalEmail }}"
    export CHEZMOI_PRIVATE_SERVER="{{ .privateServer }}"
    export CHEZMOI_PACKAGES="{{ join "," $destinationConfig.packages }}"
    export CHEZMOI_LOG_LEVEL="{{ .logging.level }}"
    export CHEZMOI_DRY_RUN="${CHEZMOI_DRY_RUN:-false}"
    export CHEZMOI_VERBOSE="${CHEZMOI_VERBOSE:-false}"
    
    # Determine script path (generic update script for all destinations)
    SCRIPT_PATH="${CHEZMOI_SOURCE_DIR}/.chezmoiscripts/.lib/packages/update-packages-arch.sh"
    
    log_info "Executing: $(basename "$SCRIPT_PATH")"
    
    # Execute with error handling
    if [ -x "$SCRIPT_PATH" ]; then
        if ! "$SCRIPT_PATH"; then
            handle_error "Package update failed: $(basename "$SCRIPT_PATH")" $?
        fi
    else
        log_error "Script not found or not executable: $SCRIPT_PATH"
        exit 1
    fi
    
    log_success "Package update completed successfully"
    
{{ else }}
    log_error "Unsupported OS: {{ .osId }}"
    log_error "This script requires: linux-arch"
    exit 1
{{ end }}
