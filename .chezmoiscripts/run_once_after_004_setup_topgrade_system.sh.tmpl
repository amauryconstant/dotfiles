#!/usr/bin/env sh

# Script: run_once_after_004_setup_topgrade_system.sh.tmpl
# Purpose: Complete topgrade system setup - sudoers config and service installation
# Requirements: Arch Linux, systemd, topgrade, topgrade-maintenance user

{{ includeTemplate "log_start" "Setting up topgrade system service with sudo configuration..." }}

set -euo pipefail

# ============================================================================
# PREREQUISITES CHECK
# ============================================================================

# Check if topgrade is installed
if ! command -v topgrade >/dev/null 2>&1; then
    {{ includeTemplate "log_error" "topgrade is not installed. Please install it first." }}
    exit 1
fi

# Check if maintenance user exists
if ! id topgrade-maintenance >/dev/null 2>&1; then
    {{ includeTemplate "log_error" "Maintenance user 'topgrade-maintenance' does not exist" }}
    {{ includeTemplate "log_error" "Please ensure run_once_before_008_create_maintenance_user.sh.tmpl ran successfully" }}
    exit 1
fi

# ============================================================================
# SUDOERS CONFIGURATION
# ============================================================================

{{ includeTemplate "log_step" "Configuring passwordless sudo for topgrade maintenance..." }}

# Configuration
SUDOERS_FILE="/etc/sudoers.d/topgrade-maintenance"
SUDOERS_TEMP=$(mktemp)

# Cleanup temporary file on exit
cleanup() {
    rm -f "$SUDOERS_TEMP"
}
trap cleanup EXIT

{{ includeTemplate "log_step" "Creating sudoers configuration..." }}

# Create sudoers configuration
cat > "$SUDOERS_TEMP" << 'SUDOERS_EOF'
# Topgrade Maintenance - Passwordless sudo for system maintenance
# Purpose: Allow automated topgrade service to perform package maintenance
# User: topgrade-maintenance (dedicated system maintenance user)
# Generated by chezmoi on {{ now | date "2006-01-02" }}

# Allow all pacman operations (updates, installations, removals)
topgrade-maintenance ALL=(ALL) NOPASSWD: /usr/bin/pacman

# Allow yay for AUR operations
topgrade-maintenance ALL=(ALL) NOPASSWD: /usr/bin/yay

# Allow snap operations
topgrade-maintenance ALL=(ALL) NOPASSWD: /usr/bin/snap
SUDOERS_EOF

{{ includeTemplate "log_step" "Validating sudoers syntax..." }}

# Validate syntax before installing
if ! visudo -c -f "$SUDOERS_TEMP" >/dev/null 2>&1; then
    {{ includeTemplate "log_error" "Invalid sudoers syntax detected" }}
    exit 1
fi

{{ includeTemplate "log_success" "Sudoers syntax validation passed" }}

{{ includeTemplate "log_step" "Installing sudoers configuration..." }}

# Install with correct permissions (0440 - read-only)
sudo install -m 0440 "$SUDOERS_TEMP" "$SUDOERS_FILE"

{{ includeTemplate "log_step" "Verifying complete sudoers system..." }}

# Final verification of entire sudoers configuration
if ! sudo visudo -c >/dev/null 2>&1; then
    {{ includeTemplate "log_error" "Sudoers system validation failed, removing configuration" }}
    sudo rm -f "$SUDOERS_FILE"
    exit 1
fi

{{ includeTemplate "log_success" "Sudoers configuration completed successfully" }}

# ============================================================================
# TOPGRADE SERVICE INSTALLATION
# ============================================================================

{{ includeTemplate "log_step" "Deploying system configuration to /etc/topgrade/..." }}
sudo mkdir -p /etc/topgrade
chezmoi execute-template < "{{ .chezmoi.sourceDir }}/.data/topgrade-system.toml.tmpl" | sudo tee /etc/topgrade/topgrade.toml > /dev/null
sudo chown topgrade-maintenance:topgrade-maintenance /etc/topgrade/topgrade.toml
sudo chmod 644 /etc/topgrade/topgrade.toml
{{ includeTemplate "log_success" "System configuration deployed" }}

# Process and install systemd service files to system location
{{ includeTemplate "log_step" "Installing systemd service files..." }}
chezmoi execute-template < "{{ .chezmoi.sourceDir }}/.data/topgrade.service.tmpl" | sudo tee /etc/systemd/system/topgrade.service > /dev/null
chezmoi execute-template < "{{ .chezmoi.sourceDir }}/.data/topgrade.timer.tmpl" | sudo tee /etc/systemd/system/topgrade.timer > /dev/null
{{ includeTemplate "log_success" "Service files installed" }}

# Reload systemd daemon to pick up new service files
{{ includeTemplate "log_step" "Reloading systemd daemon..." }}
sudo systemctl daemon-reload

# Enable the topgrade timer
{{ includeTemplate "log_step" "Enabling topgrade timer..." }}
if sudo systemctl enable topgrade.timer; then
    {{ includeTemplate "log_success" "Topgrade timer enabled successfully" }}
else
    {{ includeTemplate "log_error" "Failed to enable topgrade timer" }}
    exit 1
fi

# Start the topgrade timer
{{ includeTemplate "log_step" "Starting topgrade timer..." }}
if sudo systemctl start topgrade.timer; then
    {{ includeTemplate "log_success" "Topgrade timer started successfully" }}
else
    {{ includeTemplate "log_error" "Failed to start topgrade timer" }}
    exit 1
fi

# ============================================================================
# STATUS DISPLAY
# ============================================================================

# Show timer status
{{ includeTemplate "log_info" "Topgrade timer status:" }}
systemctl status topgrade.timer --no-pager -l

# Show next scheduled run
{{ includeTemplate "log_info" "Next scheduled topgrade run:" }}
systemctl list-timers topgrade.timer --no-pager

{{ includeTemplate "log_complete" "Topgrade system service setup completed successfully" }}
{{ includeTemplate "log_info" "  - Sudoers configured: passwordless sudo for maintenance commands" }}
{{ includeTemplate "log_info" "  - Service runs as dedicated user: topgrade-maintenance" }}
{{ includeTemplate "log_info" "  - Timer runs monthly on the first Sunday at 10:00 AM" }}
{{ includeTemplate "log_info" "  - Manual execution: sudo systemctl start topgrade.service" }}
{{ includeTemplate "log_info" "  - Check status: systemctl status topgrade.timer" }}
{{ includeTemplate "log_info" "  - View logs: journalctl -u topgrade.service" }}
