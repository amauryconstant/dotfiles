#!/usr/bin/env sh

# Script: run_onchange_after_install_extensions.sh.tmpl
# Purpose: Install VSCode extensions and Firefox policies for Arch Linux work environment
# Requirements: Arch Linux, code (VSCode), firefox

# Hash: {{ .extensions.code | toJson | sha256sum }}
# Hash: {{ include ".data/firefox-policies.json" | sha256sum }}

{{ includeTemplate "log_start" "Installing extensions for Arch Linux..." }}

# Check if VSCode is installed
if ! command -v code >/dev/null 2>&1; then
    {{ includeTemplate "log_skip" "VSCode not found, skipping extension installation" }}
    exit 0
fi

{{ includeTemplate "log_step" "Installing VSCode extensions..." }}

# Install each extension (work destination behavior: always install extensions)
FAILED_EXTENSIONS=""
{{- range .extensions.code }}
if ! code --install-extension {{ . }} >/dev/null 2>&1; then
    FAILED_EXTENSIONS="${FAILED_EXTENSIONS}{{ . }}, "
fi
{{- end }}

if [ -n "$FAILED_EXTENSIONS" ]; then
    {{ includeTemplate "log_warning" "Some extensions failed: $FAILED_EXTENSIONS" }}
    {{ includeTemplate "log_warning" "Continuing with partial installation..." }}
fi

{{ includeTemplate "log_success" "VSCode extension installation finished" }}

# Install Firefox policies
if [ -f "{{ .chezmoi.sourceDir }}/.data/firefox-policies.json" ]; then
    {{ includeTemplate "log_step" "Installing Firefox policies..." }}
    sudo mkdir -p /usr/lib/firefox/distribution
    sudo cp "{{ .chezmoi.sourceDir }}/.data/firefox-policies.json" /usr/lib/firefox/distribution/policies.json
    sudo chmod 644 /usr/lib/firefox/distribution/policies.json
    {{ includeTemplate "log_success" "Firefox policies installed" }}
fi

{{ includeTemplate "log_complete" "Extension installation completed" }}
