#!/bin/sh

# Script: run_onchange_after_install_extensions.sh.tmpl
# Purpose: Install VSCode extensions and configure Firefox policies
# Requirements: Linux, destination with extensions enabled and VSCode installed
# Hash: {{ include ".data/firefox-policies.json" | sha256sum }}

{{ if eq .chezmoi.os "linux" }}
    {{- $destinationConfig := index .destinations .destination -}}
    
    # Check if extensions are enabled for this destination AND VSCode is available
    {{ if $destinationConfig.extensions }}
        if command -v code >/dev/null 2>&1; then
            echo "Installing VSCode extensions for destination: {{ .destination }}"
            
            # Install code extensions
            {{ range .extensions.code -}}
                echo "Installing extension: {{.}}"
                code --force --install-extension {{.}}
            {{ end -}}
            
            echo "✓ VSCode extensions installation completed for {{ .destination }} destination"
        else
            echo "VSCode not found, skipping extension installation"
            echo "Extensions are configured for {{ .destination }} but VSCode is not installed"
        fi
    {{ else }}
        echo "Skipping VSCode extensions installation for destination: {{ .destination }}"
        echo "VSCode extensions are not configured for this destination type"
    {{ end }}

    # Firefox policies (applies to all destinations that have Firefox)
    if command -v firefox >/dev/null 2>&1; then
        # firefox-policies.json hash: {{ include ".data/firefox-policies.json" | sha256sum }}
        echo "Copying Firefox policies"
        sudo mkdir -p /etc/firefox/policies
        sudo cp -v {{ .chezmoi.config.workingTree }}/.data/firefox-policies.json /etc/firefox/policies/policies.json
        echo "✓ Firefox policies configured"
    else
        echo "Firefox not found, skipping policies configuration"
    fi

{{ else }}
    echo "ERROR: This script is only supported on Linux systems"
    echo "Required: OS 'linux'"
    echo "Detected: '{{ .chezmoi.os }}'"
    echo "Script: $(basename "$0")"
    exit 1
{{ end }}
