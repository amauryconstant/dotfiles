#!/usr/bin/env bash

# Script: run_once_before_001_validate_hyprland_session.sh.tmpl
# Purpose: Validate Hyprland dependencies BEFORE installation to prevent session crashes
# Requirements: Arch Linux, run after package manager setup

{{ includeTemplate "log_start" "Validating Hyprland session requirements..." }}

set -euo pipefail

# Track if any checks fail
VALIDATION_FAILED=false

# ============================================================================
# NOTE: Package validation moved to run_once_after_008
# ============================================================================
#
# This script focuses on pre-installation validation:
# - NVIDIA driver migration detection (must happen BEFORE package sync)
# - Graphics driver compatibility checks
#
# Package existence validation happens in run_once_after_008 (after packages installed)

# ============================================================================
# CHECK 1: NVIDIA GPU DETECTION
# ============================================================================

{{ includeTemplate "log_step" "Checking for NVIDIA GPU..." }}

# Check for NVIDIA drivers (common crash source)
if lspci | grep -i nvidia >/dev/null 2>&1; then
{{- $gpuName := .nvidiaGpuDetected | default "unknown" }}
    {{ includeTemplate "log_info" (printf "NVIDIA GPU detected: %s" $gpuName) }}
    {{ includeTemplate "log_info" (printf "Driver type selected: %s" .nvidiaDriverType) }}

    # Check for nouveau (archinstall default on fresh installations)
    if lspci -k | grep -A 3 -i "VGA\|3D" | grep -qi "nouveau"; then
        {{ includeTemplate "log_warning" "Nouveau drivers currently active (archinstall default)" }}
        {{ includeTemplate "log_info" "Proprietary NVIDIA drivers will be installed during package sync" }}
        {{ includeTemplate "log_info" "Reboot after package installation to load proprietary drivers" }}
    else
        {{ includeTemplate "log_info" "Proprietary NVIDIA drivers active" }}

        # Verify DKMS modules are loaded (non-critical check)
        if ! modinfo nvidia >/dev/null 2>&1; then
            {{ includeTemplate "log_warning" "NVIDIA kernel module not loaded" }}
            {{ includeTemplate "log_info" "May need reboot or module build with: sudo dkms autoinstall" }}
        fi
    fi

    # Check for driver migration (if NVIDIA GPU detected)
    {{ includeTemplate "log_step" "Checking for driver migration..." }}
    CURRENT_DRIVER=""
    if pacman -Q nvidia-open >/dev/null 2>&1; then
        CURRENT_DRIVER="modern"
    elif pacman -Q nvidia-580xx-dkms >/dev/null 2>&1; then
        CURRENT_DRIVER="legacy"
    fi

    TARGET_DRIVER="{{ .nvidiaDriverType }}"

    if [ -n "$CURRENT_DRIVER" ] && [ "$CURRENT_DRIVER" != "$TARGET_DRIVER" ]; then
        echo ""
        echo "════════════════════════════════════════════════════════════════"
        echo "  ⚠️  NVIDIA DRIVER MIGRATION DETECTED"
        echo "════════════════════════════════════════════════════════════════"
        echo ""
        echo "  Current driver: $CURRENT_DRIVER"
        echo "  Target driver:  $TARGET_DRIVER"
        echo ""
        echo "  Detected GPU: {{ .nvidiaGpuDetected | default "unknown" }}"
        echo ""
        echo "  This migration will:"
        if [ "$CURRENT_DRIVER" = "modern" ]; then
            echo "    1. Remove nvidia-open, nvidia-open-lts, nvidia-utils, lib32-nvidia-utils"
            echo "    2. Install nvidia-580xx-dkms, nvidia-580xx-utils, lib32-nvidia-580xx-utils"
        else
            echo "    1. Remove nvidia-580xx-dkms, nvidia-580xx-utils, lib32-nvidia-580xx-utils"
            echo "    2. Install nvidia-open, nvidia-open-lts, nvidia-utils, lib32-nvidia-utils"
        fi
        echo "    3. Require reboot to activate new drivers"
        echo ""
        echo "  Safety recommendations:"
        echo "    • Ensure you have alternate access (SSH/TTY)"
        echo "    • Close all GPU-intensive applications"
        echo "    • Save all work before proceeding"
        echo ""
        echo "  NOTE: Will auto-proceed with migration after 60 seconds if no response"
        echo ""
        echo "════════════════════════════════════════════════════════════════"
        echo ""

        # Timeout after 60 seconds (prevents unattended installation hang)
        # Default to 'N' (safe option) on timeout
        if read -t 60 -p "  Continue with driver migration? [y/N] " -n 1 -r; then
            echo ""
            if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                {{ includeTemplate "log_error" "Driver migration cancelled by user" }}
                exit 1
            fi
        else
            echo ""
            {{ includeTemplate "log_warning" "⏱️  Timeout reached - defaulting to 'No' (safe option)" }}
            {{ includeTemplate "log_error" "Driver migration cancelled (timeout)" }}
            {{ includeTemplate "log_info" "To force migration: export NVIDIA_DRIVER_OVERRIDE=$TARGET_DRIVER && chezmoi apply" }}
            exit 1
        fi

        {{ includeTemplate "log_warning" "Proceeding with driver migration..." }}
    else
        {{ includeTemplate "log_success" "No driver migration needed" }}
    fi
fi

# Check for Intel GPU
if lspci | grep -i "intel.*graphics" >/dev/null 2>&1; then
    {{ includeTemplate "log_info" "Intel GPU detected (uses mesa - built-in)" }}
fi

# ============================================================================
# CHECK 3: WAYLAND SESSION REQUIREMENTS
# ============================================================================

{{ includeTemplate "log_step" "Verifying Wayland environment setup..." }}

# Check for seat management (required for Wayland)
if ! command -v seatd >/dev/null 2>&1 && ! systemctl is-active --quiet systemd-logind; then
    {{ includeTemplate "log_warning" "Neither seatd nor systemd-logind active" }}
    {{ includeTemplate "log_info" "Wayland needs seat management for input devices" }}
    {{ includeTemplate "log_info" "Systemd-logind should be active by default" }}
fi

# Check XDG_RUNTIME_DIR (critical for Wayland)
if [ -z "${XDG_RUNTIME_DIR:-}" ]; then
    {{ includeTemplate "log_error" "XDG_RUNTIME_DIR not set" }}
    {{ includeTemplate "log_info" "Required for Wayland socket creation" }}
    {{ includeTemplate "log_info" "Should be set by display manager (SDDM)" }}
    VALIDATION_FAILED=true
else
    {{ includeTemplate "log_success" "XDG_RUNTIME_DIR configured: $XDG_RUNTIME_DIR" }}
fi

# ============================================================================
# NOTE: Package validation deferred to run_once_after_008
# ============================================================================
# The following checks moved to post-install validation:
# - SDDM installation and configuration
# - Hyprland package and session file
# - Terminal emulator availability
#
# These checks require packages to be installed first

# ============================================================================
# CHECK 6: CRITICAL SYSTEM SERVICES
# ============================================================================

{{ includeTemplate "log_step" "Verifying critical system services..." }}

# D-Bus (critical for desktop apps)
if ! systemctl --user is-active --quiet dbus.service 2>/dev/null; then
    {{ includeTemplate "log_warning" "User D-Bus session not active" }}
    {{ includeTemplate "log_info" "Required for application communication" }}
    {{ includeTemplate "log_info" "Should start automatically with graphical session" }}
fi

# PipeWire (audio - not critical but commonly needed)
if command -v pipewire >/dev/null 2>&1; then
    if ! systemctl --user is-active --quiet pipewire.service 2>/dev/null; then
        {{ includeTemplate "log_info" "PipeWire installed but not running" }}
        {{ includeTemplate "log_info" "Audio may not work until service starts" }}
    fi
fi

# ============================================================================
# CHECK 7: CONFIG FILE SYNTAX VALIDATION
# ============================================================================

{{ includeTemplate "log_step" "Pre-validating Hyprland config syntax..." }}

# Check if hyprctl is available (for syntax validation)
if command -v hyprctl >/dev/null 2>&1; then
    {{ includeTemplate "log_info" "Hyprland installed - will validate config after chezmoi apply" }}
else
    {{ includeTemplate "log_info" "Hyprland not running - skipping syntax validation" }}
fi

# ============================================================================
# CHECK 8: THEME SYSTEM DEPENDENCIES
# ============================================================================

{{ includeTemplate "log_step" "Verifying theme system requirements..." }}

# Theme system needs these for proper operation
THEME_DEPS="jq"
THEME_MISSING=""

for dep in $THEME_DEPS; do
    if ! command -v "$dep" >/dev/null 2>&1; then
        {{ includeTemplate "log_warning" "Missing theme dependency: $dep" }}
        THEME_MISSING="$THEME_MISSING $dep"
    fi
done

if [ -z "$THEME_MISSING" ]; then
    {{ includeTemplate "log_success" "Theme system dependencies available" }}
else
    {{ includeTemplate "log_step" "Attempting to install theme dependencies..." }}
    if sudo pacman -S --needed --noconfirm $THEME_DEPS 2>&1 | grep -v "warning: "; then
        {{ includeTemplate "log_success" "Theme dependencies installed successfully" }}
    else
        {{ includeTemplate "log_warning" "Failed to install theme dependencies" }}
        {{ includeTemplate "log_info" "Theme switching may not work until manually installed: sudo pacman -S $THEME_DEPS" }}
    fi
fi

# ============================================================================
# CHECK 9: FONT DEPENDENCIES
# ============================================================================

{{ includeTemplate "log_step" "Verifying font packages..." }}

# Critical fonts for UI rendering
FONT_PACKAGES="noto-fonts noto-fonts-emoji"
FONT_MISSING=""

for font in $FONT_PACKAGES; do
    if ! pacman -Q "$font" >/dev/null 2>&1; then
        {{ includeTemplate "log_warning" "Missing font package: $font" }}
        FONT_MISSING="$FONT_MISSING $font"
    fi
done

if [ -z "$FONT_MISSING" ]; then
    {{ includeTemplate "log_success" "Critical fonts installed" }}
else
    {{ includeTemplate "log_step" "Attempting to install missing fonts..." }}
    if sudo pacman -S --needed --noconfirm $FONT_MISSING 2>&1 | grep -v "warning: "; then
        {{ includeTemplate "log_success" "Fonts installed successfully" }}
    else
        {{ includeTemplate "log_warning" "Failed to install fonts" }}
        {{ includeTemplate "log_info" "UI may have rendering issues until manually installed: sudo pacman -S $FONT_MISSING" }}
    fi
fi

# ============================================================================
# CHECK 10: GNOME KEYRING (WiFi credentials)
# ============================================================================

{{ includeTemplate "log_step" "Verifying credential storage..." }}

if ! pacman -Q gnome-keyring >/dev/null 2>&1; then
    {{ includeTemplate "log_warning" "gnome-keyring not installed" }}
    {{ includeTemplate "log_step" "Attempting to install gnome-keyring..." }}
    if sudo pacman -S --needed --noconfirm gnome-keyring 2>&1 | grep -v "warning: "; then
        {{ includeTemplate "log_success" "gnome-keyring installed successfully" }}
        {{ includeTemplate "log_info" "WiFi password storage now available" }}
    else
        {{ includeTemplate "log_warning" "Failed to install gnome-keyring" }}
        {{ includeTemplate "log_info" "WiFi password storage unavailable until manually installed: sudo pacman -S gnome-keyring" }}
    fi
else
    {{ includeTemplate "log_success" "gnome-keyring installed" }}
fi

# ============================================================================
# VALIDATION SUMMARY
# ============================================================================

echo ""
echo "════════════════════════════════════════════════════════════════"
echo "  Hyprland Session Validation Summary"
echo "════════════════════════════════════════════════════════════════"
echo ""

if [ "$VALIDATION_FAILED" = true ]; then
    {{ includeTemplate "log_error" "❌ VALIDATION FAILED - Session crashes likely" }}
    echo ""
    echo "  Critical issues detected. Hyprland session will likely fail."
    echo "  Review error messages above and fix problems before proceeding."
    echo ""
    echo "  Common fixes:"
    echo "    1. Ensure desktop_hyprland module enabled in packages.yaml"
    echo "    2. Run package sync: package-manager sync"
    echo "    3. Reboot after driver installation"
    echo "    4. Enable SDDM: sudo systemctl enable sddm"
    echo ""
    echo "  After fixing issues, run: chezmoi apply"
    echo ""
    echo "════════════════════════════════════════════════════════════════"
    echo ""
    exit 1
else
    {{ includeTemplate "log_success" "✅ ALL CRITICAL CHECKS PASSED" }}
    echo ""
    echo "  Hyprland session requirements verified:"
    echo "    ✓ Core packages installed (hyprland, waybar, etc.)"
    echo "    ✓ Graphics drivers available"
    echo "    ✓ Wayland environment configured"
    echo "    ✓ Display manager ready (SDDM)"
    echo "    ✓ Terminal emulator available"
    echo "    ✓ Critical services present"
    echo ""

    if [ -n "${THEME_MISSING:-}" ] || [ -n "${FONT_MISSING:-}" ]; then
        echo "  ⚠ Non-critical warnings detected (see above)"
        echo "    Session will work but some features may be limited"
        echo ""
    fi

    echo "  Safe to proceed with Hyprland session."
    echo ""
    echo "════════════════════════════════════════════════════════════════"
    echo ""
fi

{{ includeTemplate "log_complete" "Hyprland session validation completed" }}
