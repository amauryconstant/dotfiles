#!/usr/bin/env bash

# Script: run_once_after_006_configure_boot_system.sh.tmpl
# Purpose: Consolidated boot system configuration (GPU + Plymouth + SDDM)
# Requirements: Arch Linux, Plymouth, SDDM, Hyprland
# Execution: Runs AFTER file application to configure complete boot stack
#
# This script consolidates three previously separate scripts:
# - GPU driver configuration (NVIDIA DKMS)
# - Plymouth graphical boot splash
# - SDDM display manager
#
# Benefits of consolidation:
# - Single mkinitcpio -P rebuild (instead of 3×)
# - Atomic boot configuration changes
# - Consistent backup/rollback strategy

{{ includeTemplate "log_start" "Configure complete boot system (GPU + Plymouth + SDDM)" }}

# Set strict error handling
set -euo pipefail

# Add error trap for cleanup guidance
trap 'echo "❌ [ERROR] Boot system configuration failed - check logs above" >&2; echo "ℹ️  [INFO] To rollback: sudo cp /etc/kernel/cmdline.backup /etc/kernel/cmdline && sudo mkinitcpio -P"; exit 1' ERR

# ============================================================================
# SECTION 1: GPU DRIVER CONFIGURATION (NVIDIA)
# ============================================================================

{{ includeTemplate "log_info" "" }}
{{ includeTemplate "log_info" "════════════════════════════════════════════════════════════════" }}
{{ includeTemplate "log_info" "  SECTION 1: GPU Driver Configuration" }}
{{ includeTemplate "log_info" "════════════════════════════════════════════════════════════════" }}
{{ includeTemplate "log_info" "" }}

# Initialize variables for NVIDIA DKMS information (available in summary)
KERNELS_BUILT_COUNT=0
ALL_BUILT=""

{{ includeTemplate "log_step" "Detect GPU vendor" }}

# Detect GPU using lspci
GPU_VENDOR=$(lspci | grep -i 'vga\|3d\|display' | grep -i nvidia || true)
NVIDIA_DETECTED=false

if [ -z "$GPU_VENDOR" ]; then
    {{ includeTemplate "log_skip" "No NVIDIA GPU detected - skipping NVIDIA configuration" }}
else
    {{ includeTemplate "log_info" "NVIDIA GPU detected: $GPU_VENDOR" }}
    NVIDIA_DETECTED=true

    {{ includeTemplate "log_step" "Configure initramfs NVIDIA modules BEFORE package installation" }}

    # CRITICAL: Configure mkinitcpio BEFORE installing nvidia-open-dkms
    # This ensures DKMS builds modules with the correct configuration from the start

    # Create mkinitcpio configuration directory
    sudo mkdir -p /etc/mkinitcpio.conf.d

    # Check if initramfs configuration already exists and is correct
    NVIDIA_CONF="/etc/mkinitcpio.conf.d/nvidia.conf"
    NVIDIA_CONF_NEEDS_UPDATE=false

    if [ -f "$NVIDIA_CONF" ]; then
        # Check if existing file has correct content (flexible whitespace handling)
        # Must include i915 for hybrid graphics
        # Use sudo to read file (owned by root)
        if sudo grep -Eq "^MODULES=\(i915 nvidia nvidia_modeset nvidia_uvm nvidia_drm\)\s*$" "$NVIDIA_CONF"; then
            {{ includeTemplate "log_success" "Initramfs NVIDIA configuration already correct" }}
        else
            {{ includeTemplate "log_info" "Updating initramfs NVIDIA configuration..." }}
            NVIDIA_CONF_NEEDS_UPDATE=true
        fi
    else
        {{ includeTemplate "log_info" "Creating initramfs NVIDIA configuration..." }}
        NVIDIA_CONF_NEEDS_UPDATE=true
    fi

    # Create/update NVIDIA-specific module configuration if needed
    if [ "$NVIDIA_CONF_NEEDS_UPDATE" = true ]; then
        # CRITICAL: With DKMS, we KEEP 'kms' in HOOKS (early kernel mode setting)
        # CRITICAL: On hybrid graphics (Intel + NVIDIA), load i915 BEFORE nvidia modules
        #           This prevents Electron/Chromium apps from stalling ~1min after boot
        sudo tee "$NVIDIA_CONF" > /dev/null <<'EOF'
# NVIDIA DKMS module configuration
# These modules enable early kernel mode setting (KMS) for NVIDIA GPUs
# IMPORTANT: DO NOT remove 'kms' from HOOKS when using DKMS
# IMPORTANT: i915 loaded first to prevent Electron/Chromium stalling on hybrid graphics
MODULES=(i915 nvidia nvidia_modeset nvidia_uvm nvidia_drm)
EOF
        sudo chmod 644 "$NVIDIA_CONF"
        {{ includeTemplate "log_success" "Created/updated $NVIDIA_CONF" }}
        {{ includeTemplate "log_info" "DKMS will use this configuration during package installation" }}
    fi

    {{ includeTemplate "log_step" "Verify NVIDIA DKMS modules built successfully" }}

    # Check DKMS status
    DKMS_STATUS=$(/usr/bin/dkms status nvidia 2>/dev/null || true)

    if echo "$DKMS_STATUS" | grep -q "installed"; then
        {{ includeTemplate "log_success" "NVIDIA DKMS modules installed" }}
        {{ includeTemplate "log_info" "$DKMS_STATUS" }}
    else
        {{ includeTemplate "log_error" "NVIDIA DKMS modules not built" }}
        {{ includeTemplate "log_info" "Status: $DKMS_STATUS" }}
        {{ includeTemplate "log_info" "" }}
        {{ includeTemplate "log_info" "Manual build: sudo dkms autoinstall" }}
        {{ includeTemplate "log_info" "If GCC errors occur, try: sudo dkms autoinstall -j1" }}
        {{ includeTemplate "log_info" "See CLAUDE.md 'DKMS Troubleshooting' for details" }}
        exit 1
    fi

    {{ includeTemplate "log_step" "Enable NVIDIA power management services" }}

    # Re-enable NVIDIA power management services (removed during package reinstall)
    # These services handle suspend/resume/hibernate for NVIDIA GPUs
    NVIDIA_SERVICES=(
        "nvidia-suspend.service"
        "nvidia-hibernate.service"
        "nvidia-resume.service"
    )

    for service in "${NVIDIA_SERVICES[@]}"; do
        if systemctl list-unit-files "$service" >/dev/null 2>&1; then
            if systemctl is-enabled "$service" >/dev/null 2>&1; then
                {{ includeTemplate "log_success" "$service already enabled" }}
            else
                sudo systemctl enable "$service"
                {{ includeTemplate "log_success" "$service enabled" }}
            fi
        else
            {{ includeTemplate "log_warning" "$service not found" }}
        fi
    done

    {{ includeTemplate "log_success" "GPU driver configuration complete" }}
fi

# ============================================================================
# SECTION 2: PLYMOUTH CONFIGURATION
# ============================================================================

{{ includeTemplate "log_info" "" }}
{{ includeTemplate "log_info" "════════════════════════════════════════════════════════════════" }}
{{ includeTemplate "log_info" "  SECTION 2: Plymouth Graphical Boot Splash" }}
{{ includeTemplate "log_info" "════════════════════════════════════════════════════════════════" }}

{{ includeTemplate "log_step" "Verify Plymouth installation" }}

if ! command -v plymouth >/dev/null 2>&1; then
    {{ includeTemplate "log_skip" "Plymouth not installed - skipping Plymouth configuration" }}
    PLYMOUTH_INSTALLED=false
else
    {{ includeTemplate "log_success" "Plymouth is installed" }}
    PLYMOUTH_INSTALLED=true

    {{ includeTemplate "log_step" "Configure mkinitcpio hooks for Plymouth" }}

    MKINITCPIO_CONF="/etc/mkinitcpio.conf"
    MKINITCPIO_BACKUP="${MKINITCPIO_CONF}.backup"

    # Detect if system uses encryption (encrypt or sd-encrypt hook)
    USES_ENCRYPTION=false
    if grep -Eq "^HOOKS=.*(encrypt|sd-encrypt)" "$MKINITCPIO_CONF"; then
        USES_ENCRYPTION=true
        {{ includeTemplate "log_info" "System uses disk encryption - plymouth will be added before encrypt hook" }}
    else
        {{ includeTemplate "log_info" "System does not use disk encryption - plymouth will be added before filesystems hook" }}
    fi

    # Check if plymouth hook is already configured correctly
    if [ "$USES_ENCRYPTION" = true ]; then
        # For encrypted systems: plymouth must be before encrypt/sd-encrypt
        if grep -Eq "^HOOKS=.*plymouth.*(encrypt|sd-encrypt)" "$MKINITCPIO_CONF"; then
            {{ includeTemplate "log_success" "Plymouth hook already configured before encrypt hook" }}
            PLYMOUTH_HOOK_CHANGED=false
        else
            {{ includeTemplate "log_info" "Adding plymouth hook before encrypt in mkinitcpio.conf..." }}

            # Create backup only if it doesn't already exist
            if [ ! -f "$MKINITCPIO_BACKUP" ]; then
                sudo cp "$MKINITCPIO_CONF" "$MKINITCPIO_BACKUP"
                {{ includeTemplate "log_info" "Created backup: $MKINITCPIO_BACKUP" }}
            fi

            # Insert plymouth before encrypt or sd-encrypt in HOOKS array
            # Handles both: encrypt and sd-encrypt
            sudo sed -i 's/\(HOOKS=([^)]*block\) \(encrypt\|sd-encrypt\)/\1 plymouth \2/' "$MKINITCPIO_CONF"

            # Verify the change was successful
            if grep -Eq "^HOOKS=.*plymouth.*(encrypt|sd-encrypt)" "$MKINITCPIO_CONF"; then
                {{ includeTemplate "log_success" "Plymouth hook added successfully before encrypt hook" }}
                PLYMOUTH_HOOK_CHANGED=true
            else
                {{ includeTemplate "log_error" "Failed to add plymouth hook - manual intervention required" }}
                {{ includeTemplate "log_info" "Please manually edit $MKINITCPIO_CONF to add 'plymouth' before 'encrypt' or 'sd-encrypt' in HOOKS" }}
                exit 1
            fi
        fi
    else
        # For non-encrypted systems: plymouth should be before filesystems
        if grep -q "^HOOKS=.*plymouth.*filesystems" "$MKINITCPIO_CONF"; then
            {{ includeTemplate "log_success" "Plymouth hook already configured before filesystems hook" }}
            PLYMOUTH_HOOK_CHANGED=false
        else
            {{ includeTemplate "log_info" "Adding plymouth hook before filesystems in mkinitcpio.conf..." }}

            # Create backup only if it doesn't already exist
            if [ ! -f "$MKINITCPIO_BACKUP" ]; then
                sudo cp "$MKINITCPIO_CONF" "$MKINITCPIO_BACKUP"
                {{ includeTemplate "log_info" "Created backup: $MKINITCPIO_BACKUP" }}
            fi

            # Insert plymouth before filesystems in HOOKS array
            # Current: HOOKS=(base udev autodetect microcode modconf kms keyboard keymap consolefont block filesystems fsck)
            # Target:  HOOKS=(base udev autodetect microcode modconf kms keyboard keymap consolefont block plymouth filesystems fsck)
            sudo sed -i 's/\(HOOKS=([^)]*block\) \(filesystems\)/\1 plymouth \2/' "$MKINITCPIO_CONF"

            # Verify the change was successful
            if grep -q "^HOOKS=.*plymouth.*filesystems" "$MKINITCPIO_CONF"; then
                {{ includeTemplate "log_success" "Plymouth hook added successfully before filesystems hook" }}
                PLYMOUTH_HOOK_CHANGED=true
            else
                {{ includeTemplate "log_error" "Failed to add plymouth hook - manual intervention required" }}
                {{ includeTemplate "log_info" "Please manually edit $MKINITCPIO_CONF to add 'plymouth' before 'filesystems' in HOOKS" }}
                exit 1
            fi
        fi
    fi

    {{ includeTemplate "log_step" "Configure Plymouth kernel parameters" }}

    CMDLINE_FILE="/etc/kernel/cmdline"

    if [ -f "$CMDLINE_FILE" ]; then
        # Check if Plymouth parameters are already present
        if grep -q "splash" "$CMDLINE_FILE" && grep -q "quiet" "$CMDLINE_FILE"; then
            {{ includeTemplate "log_success" "Plymouth kernel parameters already configured" }}
            PLYMOUTH_CMDLINE_CHANGED=false
        else
            {{ includeTemplate "log_info" "Adding splash and quiet parameters to kernel cmdline..." }}

            # Create backup only if it doesn't already exist
            if [ ! -f "${CMDLINE_FILE}.backup" ]; then
                sudo cp "$CMDLINE_FILE" "${CMDLINE_FILE}.backup"
                {{ includeTemplate "log_info" "Created backup: ${CMDLINE_FILE}.backup" }}
            fi

            # Read current cmdline
            CURRENT_CMDLINE=$(cat "$CMDLINE_FILE")

            # Add splash and quiet parameters
            NEW_CMDLINE="$CURRENT_CMDLINE"
            if ! echo "$CURRENT_CMDLINE" | grep -q "splash"; then
                NEW_CMDLINE="$NEW_CMDLINE splash"
            fi
            if ! echo "$CURRENT_CMDLINE" | grep -q "quiet"; then
                NEW_CMDLINE="$NEW_CMDLINE quiet"
            fi

            # Write updated cmdline
            echo "$NEW_CMDLINE" | sudo tee "$CMDLINE_FILE" > /dev/null

            {{ includeTemplate "log_success" "Plymouth kernel parameters added to $CMDLINE_FILE" }}
            PLYMOUTH_CMDLINE_CHANGED=true
        fi
    else
        {{ includeTemplate "log_warning" "No /etc/kernel/cmdline found - skipping Plymouth kernel parameters" }}
        PLYMOUTH_CMDLINE_CHANGED=false
    fi

    {{ includeTemplate "log_step" "Set Plymouth theme" }}

    DESIRED_THEME="{{ .globals.plymouth.theme }}"
    CURRENT_THEME=$(plymouth-set-default-theme)

    if [ "$CURRENT_THEME" = "$DESIRED_THEME" ]; then
        {{ includeTemplate "log_success" "Plymouth theme already set to: $DESIRED_THEME" }}
        PLYMOUTH_THEME_CHANGED=false
    else
        {{ includeTemplate "log_info" "Setting Plymouth theme to: $DESIRED_THEME (current: $CURRENT_THEME)" }}

        # Set theme (don't rebuild yet - we'll do it once at the end)
        sudo plymouth-set-default-theme "$DESIRED_THEME"

        {{ includeTemplate "log_success" "Plymouth theme set to: $DESIRED_THEME" }}
        PLYMOUTH_THEME_CHANGED=true
    fi

    {{ includeTemplate "log_success" "Plymouth configuration complete" }}
fi

# ============================================================================
# SECTION 3: SDDM CONFIGURATION
# ============================================================================

{{ includeTemplate "log_info" "" }}
{{ includeTemplate "log_info" "════════════════════════════════════════════════════════════════" }}
{{ includeTemplate "log_info" "  SECTION 3: SDDM Display Manager" }}
{{ includeTemplate "log_info" "════════════════════════════════════════════════════════════════" }}

{{ includeTemplate "log_step" "Verify SDDM installation" }}

if ! command -v sddm >/dev/null 2>&1; then
    {{ includeTemplate "log_skip" "SDDM not installed - skipping SDDM configuration" }}
    SDDM_INSTALLED=false
else
    {{ includeTemplate "log_success" "SDDM is installed" }}
    SDDM_INSTALLED=true

    {{ includeTemplate "log_step" "Create SDDM configuration directory" }}

    SDDM_CONF_DIR="/etc/sddm.conf.d"

    if [ ! -d "$SDDM_CONF_DIR" ]; then
        {{ includeTemplate "log_info" "Creating $SDDM_CONF_DIR..." }}
        sudo mkdir -p "$SDDM_CONF_DIR"
        {{ includeTemplate "log_success" "Created $SDDM_CONF_DIR" }}
    else
        {{ includeTemplate "log_success" "$SDDM_CONF_DIR already exists" }}
    fi

    {{ includeTemplate "log_step" "Backup original SDDM configuration" }}

    SDDM_CONF="/etc/sddm.conf"
    SDDM_BACKUP="${SDDM_CONF}.backup"

    if [ -f "$SDDM_CONF" ] && [ ! -f "$SDDM_BACKUP" ]; then
        {{ includeTemplate "log_info" "Creating backup: $SDDM_BACKUP" }}
        sudo cp "$SDDM_CONF" "$SDDM_BACKUP"
        {{ includeTemplate "log_success" "Backup created" }}
    elif [ -f "$SDDM_BACKUP" ]; then
        {{ includeTemplate "log_success" "Backup already exists: $SDDM_BACKUP" }}
    else
        {{ includeTemplate "log_info" "No existing $SDDM_CONF to backup" }}
    fi

    {{ includeTemplate "log_step" "Configure SDDM for Hyprland/Wayland" }}

    SDDM_HYPRLAND_CONF="$SDDM_CONF_DIR/10-hyprland.conf"
    DESIRED_THEME="{{ .globals.sddm.theme }}"
    _DESIRED_DISPLAY_SERVER="{{ .globals.sddm.display_server }}"  # Unused: hardcoded in heredoc

    {{ includeTemplate "log_info" "Creating $SDDM_HYPRLAND_CONF..." }}

    # Create modular SDDM configuration optimized for Hyprland
    sudo tee "$SDDM_HYPRLAND_CONF" > /dev/null << 'EOF'
# SDDM Configuration for Hyprland
# Managed by chezmoi - DO NOT EDIT MANUALLY
# To modify: Edit .chezmoidata/globals.yaml and run 'chezmoi apply'

[General]
# Use X11 display server (fixes Wayland→Wayland handoff crash on first login)
DisplayServer={{ .globals.sddm.display_server }}

# Enable NumLock by default
Numlock=on

[Theme]
# Current theme
Current={{ .globals.sddm.theme }}

# Enable user avatars
EnableAvatars=true

[Users]
# Remember last session (Hyprland)
RememberLastSession=true

# Remember last user
RememberLastUser=true

# Restore session instead of creating new
ReuseSession=true

[Wayland]
# Wayland compositor for SDDM greeter
# Note: This is for the greeter only, NOT Hyprland itself
# Hyprland starts after successful login via SessionCommand
CompositorCommand=weston --shell=fullscreen-shell.so

# Enable Qt's automatic high-DPI scaling
EnableHiDPI=true

# Session directories (includes Hyprland.desktop)
SessionDir=/usr/local/share/wayland-sessions,/usr/share/wayland-sessions

# Session log location
SessionLogFile=.local/share/sddm/wayland-session.log
EOF

    {{ includeTemplate "log_success" "Created $SDDM_HYPRLAND_CONF" }}

    {{ includeTemplate "log_step" "Verify SDDM theme installation" }}

    THEME_DIR="/usr/share/sddm/themes/$DESIRED_THEME"

    if [ ! -d "$THEME_DIR" ]; then
        {{ includeTemplate "log_error" "Theme not found: $THEME_DIR" }}
        {{ includeTemplate "log_info" "Available themes:" }}
        ls -1 /usr/share/sddm/themes/
        {{ includeTemplate "log_info" "Install the theme or update globals.yaml with an available theme" }}
        exit 1
    fi

    {{ includeTemplate "log_success" "Theme installed at $THEME_DIR" }}

    {{ includeTemplate "log_step" "Verify Hyprland session availability" }}

    if [ -f /usr/share/wayland-sessions/hyprland.desktop ]; then
        {{ includeTemplate "log_success" "Hyprland Wayland session available" }}
    elif [ -f /usr/share/wayland-sessions/hyprland-uwsm.desktop ]; then
        {{ includeTemplate "log_success" "Hyprland UWSM-managed session available" }}
    else
        {{ includeTemplate "log_error" "No Hyprland Wayland session found" }}
        {{ includeTemplate "log_info" "Available sessions:" }}
        ls -1 /usr/share/wayland-sessions/ || {{ includeTemplate "log_info" "No Wayland sessions found" }}
        exit 1
    fi

    {{ includeTemplate "log_step" "Verify SDDM service status" }}

    if systemctl is-enabled sddm.service >/dev/null 2>&1; then
        {{ includeTemplate "log_success" "SDDM service is enabled" }}
    else
        {{ includeTemplate "log_info" "SDDM service is not enabled - enabling now..." }}
        sudo systemctl enable sddm.service
        {{ includeTemplate "log_success" "SDDM service enabled" }}
    fi

    {{ includeTemplate "log_success" "SDDM configuration complete" }}
fi

# ============================================================================
# SECTION 4: SINGLE INITRAMFS REBUILD
# ============================================================================

{{ includeTemplate "log_info" "" }}
{{ includeTemplate "log_info" "════════════════════════════════════════════════════════════════" }}
{{ includeTemplate "log_info" "  SECTION 4: Initramfs Rebuild (Consolidate all changes)" }}
{{ includeTemplate "log_info" "════════════════════════════════════════════════════════════════" }}

{{ includeTemplate "log_step" "Checking if initramfs rebuild is needed..." }}

# Check if any changes were made that require rebuild
REBUILD_NEEDED=false

if [ "$PLYMOUTH_INSTALLED" = true ]; then
    if [ "${PLYMOUTH_HOOK_CHANGED:-false}" = true ] || [ "${PLYMOUTH_CMDLINE_CHANGED:-false}" = true ] || [ "${PLYMOUTH_THEME_CHANGED:-false}" = true ]; then
        {{ includeTemplate "log_info" "Plymouth configuration changed - rebuild required" }}
        REBUILD_NEEDED=true
    fi
fi

if [ "$REBUILD_NEEDED" = true ]; then
    {{ includeTemplate "log_step" "Rebuilding initramfs and UKI images (consolidated rebuild)..." }}

    {{ includeTemplate "log_info" "This rebuilds ALL kernels with ALL changes (GPU + Plymouth)" }}

    # Rebuild all kernels (mkinitcpio includes NVIDIA modules if they're installed)
    # DKMS modules were built automatically by pacman hooks during package installation
    sudo mkinitcpio -P

    {{ includeTemplate "log_success" "Initramfs and UKI images rebuilt successfully" }}
else
    {{ includeTemplate "log_skip" "No changes detected - skipping initramfs rebuild" }}
fi

# ============================================================================
# FINAL SUMMARY
# ============================================================================

{{ includeTemplate "log_info" "" }}
{{ includeTemplate "log_info" "════════════════════════════════════════════════════════════════" }}
{{ includeTemplate "log_info" "  Boot System Configuration Complete" }}
{{ includeTemplate "log_info" "════════════════════════════════════════════════════════════════" }}
{{ includeTemplate "log_info" "" }}

# GPU Summary
if [ "$NVIDIA_DETECTED" = true ]; then
    {{ includeTemplate "log_info" "GPU Configuration:" }}
    {{ includeTemplate "log_info" "  ✓ NVIDIA GPU detected and configured" }}
    {{ includeTemplate "log_info" "  ✓ DKMS modules verified for $KERNELS_BUILT_COUNT kernel(s): $ALL_BUILT" }}
    {{ includeTemplate "log_info" "  ✓ Kernel parameters set via modprobe.d (nvidia-utils)" }}
    {{ includeTemplate "log_info" "  ✓ Power management services enabled (suspend/resume/hibernate)" }}
    {{ includeTemplate "log_info" "" }}
fi

# Plymouth Summary
if [ "$PLYMOUTH_INSTALLED" = true ]; then
    {{ includeTemplate "log_info" "Plymouth Configuration:" }}
    {{ includeTemplate "log_info" "  ✓ Theme: {{ .globals.plymouth.theme }}" }}
    {{ includeTemplate "log_info" "  ✓ Kernel parameters: splash quiet" }}
    if [ "${USES_ENCRYPTION:-false}" = true ]; then
        {{ includeTemplate "log_info" "  ✓ Hooks: plymouth (before encrypt hook)" }}
    else
        {{ includeTemplate "log_info" "  ✓ Hooks: plymouth (before filesystems hook)" }}
    fi
    {{ includeTemplate "log_info" "" }}
fi

# SDDM Summary
if [ "$SDDM_INSTALLED" = true ]; then
    {{ includeTemplate "log_info" "SDDM Configuration:" }}
    {{ includeTemplate "log_info" "  ✓ Theme: {{ .globals.sddm.theme }}" }}
    {{ includeTemplate "log_info" "  ✓ Display server: {{ .globals.sddm.display_server }}" }}
    {{ includeTemplate "log_info" "  ✓ Hyprland session available" }}
    {{ includeTemplate "log_info" "" }}
fi

{{ includeTemplate "log_warning" "⚠️  REBOOT REQUIRED for all changes to take effect" }}
{{ includeTemplate "log_info" "" }}
{{ includeTemplate "log_info" "Boot sequence after reboot:" }}
if [ "$PLYMOUTH_INSTALLED" = true ] && [ "$SDDM_INSTALLED" = true ]; then
    if [ "${USES_ENCRYPTION:-false}" = true ]; then
        {{ includeTemplate "log_info" "  Firmware → Plymouth (LUKS password) → [Brief TTY flash] → SDDM → Hyprland" }}
    else
        {{ includeTemplate "log_info" "  Firmware → Plymouth (boot splash) → [Brief TTY flash] → SDDM → Hyprland" }}
    fi
elif [ "$SDDM_INSTALLED" = true ]; then
    {{ includeTemplate "log_info" "  Firmware → SDDM → Hyprland" }}
else
    {{ includeTemplate "log_info" "  Firmware → TTY/DM → Session" }}
fi
{{ includeTemplate "log_info" "" }}
{{ includeTemplate "log_info" "════════════════════════════════════════════════════════════════" }}
{{ includeTemplate "log_info" "" }}

{{ includeTemplate "log_complete" "Complete boot system configuration finished - REBOOT REQUIRED" }}
