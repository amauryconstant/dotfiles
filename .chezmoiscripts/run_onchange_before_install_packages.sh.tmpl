#!/usr/bin/env sh

# Script: run_onchange_before_install_packages.sh.tmpl
# Purpose: Sync system packages (Arch + Flatpak) to packages.yaml state
# Requirements: Arch Linux, paru, yq, package-manager.sh

# Hash: {{ .packages | toJson | sha256sum }}

{{ includeTemplate "log_start" "Syncing system packages to packages.yaml..." }}

set -euo pipefail

# Check if package-manager.sh v2.0 is available and healthy
if command -v package-manager >/dev/null 2>&1 && package-manager health --brief >/dev/null 2>&1; then
    {{ includeTemplate "log_step" "Using package-manager v2.0..." }}

    # Single sync command handles both Arch and Flatpak packages
    # --prune flag removes orphaned packages (not in any enabled module)
    # Note: Requires package-manager v2.0+ with module support
    if package-manager sync --prune; then
        {{ includeTemplate "log_success" "All packages synced successfully" }}
    else
        {{ includeTemplate "log_error" "Package sync failed" }}
        exit 1
    fi
else
    {{ includeTemplate "log_step" "Bootstrap mode: Installing essential packages..." }}

    # Minimal fallback for initial setup
    # Install only essential packages to bootstrap package-manager.sh
    BOOTSTRAP_PACKAGES="base base-devel paru go-yq gum"

    {{ includeTemplate "log_info" "Installing: $BOOTSTRAP_PACKAGES" }}

    if command -v paru >/dev/null 2>&1; then
        paru -S --noconfirm --needed $BOOTSTRAP_PACKAGES
    else
        # Last resort: install base packages with pacman
        sudo pacman -S --noconfirm --needed base base-devel
        {{ includeTemplate "log_warning" "AUR helper not available. Install paru manually, then re-run 'chezmoi apply'" }}
        exit 1
    fi

    {{ includeTemplate "log_success" "Bootstrap complete. Re-run 'chezmoi apply' to sync all packages" }}
fi

{{ includeTemplate "log_complete" "Package management completed" }}
