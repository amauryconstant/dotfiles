#!/usr/bin/env sh

# Script: run_once_before_001_install_package_manager.sh.tmpl
# Purpose: Install and configure package managers (paru, Chaotic-AUR)
# Requirements: Arch Linux

{{ includeTemplate "log_start" "Setting up package managers for Arch Linux..." }}

set -euo pipefail

# Verify internet connectivity before proceeding
{{ includeTemplate "log_step" "Verifying internet connectivity..." }}

if ping -c 1 -W 5 archlinux.org >/dev/null 2>&1; then
    {{ includeTemplate "log_success" "Internet connectivity confirmed" }}
elif ping -c 1 -W 5 8.8.8.8 >/dev/null 2>&1; then
    {{ includeTemplate "log_warning" "Network accessible but DNS may have issues" }}
    {{ includeTemplate "log_info" "Proceeding with caution - some operations may fail" }}
else
    {{ includeTemplate "log_error" "No internet connectivity detected" }}
    {{ includeTemplate "log_info" "" }}
    {{ includeTemplate "log_info" "Internet connection is required for:" }}
    {{ includeTemplate "log_info" "  - Downloading package manager keys from keyserver" }}
    {{ includeTemplate "log_info" "  - Installing packages from repositories" }}
    {{ includeTemplate "log_info" "  - Setting up Chaotic-AUR repository" }}
    {{ includeTemplate "log_info" "" }}
    {{ includeTemplate "log_info" "Fix network connection and re-run: chezmoi apply" }}
    {{ includeTemplate "log_info" "" }}
    exit 1
fi

# Enable multilib repository for 32-bit support
if ! grep -q "^\[multilib\]" /etc/pacman.conf; then
    {{ includeTemplate "log_step" "Enabling multilib repository..." }}
    sudo sed -i '/^#\[multilib\]/,/^#Include = \/etc\/pacman.d\/mirrorlist/ s/^#//' /etc/pacman.conf
    sudo pacman -Syuu --noconfirm
    {{ includeTemplate "log_success" "multilib repository enabled" }}
else
    {{ includeTemplate "log_info" "multilib already enabled" }}
fi

# Setup Chaotic-AUR repository first (provides paru)
if ! grep -q "chaotic-aur" /etc/pacman.conf; then
    {{ includeTemplate "log_step" "Setting up Chaotic-AUR repository..." }}

    sudo pacman-key --recv-key 3056513887B78AEB --keyserver keyserver.ubuntu.com
    sudo pacman-key --lsign-key 3056513887B78AEB
    sudo pacman -U --noconfirm \
        'https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-mirrorlist.pkg.tar.zst' \
        'https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-keyring.pkg.tar.zst'

    sudo tee -a /etc/pacman.conf > /dev/null << 'EOF'

# Chaotic-AUR repository
[chaotic-aur]
Include = /etc/pacman.d/chaotic-mirrorlist
EOF

    sudo pacman -Sy
    {{ includeTemplate "log_success" "Chaotic-AUR repository configured" }}
else
    {{ includeTemplate "log_info" "Chaotic-AUR already configured" }}
fi

# Install paru from Chaotic-AUR (avoids compilation)
if ! command -v paru &> /dev/null; then
    {{ includeTemplate "log_step" "Installing paru AUR helper from Chaotic-AUR..." }}
    sudo pacman -S --needed --noconfirm paru
    {{ includeTemplate "log_success" "paru AUR helper installed" }}
else
    {{ includeTemplate "log_info" "paru already installed" }}
fi

# Install essential dependencies for package-manager.sh
{{ includeTemplate "log_step" "Installing package-manager dependencies (yq, gum)..." }}
paru -S --noconfirm --needed go-yq gum
{{ includeTemplate "log_success" "package-manager dependencies installed" }}

# Initialize paru AUR cache for package validation
{{ includeTemplate "log_step" "Initializing paru AUR package cache..." }}
if paru --gendb >/dev/null 2>&1; then
    {{ includeTemplate "log_success" "paru cache initialized" }}
else
    {{ includeTemplate "log_warning" "paru cache initialization failed (non-critical)" }}
fi

# Optimize mirrors for faster downloads
{{ includeTemplate "log_step" "Optimizing Arch mirrors..." }}
paru -S --noconfirm --needed rate-mirrors
rate-mirrors --protocol https arch | sudo tee /etc/pacman.d/mirrorlist
{{ includeTemplate "log_success" "Mirrors optimized" }}

# Setup Flatpak
{{ includeTemplate "log_step" "Setting up Flatpak..." }}
if ! command -v flatpak &> /dev/null; then
    sudo pacman -S --needed --noconfirm flatpak
    {{ includeTemplate "log_success" "Flatpak installed" }}
else
    {{ includeTemplate "log_info" "Flatpak already installed" }}
fi

# Add Flathub remote in user scope (matches package-manager.sh --user installs)
if ! flatpak remote-list --user | grep -q "flathub"; then
    flatpak remote-add --user --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo
    {{ includeTemplate "log_info" "Flathub remote added (user scope)" }}
fi

# Update appstream metadata to populate package database
{{ includeTemplate "log_step" "Updating Flatpak metadata..." }}
flatpak update --user --appstream 2>&1 | grep -v "^$" || true
{{ includeTemplate "log_success" "Flatpak configured" }}

{{ includeTemplate "log_complete" "Package manager setup completed successfully" }}
