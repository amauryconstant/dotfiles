#!/usr/bin/env sh

# Script: run_onchange_after_update_topgrade_config.sh.tmpl
# Purpose: Deploy topgrade system configuration when it changes
# Requirements: Arch Linux, systemd, topgrade, topgrade-maintenance user
# Triggers: Runs whenever the topgrade system config changes

# Hash: {{ include ".data/topgrade-system.toml.tmpl" | sha256sum }}

{{ includeTemplate "log_start" "Updating topgrade system configuration..." }}

set -euo pipefail

# ============================================================================
# PREREQUISITES CHECK
# ============================================================================

# Check if topgrade is installed
if ! command -v topgrade >/dev/null 2>&1; then
    {{ includeTemplate "log_error" "topgrade is not installed" }}
    exit 1
fi

# Check if maintenance user exists
if ! id topgrade-maintenance >/dev/null 2>&1; then
    {{ includeTemplate "log_error" "Maintenance user 'topgrade-maintenance' does not exist" }}
    exit 1
fi

# Check if systemd service exists
if [ ! -f /etc/systemd/system/topgrade.service ]; then
    {{ includeTemplate "log_error" "Topgrade service not installed. Run initial setup first." }}
    exit 1
fi

# ============================================================================
# CONFIGURATION DEPLOYMENT
# ============================================================================

{{ includeTemplate "log_step" "Deploying updated configuration to /etc/topgrade/..." }}

# Create config directory if it doesn't exist
sudo mkdir -p /etc/topgrade

# Generate temporary config file
CONFIG_TEMP=$(mktemp)
trap "rm -f $CONFIG_TEMP" EXIT

# Render template to temporary file
"{{ .chezmoi.executable }}" execute-template < "{{ .chezmoi.sourceDir }}/.data/topgrade-system.toml.tmpl" > "$CONFIG_TEMP"

# Check if config has actually changed
if [ -f /etc/topgrade/topgrade.toml ] && cmp -s "$CONFIG_TEMP" /etc/topgrade/topgrade.toml; then
    {{ includeTemplate "log_success" "Configuration already up to date" }}
    exit 0
fi

# Deploy new configuration
sudo cp "$CONFIG_TEMP" /etc/topgrade/topgrade.toml
sudo chown topgrade-maintenance:topgrade-maintenance /etc/topgrade/topgrade.toml
sudo chmod 644 /etc/topgrade/topgrade.toml

{{ includeTemplate "log_success" "Configuration deployed successfully" }}

# ============================================================================
# SERVICE RESTART (if running)
# ============================================================================

{{ includeTemplate "log_step" "Checking if topgrade service needs restart..." }}

# If service is currently running, stop it gracefully
if sudo systemctl is-active topgrade.service >/dev/null 2>&1; then
    {{ includeTemplate "log_step" "Stopping active topgrade service..." }}
    sudo systemctl stop topgrade.service
    {{ includeTemplate "log_success" "Service stopped" }}
fi

# Reload systemd daemon to pick up any changes
sudo systemctl daemon-reload

# Ensure timer is still running
if ! sudo systemctl is-active topgrade.timer >/dev/null 2>&1; then
    {{ includeTemplate "log_step" "Restarting topgrade timer..." }}
    sudo systemctl start topgrade.timer
    {{ includeTemplate "log_success" "Timer restarted" }}
fi

{{ includeTemplate "log_complete" "Topgrade configuration update completed" }}
{{ includeTemplate "log_info" "  - Configuration: /etc/topgrade/topgrade.toml" }}
{{ includeTemplate "log_info" "  - Service status: systemctl status topgrade.timer" }}
{{ includeTemplate "log_info" "  - View logs: journalctl -u topgrade.service" }}
