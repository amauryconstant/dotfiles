#!/usr/bin/env sh

# Script: run_once_after_004_setup_network_printer.sh.tmpl
# Purpose: Install and configure Samsung M2070 Series network printer and scanner
# Requirements: Arch Linux

{{ includeTemplate "log_start" "Setting up Samsung M2070 Series printer and scanner..." }}

# Set strict error handling
set -euo pipefail

# Printer configuration from globals.yaml
PRINTER_NAME="{{ .globals.printer.name }}"
PRINTER_IP="{{ .globals.printer.ip }}"
PRINTER_MODEL="{{ .globals.printer.model }}"
PRINTER_DESCRIPTION="{{ .globals.printer.description }}"

# Check if package is installed
is_package_installed() {
    local package="$1"
    pacman -Qi "$package" >/dev/null 2>&1 || paru -Qi "$package" >/dev/null 2>&1
}

# Check if service is enabled and running
is_service_active() {
    local service="$1"
    systemctl is-active --quiet "$service" 2>/dev/null
}

is_service_enabled() {
    local service="$1"
    systemctl is-enabled --quiet "$service" 2>/dev/null
}

# Check if printer is already configured
is_printer_configured() {
    lpstat -p "$PRINTER_NAME" >/dev/null 2>&1
}

# Check if user is in required groups
is_user_in_group() {
    local group="$1"
    groups | grep -q "\b$group\b"
}

# Add user to group if not already a member
add_user_to_group() {
    local group="$1"
    if ! is_user_in_group "$group"; then
        {{ includeTemplate "log_info" "Adding user to $group group..." }}
        sudo usermod -a -G "$group" "$USER"
        {{ includeTemplate "log_success" "User added to $group group (requires logout/login to take effect)" }}
    else
        {{ includeTemplate "log_info" "User already in $group group" }}
    fi
}

# Detect printer URI using lpinfo
detect_printer_uri() {
    # Try different protocols (without logging to avoid output capture issues)
    local uris=(
        "ipp://$PRINTER_IP/ipp/print"
        "http://$PRINTER_IP:631/ipp/print"
        "socket://$PRINTER_IP:9100"
        "lpd://$PRINTER_IP/queue"
    )
    
    for uri in "${uris[@]}"; do
        if lpinfo -v 2>/dev/null | grep -q "$uri"; then
            echo "$uri"
            return 0
        fi
    done
    
    # Fallback to socket protocol
    echo "socket://$PRINTER_IP:9100"
}

# Configure printer
configure_printer() {
    {{ includeTemplate "log_info" "Configuring Samsung M2070 Series printer..." }}
    
    if is_printer_configured; then
        {{ includeTemplate "log_info" "Printer '$PRINTER_NAME' is already configured" }}
        return 0
    fi
    
    # Detect printer URI
    {{ includeTemplate "log_info" "Detecting printer URI..." }}
    local printer_uri
    printer_uri=$(detect_printer_uri)
    {{ includeTemplate "log_info" "Using printer URI: $printer_uri" }}

    # Use Samsung M2070 official driver
    {{ includeTemplate "log_info" "Using Samsung M2070 Series official driver..." }}
    local driver_option="-m uld-samsung/Samsung_M2070_Series.ppd.gz"

    # Add printer using lpadmin
    {{ includeTemplate "log_info" "Adding printer with Samsung driver..." }}
    sudo lpadmin -p "$PRINTER_NAME" \
        -v "$printer_uri" \
        $driver_option \
        -D "$PRINTER_DESCRIPTION" \
        -L "Network Printer at $PRINTER_IP" \
        -E
    
    # Set as default printer
    sudo lpadmin -d "$PRINTER_NAME"
    
    # Accept jobs
    sudo cupsenable "$PRINTER_NAME"
    sudo cupsaccept "$PRINTER_NAME"
    
    {{ includeTemplate "log_success" "Printer configured successfully" }}
}

# Configure scanner
configure_scanner() {
    {{ includeTemplate "log_info" "Configuring network scanner..." }}

    # Check if SANE packages are installed
    if ! is_package_installed "sane-airscan"; then
        {{ includeTemplate "log_error" "sane-airscan is not installed. Scanner configuration skipped." }}
        return 1
    fi

    if ! is_package_installed "sane"; then
        {{ includeTemplate "log_error" "sane is not installed. Scanner configuration skipped." }}
        return 1
    fi

    # Configure smfp backend (Samsung Unified Driver - primary method for 600 DPI)
    local smfp_conf="/etc/sane.d/smfp.conf"
    {{ includeTemplate "log_info" "Configuring Samsung smfp backend..." }}

    if [ -f "$smfp_conf" ]; then
        # Backup existing configuration
        sudo cp "$smfp_conf" "${smfp_conf}.bak"

        # Check if TCP entry already exists for M2070
        if ! grep -q "^tcp $PRINTER_IP" "$smfp_conf" 2>/dev/null; then
            # Add network scanner configuration
            echo "" | sudo tee -a "$smfp_conf" > /dev/null
            echo "# Samsung M2070 Series - Network Scanner (smfp backend)" | sudo tee -a "$smfp_conf" > /dev/null
            echo "# Added by chezmoi - supports up to 600 DPI" | sudo tee -a "$smfp_conf" > /dev/null
            echo "tcp $PRINTER_IP" | sudo tee -a "$smfp_conf" > /dev/null
            {{ includeTemplate "log_success" "smfp backend network configuration added" }}
        else
            {{ includeTemplate "log_info" "smfp backend configuration already exists" }}
        fi
    else
        {{ includeTemplate "log_info" "smfp.conf not found - Samsung driver may need installation" }}
    fi

    # Disable airscan for Samsung M2070 (forces use of smfp backend for 600 DPI)
    local airscan_conf="/etc/sane.d/airscan.conf"
    {{ includeTemplate "log_info" "Disabling airscan WSD backend for Samsung M2070..." }}

    # Backup existing configuration if it exists
    if [ -f "$airscan_conf" ]; then
        sudo cp "$airscan_conf" "${airscan_conf}.bak"
    fi

    # Create airscan configuration that disables Samsung M2070
    sudo tee "$airscan_conf" > /dev/null << 'EOF'
# Samsung M2070 Series Scanner Configuration
# Generated by chezmoi - airscan disabled to use smfp backend for 600 DPI

[devices]
# Disable WSD for Samsung M2070 (use smfp backend instead for higher DPI)
"Samsung M2070 Series" = disable

[options]
# Enable automatic discovery for other scanners
discovery = enable

# Use full WSD discovery mode (more thorough than fast mode)
ws-discovery = full

# Use network name for model identification
model = network

# Protocol preference
protocol = auto
EOF
    {{ includeTemplate "log_success" "airscan disabled for Samsung M2070 (will use smfp backend)" }}

    # Configure xerox_mfp backend for Samsung M2070 network scanner (fallback method)
    local xerox_conf="/etc/sane.d/xerox_mfp.conf"
    {{ includeTemplate "log_info" "Configuring xerox_mfp backend for network scanning..." }}

    if [ -f "$xerox_conf" ]; then
        # Backup existing configuration
        sudo cp "$xerox_conf" "${xerox_conf}.bak"

        # Check if TCP entry already exists
        if ! grep -q "^tcp $PRINTER_IP" "$xerox_conf" 2>/dev/null; then
            # Add network scanner configuration at the end
            echo "" | sudo tee -a "$xerox_conf" > /dev/null
            echo "# Samsung M2070 Series - Network Scanner Configuration" | sudo tee -a "$xerox_conf" > /dev/null
            echo "# Added by chezmoi" | sudo tee -a "$xerox_conf" > /dev/null
            echo "tcp $PRINTER_IP" | sudo tee -a "$xerox_conf" > /dev/null
            {{ includeTemplate "log_success" "xerox_mfp network configuration added" }}
        else
            {{ includeTemplate "log_info" "xerox_mfp network configuration already exists" }}
        fi
    else
        {{ includeTemplate "log_error" "xerox_mfp.conf not found - skipping native backend configuration" }}
    fi

    # Test scanner detection with multiple backends
    {{ includeTemplate "log_info" "Testing scanner detection with available backends..." }}

    # Give SANE a moment to refresh
    sleep 2

    # Test smfp backend specifically (Samsung Unified Driver - 600 DPI)
    local smfp_found=false
    if scanimage -L 2>/dev/null | grep -qi "smfp.*$PRINTER_IP\|smfp.*samsung.*m2070"; then
        {{ includeTemplate "log_success" "Scanner detected via smfp backend (600 DPI capable)" }}
        smfp_found=true
    fi

    # Test xerox_mfp backend specifically (fallback - 600 DPI)
    local xerox_found=false
    if scanimage -L 2>/dev/null | grep -qi "xerox_mfp.*$PRINTER_IP"; then
        {{ includeTemplate "log_success" "Scanner detected via xerox_mfp backend (600 DPI capable)" }}
        xerox_found=true
    fi

    # Test airscan backend (should be disabled for M2070)
    local airscan_found=false
    if scanimage -L 2>/dev/null | grep -qi "airscan.*samsung.*m2070"; then
        {{ includeTemplate "log_info" "Scanner detected via airscan backend (300 DPI limit)" }}
        airscan_found=true
    fi

    # Check for any scanner detection
    if scanimage -L 2>/dev/null | grep -q "$PRINTER_IP\|samsung.*m2070"; then
        {{ includeTemplate "log_success" "Scanner successfully configured and detected!" }}

        # Show which backend is active
        if [ "$smfp_found" = true ]; then
            echo "  ✓ Using smfp backend (Samsung official driver - 600 DPI)"
        elif [ "$xerox_found" = true ]; then
            echo "  ✓ Using xerox_mfp backend (fallback - 600 DPI)"
        elif [ "$airscan_found" = true ]; then
            echo "  ⚠ Using airscan backend (300 DPI limit - consider disabling)"
        fi
        return 0
    else
        {{ includeTemplate "log_info" "Scanner not immediately detected - may require:" }}
        echo "  1. Package installation: chezmoi apply (to install Samsung drivers)"
        echo "  2. System restart for group permissions to take effect"
        echo "  3. CUPS service restart: sudo systemctl restart cups"
        echo "  4. Manual verification: scanimage -L"
        return 0
    fi
}

{{ includeTemplate "log_info" "Printer IP: $PRINTER_IP" }}

# Step 1: Verify required packages are installed
{{ includeTemplate "log_step" "Verifying required packages..." }}

required_packages=("cups" "sane-airscan" "sane" "system-config-printer" "samsung-unified-driver-printer")

for package in "${required_packages[@]}"; do
    if ! is_package_installed "$package"; then
        {{ includeTemplate "log_error" "Required package '$package' is not installed" }}
        {{ includeTemplate "log_error" "Please run the package installation script first" }}
        exit 1
    fi
done
{{ includeTemplate "log_success" "All required packages are installed" }}

# Step 2: Enable and start CUPS service
{{ includeTemplate "log_step" "Configuring CUPS service..." }}

if ! is_service_enabled "cups.service"; then
    {{ includeTemplate "log_info" "Enabling CUPS service..." }}
    sudo systemctl enable cups.service
fi

if ! is_service_active "cups.service"; then
    {{ includeTemplate "log_info" "Starting CUPS service..." }}
    sudo systemctl start cups.service
fi

{{ includeTemplate "log_success" "CUPS service is running" }}

# Step 3: Add user to required groups
{{ includeTemplate "log_step" "Configuring user permissions..." }}
add_user_to_group "lp"
add_user_to_group "scanner"

# Step 4: Configure printer
{{ includeTemplate "log_step" "Configuring printer..." }}
configure_printer

# Step 5: Configure scanner
{{ includeTemplate "log_step" "Configuring scanner..." }}
configure_scanner

# Step 6: Test configuration
{{ includeTemplate "log_step" "Testing configuration..." }}

# Test printer
if lpstat -p "$PRINTER_NAME" >/dev/null 2>&1; then
    {{ includeTemplate "log_success" "Printer configuration verified" }}
else
    {{ includeTemplate "log_error" "Printer configuration failed" }}
fi

# Test scanner (basic check)
if command -v scanimage >/dev/null 2>&1; then
    {{ includeTemplate "log_success" "Scanner tools available" }}
else
    {{ includeTemplate "log_error" "Scanner tools not available" }}
fi

{{ includeTemplate "log_complete" "Samsung M2070 Series setup completed!" }}

# Print summary
echo ""
echo "=== Setup Summary ==="
echo "Printer Name: $PRINTER_NAME"
echo "Printer IP: $PRINTER_IP"
echo "Printer URI: $(detect_printer_uri)"
echo ""
echo "=== Next Steps ==="
echo "1. Log out and log back in for group permissions to take effect"
echo "2. Test printing: echo 'Test page' | lp -d $PRINTER_NAME"
echo "3. Test scanning with skanpage (KDE) or simple-scan"
echo "4. Access printer settings: http://localhost:631"
echo ""
echo "=== Troubleshooting ==="
echo "- Check printer status: lpstat -p $PRINTER_NAME"
echo "- Check scanner: scanimage -L"
echo "- CUPS web interface: http://localhost:631"
echo "- Restart CUPS: sudo systemctl restart cups.service"
