#!/usr/bin/env sh

# Script: run_once_before_004_install_distributions_and_os_specifics.sh.tmpl
# Purpose: Install and configure distribution-specific packages and configurations
# Requirements: Arch Linux (EndeavourOS variant supported)

{{ includeTemplate "log_start" "Checking for distribution-specific configurations..." }}

# Set strict error handling
set -euo pipefail

{{ if eq .chezmoi.osRelease.id "endeavouros" }}

{{ includeTemplate "log_step" "EndeavourOS detected - applying specific configurations..." }}

{{ includeTemplate "log_info" "Optimizing EndeavourOS mirrors..." }}
rate-mirrors --protocol https endeavouros | sudo tee /etc/pacman.d/endeavouros-mirrorlist

{{ includeTemplate "log_info" "Running EndeavourOS system update..." }}
eos-update

{{ includeTemplate "log_info" "Installing NVIDIA installer..." }}
yay -S --noconfirm nvidia-inst

{{ includeTemplate "log_info" "Installing NVIDIA drivers..." }}
nvidia-inst -of --no-dkms

{{ includeTemplate "log_info" "Running NVIDIA kernel update check..." }}
eos-kernel-nvidia-update-check

{{ includeTemplate "log_complete" "EndeavourOS-specific setup completed" }}

{{ else }}

{{ includeTemplate "log_skip" "No distribution-specific configuration for {{ .chezmoi.osRelease.id }}" }}

{{ end }}
