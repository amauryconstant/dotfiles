#!/usr/bin/env sh

# Script: run_once_before_002_write_globals.sh.tmpl
# Purpose: Copy pam_env.conf to /etc/security/ for global environment variables
# Requirements: Linux

{{ includeTemplate "log_step" "Setting up global environment variables via pam_env..." }}

# Set strict error handling
set -euo pipefail

# Source and target paths
SOURCE_FILE="{{ .chezmoi.sourceDir }}/.data/pam_env.conf"
TARGET_FILE="/etc/security/pam_env.conf"

# Check if source file exists
if [ ! -f "$SOURCE_FILE" ]; then
    {{ includeTemplate "log_error" "Source pam_env.conf not found at $SOURCE_FILE" }}
    exit 1
fi

# Copy the file to /etc/security/ (requires sudo)
sudo cp "$SOURCE_FILE" "$TARGET_FILE"

# Set appropriate permissions
sudo chmod 644 "$TARGET_FILE"
sudo chown root:root "$TARGET_FILE"

{{ includeTemplate "log_success" "pam_env.conf copied to $TARGET_FILE" }}
