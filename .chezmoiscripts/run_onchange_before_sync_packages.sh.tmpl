#!/usr/bin/env bash

# Script: run_onchange_before_sync_packages.sh.tmpl
# Purpose: Install all packages from packages.yaml (simplified, self-contained)
# Requirements: Arch Linux, paru, yq, flatpak
# Execution: Runs on first install AND when packages.yaml changes (hash-triggered)
# Timing: Runs BEFORE file application (lib/scripts not yet available)
# Design: No dependencies on lib/scripts - completely self-contained

# Hash: {{ .packages | toJson | sha256sum }}

{{ includeTemplate "log_start" "Installing packages from packages.yaml..." }}

set -euo pipefail

# Package data location
PACKAGES_FILE="$HOME/.local/share/chezmoi/.chezmoidata/packages.yaml"

# Auto-select NVIDIA driver module based on GPU detection
NVIDIA_DRIVER_TYPE="{{ .nvidiaDriverType }}"
TEMP_PACKAGES_FILE="/tmp/packages-$$.yaml"
cp "$PACKAGES_FILE" "$TEMP_PACKAGES_FILE"

{{ includeTemplate "log_step" "Configuring NVIDIA driver selection (type: {{ .nvidiaDriverType }})..." }}

if [ "$NVIDIA_DRIVER_TYPE" = "legacy" ]; then
    # Enable legacy, disable modern
    yq eval '.packages.modules.graphics_drivers_legacy.enabled = true | .packages.modules.graphics_drivers_modern.enabled = false' -i "$TEMP_PACKAGES_FILE"
    {{ includeTemplate "log_info" "Using legacy NVIDIA drivers (nvidia-580xx-dkms)" }}
else
    # Enable modern, disable legacy
    yq eval '.packages.modules.graphics_drivers_modern.enabled = true | .packages.modules.graphics_drivers_legacy.enabled = false' -i "$TEMP_PACKAGES_FILE"
    {{ includeTemplate "log_info" "Using modern NVIDIA drivers (nvidia-open)" }}
fi

{{ includeTemplate "log_step" "Extracting package lists from enabled modules..." }}

# Extract all Arch/AUR packages (only from enabled modules)
ARCH_PACKAGES=$(yq eval '.packages.modules.[] | select(.enabled == true) | .packages[] | select(. | test("^flatpak:") | not)' "$TEMP_PACKAGES_FILE" 2>/dev/null | sort -u)

# Extract all Flatpak packages (only from enabled modules, strip flatpak: prefix)
FLATPAK_PACKAGES=$(yq eval '.packages.modules.[] | select(.enabled == true) | .packages[] | select(. | test("^flatpak:")) | sub("^flatpak:", "")' "$TEMP_PACKAGES_FILE" | sort -u) || {
    {{ includeTemplate "log_error" "Failed to extract Flatpak packages from packages.yaml" }}
    exit 1
}

# Extract packages to delete
DELETE_PACKAGES=$(yq eval '.packages.delete[]' "$TEMP_PACKAGES_FILE" 2>/dev/null | sort -u)

# Add conditional NVIDIA driver cleanup
if [ "$NVIDIA_DRIVER_TYPE" = "legacy" ]; then
    # Clean up modern drivers when using legacy
    DELETE_PACKAGES=$(echo -e "$DELETE_PACKAGES\nnvidia-open\nnvidia-open-lts\nnvidia-open-dkms" | sort -u)
else
    # Clean up legacy drivers when using modern
    DELETE_PACKAGES=$(echo -e "$DELETE_PACKAGES\nnvidia-580xx-dkms\nnvidia-580xx-utils\nlib32-nvidia-580xx-utils" | sort -u)
    # Remove DKMS variant if switching to pre-built modern drivers
    if pacman -Q nvidia-open-dkms >/dev/null 2>&1; then
        DELETE_PACKAGES=$(echo -e "$DELETE_PACKAGES\nnvidia-open-dkms" | sort -u)
        {{ includeTemplate "log_info" "Detected nvidia-open-dkms â†’ switching to nvidia-open (pre-built)" }}
    fi
fi

# Cleanup temp file
rm -f "$TEMP_PACKAGES_FILE"

# ============================================================
# Refresh mirrors before package installation
# ============================================================

{{ includeTemplate "log_step" "Refreshing package mirrors..." }}

if command -v rate-mirrors >/dev/null 2>&1; then
    MIRRORLIST="/etc/pacman.d/mirrorlist"
    if [ -f "$MIRRORLIST" ]; then
        LAST_REFRESH=$(stat -c %Y "$MIRRORLIST" 2>/dev/null || echo 0)
        CURRENT_TIME=$(date +%s)
        HOURS_SINCE_REFRESH=$(( (CURRENT_TIME - LAST_REFRESH) / 3600 ))

        if [ "$HOURS_SINCE_REFRESH" -gt 24 ]; then
            {{ includeTemplate "log_info" "Mirrors stale (${HOURS_SINCE_REFRESH}h), refreshing..." }}
            DETECTED_COUNTRY=$(curl -s ipinfo.io/country 2>/dev/null || echo "US")
            rate-mirrors --protocol https --entry-country "$DETECTED_COUNTRY" arch | sudo tee /etc/pacman.d/mirrorlist >/dev/null 2>&1
            sudo pacman -Sy >/dev/null 2>&1
            {{ includeTemplate "log_success" "Mirrors refreshed for $DETECTED_COUNTRY" }}
        else
            {{ includeTemplate "log_info" "Mirrors up to date (${HOURS_SINCE_REFRESH}h old)" }}
        fi
    else
        {{ includeTemplate "log_warning" "Mirrorlist not found, skipping refresh" }}
    fi
else
    {{ includeTemplate "log_skip" "rate-mirrors not available, using existing mirrors" }}
fi

# ============================================================
# Initialize Flatpak for user scope
# ============================================================

{{ includeTemplate "log_step" "Initializing Flatpak user environment..." }}

# Ensure user directories exist
mkdir -p "$HOME/.local/share/flatpak"
mkdir -p "$HOME/.var/app"

# Update appstream metadata for user scope (fresh install only)
if ! flatpak remotes --user 2>/dev/null | grep -q "flathub"; then
    {{ includeTemplate "log_step" "Flatpak will be initialized after remote is added..." }}
    # Metadata update will happen after remote is added
fi

# Count packages
ARCH_COUNT=$(echo "$ARCH_PACKAGES" | grep -c '^' || echo 0)
FLATPAK_COUNT=$(echo "$FLATPAK_PACKAGES" | grep -c '^' || echo 0)
DELETE_COUNT=$(echo "$DELETE_PACKAGES" | grep -c '^' || echo 0)

{{ includeTemplate "log_success" "Found $ARCH_COUNT Arch/AUR packages, $FLATPAK_COUNT Flatpak packages, $DELETE_COUNT packages to remove" }}

# ============================================================
# Install Arch/AUR packages
# ============================================================

if [ "$ARCH_COUNT" -gt 0 ]; then
    {{ includeTemplate "log_step" "Installing $ARCH_COUNT Arch/AUR packages with paru..." }}

    # Install all packages in single paru call
    # --needed: Skip already installed packages at target version
    # --noconfirm: Non-interactive mode
    if echo "$ARCH_PACKAGES" | xargs paru -S --needed --noconfirm; then
        {{ includeTemplate "log_success" "Arch/AUR packages installed successfully" }}
    else
        {{ includeTemplate "log_error" "Some Arch/AUR packages failed to install" }}
        exit 1
    fi
else
    {{ includeTemplate "log_skip" "No Arch/AUR packages to install" }}
fi

# ============================================================
# Install Flatpak packages
# ============================================================

if [ "$FLATPAK_COUNT" -gt 0 ]; then
    {{ includeTemplate "log_step" "Installing $FLATPAK_COUNT Flatpak packages..." }}

    # Ensure Flathub remote configured (user scope)
    if ! flatpak remote-list --user 2>/dev/null | grep -q "^flathub"; then
        {{ includeTemplate "log_step" "Adding Flathub remote..." }}
        flatpak remote-add --if-not-exists --user flathub https://flathub.org/repo/flathub.flatpakrepo

        # Update appstream metadata after adding remote
        {{ includeTemplate "log_step" "Updating Flatpak metadata..." }}
        flatpak update --appstream --user 2>&1 | grep -v "^$" || true
    fi

    # Install all packages in single flatpak call (like Arch section)
    # -y: Non-interactive
    # --user: Install in user scope
    # --noninteractive: Skip prompts
    if echo "$FLATPAK_PACKAGES" | xargs -r flatpak install -y --user --noninteractive flathub 2>&1; then
        {{ includeTemplate "log_success" "Flatpak packages installed successfully" }}
    else
        {{ includeTemplate "log_error" "Some Flatpak packages failed to install" }}
        {{ includeTemplate "log_warning" "Check above output for specific failures" }}
        # Continue anyway (some packages may not be available)
    fi
else
    {{ includeTemplate "log_skip" "No Flatpak packages to install" }}
fi

# ============================================================
# Remove unwanted packages
# ============================================================

if [ "$DELETE_COUNT" -gt 0 ]; then
    {{ includeTemplate "log_step" "Removing $DELETE_COUNT unwanted packages..." }}

    # Remove packages
    # -Rns: Remove package, dependencies, and config files
    # --noconfirm: Non-interactive
    # || true: Continue even if packages don't exist
    echo "$DELETE_PACKAGES" | xargs paru -Rns --noconfirm 2>/dev/null || true

    {{ includeTemplate "log_success" "Package cleanup complete" }}
else
    {{ includeTemplate "log_skip" "No packages to remove" }}
fi

# ============================================================
# Clean orphaned packages
# ============================================================

{{ includeTemplate "log_step" "Checking for orphaned packages..." }}

# Find and remove orphaned packages (dependencies no longer required)
# -Qtdq: Query unrequired dependencies
# -Rns: Remove with dependencies and config files
# -r flag to xargs: Only run if input is non-empty
ORPHANS=$(paru -Qtdq 2>/dev/null || true)

if [ -n "$ORPHANS" ]; then
    ORPHAN_COUNT=$(echo "$ORPHANS" | grep -c '^' || echo 0)
    {{ includeTemplate "log_step" "Removing $ORPHAN_COUNT orphaned packages..." }}
    echo "$ORPHANS" | xargs -r paru -Rns --noconfirm 2>/dev/null || true
    {{ includeTemplate "log_success" "Orphaned packages removed" }}
else
    {{ includeTemplate "log_success" "No orphaned packages found" }}
fi

{{ includeTemplate "log_complete" "Package installation and cleanup complete" }}
