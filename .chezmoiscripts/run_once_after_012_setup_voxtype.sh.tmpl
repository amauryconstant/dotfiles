#!/usr/bin/env bash

# Script: run_once_after_012_setup_voxtype.sh.tmpl
# Purpose: Configure Voxtype speech-to-text with Parakeet + CUDA
# Requirements: voxtype-bin, cuda, NVIDIA GPU
# Execution: Runs once after package installation

{{ includeTemplate "log_start" "Setting up Voxtype speech-to-text" }}

set -euo pipefail

# Check if voxtype is installed
if ! command -v voxtype >/dev/null 2>&1; then
    {{ includeTemplate "log_skip" "Voxtype not installed" }}
    exit 0
fi

# ============================================================================
# SECTION 1: Input group (required for built-in hotkey)
# ============================================================================

{{- $username := .chezmoi.username }}
{{ includeTemplate "log_step" "Checking input group membership..." }}

if id -nG {{ $username }} | grep -qw input; then
    {{ includeTemplate "log_skip" "User already in input group" }}
else
    sudo usermod -aG input {{ $username }}
    {{ includeTemplate "log_success" "User added to input group" }}
    {{ includeTemplate "log_warning" "Logout/login required for group change" }}
fi

# ============================================================================
# SECTION 2: GPU Detection (User-Level, No Sudo)
# ============================================================================

{{ includeTemplate "log_step" "Detecting NVIDIA GPU..." }}

NVIDIA_GPU=false
CUDA_AVAILABLE=false

if ! lspci | grep -i 'vga\|3d\|display' | grep -iq nvidia; then
    {{ includeTemplate "log_skip" "No NVIDIA GPU detected" }}
else
    NVIDIA_GPU=true
    {{ includeTemplate "log_success" "NVIDIA GPU detected" }}

    if pacman -Q cuda >/dev/null 2>&1; then
        CUDA_AVAILABLE=true
    else
        {{ includeTemplate "log_warning" "CUDA package not installed" }}
    fi
fi

# ============================================================================
# SECTION 3: GPU Acceleration Enablement (Requires Sudo)
# ============================================================================

{{ includeTemplate "log_step" "Enabling GPU acceleration..." }}

CURRENT_SYMLINK=$(readlink /usr/bin/voxtype)
ENGINE_ENABLED=""
BACKEND_USED=""

if [ "$NVIDIA_GPU" = true ]; then
    if [ "$CUDA_AVAILABLE" = true ]; then
        # Enable Parakeet (ONNX CUDA) - GPU auto-selected
        if [ "$CURRENT_SYMLINK" = "/usr/lib/voxtype/voxtype-onnx-cuda" ]; then
            {{ includeTemplate "log_skip" "Parakeet engine already enabled" }}
            ENGINE_ENABLED="Parakeet"
            BACKEND_USED="ONNX CUDA"
        else
            sudo voxtype setup parakeet --enable
            {{ includeTemplate "log_success" "Parakeet engine enabled (CUDA)" }}
            ENGINE_ENABLED="Parakeet"
            BACKEND_USED="ONNX CUDA"
        fi
    else
        # Enable Whisper (Vulkan) - Need to select NVIDIA GPU
        if [ "$CURRENT_SYMLINK" = "/usr/lib/voxtype/voxtype-vulkan" ]; then
            {{ includeTemplate "log_skip" "Vulkan GPU already enabled" }}
            ENGINE_ENABLED="Whisper"
            BACKEND_USED="Vulkan"
        else
            sudo voxtype setup gpu --enable
            {{ includeTemplate "log_success" "Whisper GPU acceleration enabled (Vulkan)" }}
            {{ includeTemplate "log_info" "NVIDIA GPU selected for Vulkan" }}
            ENGINE_ENABLED="Whisper"
            BACKEND_USED="Vulkan"
        fi
    fi
else
    {{ includeTemplate "log_skip" "No NVIDIA GPU - skipping GPU acceleration" }}
fi

# Reload systemd daemon for any changes
systemctl --user daemon-reload

# ============================================================================
# SECTION 4: Download STT Model
# ============================================================================

{{ includeTemplate "log_step" "Checking for STT model..." }}

VOXTYPE_DATA="$HOME/.local/share/voxtype"

if [ -d "$VOXTYPE_DATA" ] && [ "$(ls -A $VOXTYPE_DATA 2>/dev/null)" ]; then
    {{ includeTemplate "log_skip" "Model already downloaded" }}
else
    {{ includeTemplate "log_step" "Downloading STT model (this may take a moment)..." }}
    voxtype setup model
    {{ includeTemplate "log_success" "STT model downloaded" }}
fi

# ============================================================================
# SECTION 5: Enable Systemd User Service
# ============================================================================

{{ includeTemplate "log_step" "Enabling voxtype systemd service..." }}

if systemctl --user is-enabled --quiet voxtype; then
    {{ includeTemplate "log_skip" "Service already enabled" }}
else
    systemctl --user enable --now voxtype
    {{ includeTemplate "log_success" "Voxtype service enabled" }}
fi

if systemctl --user is-active --quiet voxtype; then
    {{ includeTemplate "log_success" "Voxtype service running" }}
else
    {{ includeTemplate "log_warning" "Voxtype service not active" }}
    {{ includeTemplate "log_info" "Check status: systemctl --user status voxtype" }}
fi

# ============================================================================
# FINAL SUMMARY
# ============================================================================

echo ""
echo "════════════════════════════════════════════════════════════════"
echo "  Voxtype Setup Complete"
echo "════════════════════════════════════════════════════════════════"
echo ""
echo "  Usage: Hold Super+T, speak, release"
echo "  Text appears in clipboard - paste with Ctrl+V"
echo ""

if [ -n "$ENGINE_ENABLED" ]; then
    echo "  Configuration:"
    echo "    Engine: $ENGINE_ENABLED"
    echo "    Backend: $BACKEND_USED"
    {{- if eq .chassisType "laptop" }}
    if [ "$BACKEND_USED" = "Vulkan" ]; then
        echo "    GPU: NVIDIA (auto-selected)"
    fi
    {{- end }}
    echo ""
fi

if ! id -nG {{ $username }} | grep -qw input; then
    echo "  NOTE: Logout/login required for input group membership"
    echo ""
fi

{{ includeTemplate "log_complete" "Voxtype configuration finished" }}
