#!/usr/bin/env bash

# Script: run_once_after_012_setup_voxtype.sh.tmpl
# Purpose: Configure Voxtype speech-to-text with Parakeet + CUDA
# Requirements: voxtype-bin, cuda, NVIDIA GPU
# Execution: Runs once after package installation

{{ includeTemplate "log_start" "Setting up Voxtype speech-to-text" }}

set -euo pipefail

# Check if voxtype is installed
if ! command -v voxtype >/dev/null 2>&1; then
    {{ includeTemplate "log_skip" "Voxtype not installed" }}
    exit 0
fi

# ============================================================================
# SECTION 1: Input group (required for built-in hotkey)
# ============================================================================

{{- $username := .chezmoi.username }}
{{ includeTemplate "log_step" "Checking input group membership..." }}

if id -nG {{ $username }} | grep -qw input; then
    {{ includeTemplate "log_skip" "User already in input group" }}
else
    sudo usermod -aG input {{ $username }}
    {{ includeTemplate "log_success" "User added to input group" }}
    {{ includeTemplate "log_warning" "Logout/login required for group change" }}
fi

# ============================================================================
# SECTION 2: GPU Detection and Configuration
# ============================================================================

{{ includeTemplate "log_step" "Detecting NVIDIA GPU..." }}

if ! lspci | grep -i 'vga\|3d\|display' | grep -iq nvidia; then
    {{ includeTemplate "log_warning" "No NVIDIA GPU detected" }}
    {{ includeTemplate "log_skip" "Skipping GPU acceleration" }}
else
    {{ includeTemplate "log_success" "NVIDIA GPU detected" }}

    # Enable Parakeet (CUDA-based, faster than Whisper)
    {{ includeTemplate "log_step" "Enabling Parakeet engine..." }}

    if [ -d /opt/cuda ]; then
        voxtype setup parakeet --enable
        {{ includeTemplate "log_success" "Parakeet engine enabled (CUDA)" }}
    else
        {{ includeTemplate "log_warning" "CUDA not found at /opt/cuda" }}
        {{ includeTemplate "log_info" "Falling back to Whisper with Vulkan..." }}
        sudo voxtype setup gpu --enable
        {{ includeTemplate "log_success" "Whisper GPU acceleration enabled (Vulkan)" }}
    fi
fi

# ============================================================================
# SECTION 3: Download STT Model
# ============================================================================

{{ includeTemplate "log_step" "Checking for STT model..." }}

VOXTYPE_DATA="$HOME/.local/share/voxtype"

if [ -d "$VOXTYPE_DATA" ] && [ "$(ls -A $VOXTYPE_DATA 2>/dev/null)" ]; then
    {{ includeTemplate "log_skip" "Model already downloaded" }}
else
    {{ includeTemplate "log_step" "Downloading STT model (this may take a moment)..." }}
    voxtype setup model
    {{ includeTemplate "log_success" "STT model downloaded" }}
fi

# ============================================================================
# SECTION 4: Enable Systemd User Service
# ============================================================================

{{ includeTemplate "log_step" "Enabling voxtype systemd service..." }}

systemctl --user daemon-reload
systemctl --user enable --now voxtype

if systemctl --user is-active --quiet voxtype; then
    {{ includeTemplate "log_success" "Voxtype service running" }}
else
    {{ includeTemplate "log_warning" "Voxtype service not active" }}
    {{ includeTemplate "log_info" "Check status: systemctl --user status voxtype" }}
fi

# ============================================================================
# FINAL SUMMARY
# ============================================================================

echo ""
echo "════════════════════════════════════════════════════════════════"
echo "  Voxtype Setup Complete"
echo "════════════════════════════════════════════════════════════════"
echo ""
echo "  Usage: Hold Super+T, speak, release"
echo "  Text appears in clipboard - paste with Ctrl+V"
echo ""

if ! id -nG {{ $username }} | grep -qw input; then
    echo "  NOTE: Logout/login required for input group membership"
    echo ""
fi

{{ includeTemplate "log_complete" "Voxtype configuration finished" }}
