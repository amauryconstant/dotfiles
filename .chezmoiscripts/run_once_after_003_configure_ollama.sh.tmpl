#!/bin/sh

# Script: run_once_after_003_configure_ollama.sh.tmpl
# Purpose: Configure Ollama service based on destination configuration
# Requirements: Arch Linux, ollama

{{ if eq .osId "linux-arch" }}
    {{- $destinationConfig := index .destinations .destination }}
    
    echo "Configuring Ollama service..."
    
    # Check if ollama should be enabled for this destination
    {{- if has "ollama" $destinationConfig.services }}
    
    # Check if ollama is installed
    if ! command -v ollama >/dev/null 2>&1; then
        echo "Ollama not found, skipping configuration"
        exit 0
    fi
    
    echo "Enabling and starting Ollama service..."
    
    # Enable and start ollama user service
    systemctl --user enable ollama
    systemctl --user start ollama
    
    # Wait for service to be ready
    echo "Waiting for Ollama service to be ready..."
    sleep 5
    
    # Verify service is running
    if systemctl --user is-active ollama >/dev/null 2>&1; then
        echo "✓ Ollama service is running"
    else
        echo "WARNING: Ollama service may not be running properly"
    fi
    
    {{- else }}
    echo "Ollama service disabled for {{ .destination }} destination, skipping..."
    {{- end }}
    
    echo "✓ Ollama configuration completed"
    
{{ else }}
    echo "ERROR: Unsupported OS: {{ .osId }}"
    echo "This script requires: linux-arch"
    exit 1
{{ end }}
