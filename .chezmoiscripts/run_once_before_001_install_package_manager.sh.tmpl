#!/usr/bin/env sh

# Script: run_once_before_001_install_package_manager.sh.tmpl
# Purpose: Install and configure package managers (paru, Chaotic-AUR)
# Requirements: Arch Linux

{{ includeTemplate "log_start" "Setting up package managers for Arch Linux..." }}

set -euo pipefail

# Install paru if not already present
if ! command -v paru &> /dev/null; then
    {{ includeTemplate "log_step" "Installing paru AUR helper..." }}

    # Try pacman first (works if Chaotic-AUR already configured)
    if ! sudo pacman -S --needed --noconfirm paru 2>/dev/null; then
        # Build from AUR (source version for full features)
        sudo pacman -S --needed --noconfirm git base-devel
        BUILD_DIR=$(mktemp -d)
        git clone https://aur.archlinux.org/paru.git "$BUILD_DIR/paru"
        (cd "$BUILD_DIR/paru" && makepkg -si --noconfirm)
        rm -rf "$BUILD_DIR"
    fi
    {{ includeTemplate "log_success" "paru AUR helper installed" }}
else
    {{ includeTemplate "log_info" "paru already installed" }}
fi

# Enable multilib repository for 32-bit support
if ! grep -q "^\[multilib\]" /etc/pacman.conf; then
    {{ includeTemplate "log_step" "Enabling multilib repository..." }}
    sudo sed -i '/^#\[multilib\]/,/^#Include = \/etc\/pacman.d\/mirrorlist/ s/^#//' /etc/pacman.conf
    sudo pacman -Syuu --noconfirm
    {{ includeTemplate "log_success" "multilib repository enabled" }}
else
    {{ includeTemplate "log_info" "multilib already enabled" }}
fi

# Optimize mirrors for faster downloads
{{ includeTemplate "log_step" "Optimizing Arch mirrors..." }}
paru -S --noconfirm --needed rate-mirrors
rate-mirrors --protocol https arch | sudo tee /etc/pacman.d/mirrorlist
{{ includeTemplate "log_success" "Mirrors optimized" }}

# Setup Chaotic-AUR repository
if ! grep -q "chaotic-aur" /etc/pacman.conf; then
    {{ includeTemplate "log_step" "Setting up Chaotic-AUR repository..." }}

    sudo pacman-key --recv-key 3056513887B78AEB --keyserver keyserver.ubuntu.com
    sudo pacman-key --lsign-key 3056513887B78AEB
    sudo pacman -U --noconfirm \
        'https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-mirrorlist.pkg.tar.zst' \
        'https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-keyring.pkg.tar.zst'

    sudo tee -a /etc/pacman.conf > /dev/null << 'EOF'

# Chaotic-AUR repository
[chaotic-aur]
Include = /etc/pacman.d/chaotic-mirrorlist
EOF

    sudo pacman -Sy
    {{ includeTemplate "log_success" "Chaotic-AUR repository configured" }}
else
    {{ includeTemplate "log_info" "Chaotic-AUR already configured" }}
fi

# Setup Flatpak
{{ includeTemplate "log_step" "Setting up Flatpak..." }}
command -v flatpak &> /dev/null || sudo pacman -S --needed --noconfirm flatpak
flatpak remote-list | grep -q "flathub" || \
    sudo flatpak remote-add --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo
{{ includeTemplate "log_success" "Flatpak configured" }}

{{ includeTemplate "log_complete" "Package manager setup completed successfully" }}
