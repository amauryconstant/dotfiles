#!/usr/bin/env sh

# Script: run_onchange_after_install_ai_models.sh.tmpl
# Purpose: Install AI models for Arch Linux work environment
# Requirements: Arch Linux, ollama

# Hash: {{ .ai.models | toJson | sha256sum }}

{{ includeTemplate "log_start" "Installing AI models..." }}

# Set strict error handling
set -euo pipefail

# Check if ollama is installed and running
if ! command -v ollama >/dev/null 2>&1; then
    {{ includeTemplate "log_step" "Ollama not found, skipping AI model installation" }}
    exit 0
fi

# Check if ollama service is running
if ! systemctl is-active ollama >/dev/null 2>&1; then
    {{ includeTemplate "log_step" "Starting ollama service..." }}
    sudo systemctl start ollama
    sleep 5
fi

{{ includeTemplate "log_step" "Installing AI models..." }}

# Install each model from the external AI configuration
FAILED_MODELS=""
{{- range .ai.models }}
if ! ollama pull {{ . }} >/dev/null 2>&1; then
    FAILED_MODELS="${FAILED_MODELS}{{ . }}, "
fi
{{- end }}

if [ -n "$FAILED_MODELS" ]; then
    {{ includeTemplate "log_warning" "Some models failed: $FAILED_MODELS" }}
    {{ includeTemplate "log_warning" "Continuing with partial installation..." }}
fi

{{ includeTemplate "log_complete" "AI model installation finished" }}