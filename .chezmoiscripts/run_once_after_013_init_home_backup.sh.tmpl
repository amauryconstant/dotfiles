#!/usr/bin/env bash

# Script: run_once_after_013_init_home_backup.sh.tmpl
# Purpose: Initialize restic home backup repository if password is available
# Requirements: Arch Linux, restic (optional)

{{ includeTemplate "log_start" "Initialize home backup repository" }}

set -euo pipefail

PASSWORD_FILE="{{ .chezmoi.homeDir }}/.local/share/backups/.restic-password"
REPO="{{ .chezmoi.homeDir }}/.local/share/backups/home-backup"

# ============================================================================
# SECTION 1: PREFLIGHT CHECKS
# ============================================================================

{{ includeTemplate "log_step" "Check if restic is installed..." }}

if ! command -v restic >/dev/null 2>&1; then
    {{ includeTemplate "log_skip" "restic not installed — skipping home backup init" }}
    {{ includeTemplate "log_info" "To enable: add 'restic' to packages.yaml and run 'chezmoi apply'" }}
    {{ includeTemplate "log_complete" "Home backup init skipped" }}
    exit 0
fi

{{ includeTemplate "log_success" "restic is installed" }}

{{ includeTemplate "log_step" "Check if password file is available..." }}

if [[ ! -f "$PASSWORD_FILE" ]]; then
    {{ includeTemplate "log_skip" "Password file not found at $PASSWORD_FILE — skipping init" }}
    {{ includeTemplate "log_info" "The encrypted password was not decrypted (missing age key?)" }}
    {{ includeTemplate "log_info" "To initialize manually: home-backup init" }}
    {{ includeTemplate "log_complete" "Home backup init skipped" }}
    exit 0
fi

{{ includeTemplate "log_success" "Password file found" }}

{{ includeTemplate "log_step" "Check if repository already initialized..." }}

if [[ -d "$REPO" ]]; then
    {{ includeTemplate "log_skip" "Repository already exists at $REPO — skipping init" }}
    {{ includeTemplate "log_complete" "Home backup already initialized" }}
    exit 0
fi

# ============================================================================
# SECTION 2: INITIALIZE REPOSITORY
# ============================================================================

{{ includeTemplate "log_step" "Initializing home backup repository..." }}

home-backup init --non-interactive

{{ includeTemplate "log_success" "Repository initialized at $REPO" }}

{{ includeTemplate "log_info" "" }}
{{ includeTemplate "log_info" "Home backup is ready:" }}
{{ includeTemplate "log_info" "  Repository: $REPO" }}
{{ includeTemplate "log_info" "  Password:   $PASSWORD_FILE" }}
{{ includeTemplate "log_info" "  Schedule:   daily at 2am (home-backup.timer)" }}
{{ includeTemplate "log_info" "  Manual run: home-backup backup" }}
{{ includeTemplate "log_info" "" }}

{{ includeTemplate "log_complete" "Home backup initialized successfully" }}
