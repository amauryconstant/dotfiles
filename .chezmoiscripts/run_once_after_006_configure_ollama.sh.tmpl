#!/bin/sh

# Script: run_once_after_005_configure_ollama.sh.tmpl
# Purpose: Configure Ollama service based on destination configuration
# Requirements: Arch Linux, ollama

{{ includeTemplate "log_start" "Configuring Ollama service..." }}

# Set strict error handling
set -euo pipefail

# Check if ollama is installed
if ! command -v ollama >/dev/null 2>&1; then
    {{ includeTemplate "log_step" "Ollama not found, skipping configuration" }}
    exit 0
fi

{{ includeTemplate "log_step" "Installing Ollama service file..." }}
# Copy ollama service file to system location
sudo cp "{{ .chezmoi.sourceDir }}/.data/ollama.service" /etc/systemd/system/ollama.service

# Reload systemd daemon
sudo systemctl daemon-reload

{{ includeTemplate "log_step" "Enabling and starting Ollama service..." }}

# Enable and start ollama system service
sudo systemctl enable ollama
sudo systemctl start ollama

# Wait for service to be ready
{{ includeTemplate "log_step" "Waiting for Ollama service to be ready..." }}
sleep 5

# Verify service is running
if systemctl is-active ollama >/dev/null 2>&1; then
    {{ includeTemplate "log_success" "Ollama service is running" }}
else
    {{ includeTemplate "log_error" "Ollama service may not be running properly" }}
    exit 1
fi

{{ includeTemplate "log_complete" "Ollama configuration completed" }}