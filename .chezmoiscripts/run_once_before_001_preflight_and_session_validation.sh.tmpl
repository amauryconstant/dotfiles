#!/usr/bin/env bash

# Script: run_once_before_001_preflight_and_session_validation.sh.tmpl
# Purpose: Consolidated preflight checks and Hyprland session validation
# Requirements: Arch Linux base system
# Execution: Runs BEFORE file application and package installation
#
# This script consolidates:
# - System prerequisites (sudo, commands, internet, package manager)
# - GPU detection and driver migration checks
# - Wayland environment validation
# - Theme and font dependencies
#
# Benefits of consolidation:
# - Single validation pass before installation
# - Early failure detection
# - Clear dependency chain

{{ includeTemplate "log_start" "Running preflight checks and session validation..." }}

set -euo pipefail

PREFLIGHT_FAILED=false

# ============================================================================
# SECTION 1: SUDO PRIVILEGES
# ============================================================================

echo ""
echo "════════════════════════════════════════════════════════════════"
echo "  SECTION 1: System Prerequisites"
echo "════════════════════════════════════════════════════════════════"
echo ""

{{ includeTemplate "log_step" "Verifying sudo privileges..." }}

if sudo -v >/dev/null 2>&1; then
    {{ includeTemplate "log_success" "User has sudo privileges" }}
else
    {{ includeTemplate "log_error" "User does not have sudo privileges" }}
    {{ includeTemplate "log_info" "Fix: Add user to wheel group and configure /etc/sudoers" }}
    {{ includeTemplate "log_info" "  1. sudo usermod -aG wheel $USER" }}
    {{ includeTemplate "log_info" "  2. sudo visudo (uncomment %wheel line)" }}
    PREFLIGHT_FAILED=true
fi

# ============================================================================
# SECTION 2: CRITICAL SYSTEM COMMANDS
# ============================================================================

{{ includeTemplate "log_step" "Verifying critical system commands..." }}

REQUIRED_COMMANDS="sudo git systemctl"
MISSING_COMMANDS=""

for cmd in $REQUIRED_COMMANDS; do
    if ! command -v "$cmd" >/dev/null 2>&1; then
        {{ includeTemplate "log_warning" "Required command not found: $cmd" }}
        MISSING_COMMANDS="$MISSING_COMMANDS $cmd"
    fi
done

if [ -z "$MISSING_COMMANDS" ]; then
    {{ includeTemplate "log_success" "All critical commands available: $REQUIRED_COMMANDS" }}
else
    {{ includeTemplate "log_step" "Attempting to install missing packages..." }}

    if sudo pacman -S --needed --noconfirm base base-devel git 2>&1 | grep -v "warning: "; then
        {{ includeTemplate "log_success" "Package installation completed" }}

        STILL_MISSING=""
        for cmd in $REQUIRED_COMMANDS; do
            if ! command -v "$cmd" >/dev/null 2>&1; then
                STILL_MISSING="$STILL_MISSING $cmd"
            fi
        done

        if [ -n "$STILL_MISSING" ]; then
            {{ includeTemplate "log_error" "Commands still missing after installation:$STILL_MISSING" }}
            {{ includeTemplate "log_info" "Fix: Install manually with: sudo pacman -S base base-devel git" }}
            PREFLIGHT_FAILED=true
        else
            {{ includeTemplate "log_success" "All critical commands now available: $REQUIRED_COMMANDS" }}
        fi
    else
        {{ includeTemplate "log_error" "Failed to install missing packages" }}
        {{ includeTemplate "log_info" "Fix: Install manually with: sudo pacman -S base base-devel git" }}
        PREFLIGHT_FAILED=true
    fi
fi

# ============================================================================
# SECTION 3: INTERNET CONNECTIVITY
# ============================================================================

{{ includeTemplate "log_step" "Verifying internet connectivity..." }}

if ping -c 1 -W 5 archlinux.org >/dev/null 2>&1; then
    {{ includeTemplate "log_success" "Internet connectivity verified (archlinux.org reachable)" }}
elif ping -c 1 -W 5 8.8.8.8 >/dev/null 2>&1; then
    {{ includeTemplate "log_warning" "Network accessible but DNS may have issues" }}
    {{ includeTemplate "log_info" "Can reach 8.8.8.8 but not archlinux.org" }}
    {{ includeTemplate "log_info" "Check DNS configuration in /etc/resolv.conf" }}
else
    {{ includeTemplate "log_error" "No internet connectivity detected" }}
    {{ includeTemplate "log_info" "Fix: Verify network connection" }}
    {{ includeTemplate "log_info" "  - Check network cable or WiFi connection" }}
    {{ includeTemplate "log_info" "  - Verify NetworkManager: systemctl status NetworkManager" }}
    {{ includeTemplate "log_info" "  - Test manually: ping 8.8.8.8" }}
    PREFLIGHT_FAILED=true
fi

# ============================================================================
# SECTION 4: PACKAGE MANAGER AVAILABILITY
# ============================================================================

{{ includeTemplate "log_step" "Verifying package manager..." }}

if command -v pacman >/dev/null 2>&1; then
    {{ includeTemplate "log_success" "pacman package manager available" }}

    if [ -f /var/lib/pacman/db.lck ]; then
        {{ includeTemplate "log_warning" "pacman database is locked" }}
        {{ includeTemplate "log_info" "Another package operation may be in progress" }}
        {{ includeTemplate "log_info" "If stuck, remove lock: sudo rm /var/lib/pacman/db.lck" }}
    fi
else
    {{ includeTemplate "log_error" "pacman not found - not an Arch Linux system?" }}
    PREFLIGHT_FAILED=true
fi

# ============================================================================
# SECTION 5: NVIDIA GPU DETECTION
# ============================================================================

echo ""
echo "════════════════════════════════════════════════════════════════"
echo "  SECTION 5: GPU Detection and Driver Migration"
echo "════════════════════════════════════════════════════════════════"
echo ""

{{ includeTemplate "log_step" "Checking for NVIDIA GPU..." }}

if lspci | grep -i nvidia >/dev/null 2>&1; then
{{- $gpuName := .nvidiaGpuDetected | default "unknown" }}
    {{ includeTemplate "log_info" (printf "NVIDIA GPU detected: %s" $gpuName) }}
    {{ includeTemplate "log_info" (printf "Driver type selected: %s" .nvidiaDriverType) }}

    if lspci -k | grep -A 3 -i "VGA\|3D" | grep -qi "nouveau"; then
        {{ includeTemplate "log_warning" "Nouveau drivers currently active (archinstall default)" }}
        {{ includeTemplate "log_info" "Proprietary NVIDIA drivers will be installed during package sync" }}
        {{ includeTemplate "log_info" "Reboot after package installation to load proprietary drivers" }}
    else
        {{ includeTemplate "log_info" "Proprietary NVIDIA drivers active" }}

        if ! modinfo nvidia >/dev/null 2>&1; then
            {{ includeTemplate "log_warning" "NVIDIA kernel module not loaded" }}
            {{ includeTemplate "log_info" "May need reboot or module build with: sudo dkms autoinstall" }}
        fi
    fi

    {{ includeTemplate "log_step" "Checking for driver migration..." }}
    CURRENT_DRIVER=""
    if pacman -Q nvidia-open >/dev/null 2>&1; then
        CURRENT_DRIVER="modern"
    elif pacman -Q nvidia-580xx-dkms >/dev/null 2>&1; then
        CURRENT_DRIVER="legacy"
    fi

    TARGET_DRIVER="{{ .nvidiaDriverType }}"

    if [ -n "$CURRENT_DRIVER" ] && [ "$CURRENT_DRIVER" != "$TARGET_DRIVER" ]; then
        echo ""
        echo "════════════════════════════════════════════════════════════════"
        echo "  ⚠️  NVIDIA DRIVER MIGRATION DETECTED"
        echo "════════════════════════════════════════════════════════════════"
        echo ""
        echo "  Current driver: $CURRENT_DRIVER"
        echo "  Target driver:  $TARGET_DRIVER"
        echo ""
        echo "  Detected GPU: {{ .nvidiaGpuDetected | default "unknown" }}"
        echo ""
        echo "  This migration will:"
        if [ "$CURRENT_DRIVER" = "modern" ]; then
            echo "    1. Remove nvidia-open, nvidia-open-lts, nvidia-utils, lib32-nvidia-utils"
            echo "    2. Install nvidia-580xx-dkms, nvidia-580xx-utils, lib32-nvidia-580xx-utils"
        else
            echo "    1. Remove nvidia-580xx-dkms, nvidia-580xx-utils, lib32-nvidia-580xx-utils"
            echo "    2. Install nvidia-open, nvidia-open-lts, nvidia-utils, lib32-nvidia-utils"
        fi
        echo "    3. Require reboot to activate new drivers"
        echo ""
        echo "  Safety recommendations:"
        echo "    • Ensure you have alternate access (SSH/TTY)"
        echo "    • Close all GPU-intensive applications"
        echo "    • Save all work before proceeding"
        echo ""
        echo "  NOTE: Will auto-proceed with migration after 60 seconds if no response"
        echo ""
        echo "════════════════════════════════════════════════════════════════"
        echo ""

        if read -t 60 -p "  Continue with driver migration? [y/N] " -n 1 -r; then
            echo ""
            if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                {{ includeTemplate "log_error" "Driver migration cancelled by user" }}
                exit 1
            fi
        else
            echo ""
            {{ includeTemplate "log_warning" "⏱️  Timeout reached - defaulting to 'No' (safe option)" }}
            {{ includeTemplate "log_error" "Driver migration cancelled (timeout)" }}
            {{ includeTemplate "log_info" "To force migration: export NVIDIA_DRIVER_OVERRIDE=$TARGET_DRIVER && chezmoi apply" }}
            exit 1
        fi

        {{ includeTemplate "log_warning" "Proceeding with driver migration..." }}
    else
        {{ includeTemplate "log_success" "No driver migration needed" }}
    fi
fi

if lspci | grep -i "intel.*graphics" >/dev/null 2>&1; then
    {{ includeTemplate "log_info" "Intel GPU detected (uses mesa - built-in)" }}
fi

# ============================================================================
# SECTION 6: WAYLAND SESSION REQUIREMENTS
# ============================================================================

echo ""
echo "════════════════════════════════════════════════════════════════"
echo "  SECTION 6: Wayland Environment"
echo "════════════════════════════════════════════════════════════════"
echo ""

{{ includeTemplate "log_step" "Verifying Wayland environment setup..." }}

if ! command -v seatd >/dev/null 2>&1 && ! systemctl is-active --quiet systemd-logind; then
    {{ includeTemplate "log_warning" "Neither seatd nor systemd-logind active" }}
    {{ includeTemplate "log_info" "Wayland needs seat management for input devices" }}
    {{ includeTemplate "log_info" "Systemd-logind should be active by default" }}
fi

if [ -z "${XDG_RUNTIME_DIR:-}" ]; then
    {{ includeTemplate "log_error" "XDG_RUNTIME_DIR not set" }}
    {{ includeTemplate "log_info" "Required for Wayland socket creation" }}
    {{ includeTemplate "log_info" "Should be set by display manager (SDDM)" }}
    PREFLIGHT_FAILED=true
else
    {{ includeTemplate "log_success" "XDG_RUNTIME_DIR configured: $XDG_RUNTIME_DIR" }}
fi

# ============================================================================
# SECTION 7: CRITICAL SYSTEM SERVICES
# ============================================================================

{{ includeTemplate "log_step" "Verifying critical system services..." }}

if ! systemctl --user is-active --quiet dbus.service 2>/dev/null; then
    {{ includeTemplate "log_warning" "User D-Bus session not active" }}
    {{ includeTemplate "log_info" "Required for application communication" }}
    {{ includeTemplate "log_info" "Should start automatically with graphical session" }}
fi

if command -v pipewire >/dev/null 2>&1; then
    if ! systemctl --user is-active --quiet pipewire.service 2>/dev/null; then
        {{ includeTemplate "log_info" "PipeWire installed but not running" }}
        {{ includeTemplate "log_info" "Audio may not work until service starts" }}
    fi
fi

# ============================================================================
# SECTION 8: THEME SYSTEM DEPENDENCIES
# ============================================================================

echo ""
echo "════════════════════════════════════════════════════════════════"
echo "  SECTION 8: Theme and Font Dependencies"
echo "════════════════════════════════════════════════════════════════"
echo ""

{{ includeTemplate "log_step" "Verifying theme system requirements..." }}

THEME_DEPS="jq"
THEME_MISSING=""

for dep in $THEME_DEPS; do
    if ! command -v "$dep" >/dev/null 2>&1; then
        {{ includeTemplate "log_warning" "Missing theme dependency: $dep" }}
        THEME_MISSING="$THEME_MISSING $dep"
    fi
done

if [ -z "$THEME_MISSING" ]; then
    {{ includeTemplate "log_success" "Theme system dependencies available" }}
else
    {{ includeTemplate "log_step" "Attempting to install theme dependencies..." }}
    if sudo pacman -S --needed --noconfirm $THEME_DEPS 2>&1 | grep -v "warning: "; then
        {{ includeTemplate "log_success" "Theme dependencies installed successfully" }}
    else
        {{ includeTemplate "log_warning" "Failed to install theme dependencies" }}
        {{ includeTemplate "log_info" "Theme switching may not work until manually installed: sudo pacman -S $THEME_DEPS" }}
    fi
fi

# ============================================================================
# SECTION 9: FONT DEPENDENCIES
# ============================================================================

{{ includeTemplate "log_step" "Verifying font packages..." }}

FONT_PACKAGES="noto-fonts noto-fonts-emoji"
FONT_MISSING=""

for font in $FONT_PACKAGES; do
    if ! pacman -Q "$font" >/dev/null 2>&1; then
        {{ includeTemplate "log_warning" "Missing font package: $font" }}
        FONT_MISSING="$FONT_MISSING $font"
    fi
done

if [ -z "$FONT_MISSING" ]; then
    {{ includeTemplate "log_success" "Critical fonts installed" }}
else
    {{ includeTemplate "log_step" "Attempting to install missing fonts..." }}
    if sudo pacman -S --needed --noconfirm $FONT_MISSING 2>&1 | grep -v "warning: "; then
        {{ includeTemplate "log_success" "Fonts installed successfully" }}
    else
        {{ includeTemplate "log_warning" "Failed to install fonts" }}
        {{ includeTemplate "log_info" "UI may have rendering issues until manually installed: sudo pacman -S $FONT_MISSING" }}
    fi
fi

# ============================================================================
# SECTION 10: GNOME KEYRING (WiFi credentials)
# ============================================================================

{{ includeTemplate "log_step" "Verifying credential storage..." }}

if ! pacman -Q gnome-keyring >/dev/null 2>&1; then
    {{ includeTemplate "log_warning" "gnome-keyring not installed" }}
    {{ includeTemplate "log_step" "Attempting to install gnome-keyring..." }}
    if sudo pacman -S --needed --noconfirm gnome-keyring 2>&1 | grep -v "warning: "; then
        {{ includeTemplate "log_success" "gnome-keyring installed successfully" }}
        {{ includeTemplate "log_info" "WiFi password storage now available" }}
    else
        {{ includeTemplate "log_warning" "Failed to install gnome-keyring" }}
        {{ includeTemplate "log_info" "WiFi password storage unavailable until manually installed: sudo pacman -S gnome-keyring" }}
    fi
else
    {{ includeTemplate "log_success" "gnome-keyring installed" }}
fi

# ============================================================================
# VALIDATION SUMMARY
# ============================================================================

echo ""
echo "════════════════════════════════════════════════════════════════"
echo "  Preflight and Session Validation Summary"
echo "════════════════════════════════════════════════════════════════"
echo ""

if [ "$PREFLIGHT_FAILED" = true ]; then
    {{ includeTemplate "log_error" "❌ VALIDATION FAILED - Fix issues above before proceeding" }}
    echo ""
    echo "  Critical issues detected. Installation cannot continue."
    echo "  Review error messages above and fix the problems."
    echo ""
    echo "  Common fixes:"
    echo "    1. Ensure desktop_hyprland module enabled in packages.yaml"
    echo "    2. Run package sync: package-manager sync"
    echo "    3. Reboot after driver installation"
    echo "    4. Enable SDDM: sudo systemctl enable sddm"
    echo ""
    echo "  After fixing issues, run: chezmoi apply"
    echo ""
    echo "════════════════════════════════════════════════════════════════"
    echo ""
    exit 1
else
    {{ includeTemplate "log_success" "✅ ALL VALIDATION CHECKS PASSED" }}
    echo ""
    echo "  System prerequisites verified:"
    echo "    ✓ Sudo privileges available"
    echo "    ✓ Critical commands present (sudo, git, systemctl)"
    echo "    ✓ Internet connectivity confirmed"
    echo "    ✓ Package manager ready"
    echo ""
    echo "  Session requirements verified:"
    echo "    ✓ Graphics drivers available"
    echo "    ✓ Wayland environment configured"
    echo "    ✓ Critical services present"
    echo ""

    if [ -n "${THEME_MISSING:-}" ] || [ -n "${FONT_MISSING:-}" ]; then
        echo "  ⚠ Non-critical warnings detected (see above)"
        echo "    Session will work but some features may be limited"
        echo ""
    fi

    echo "  Safe to proceed with installation."
    echo ""
    echo "════════════════════════════════════════════════════════════════"
    echo ""
fi

{{ includeTemplate "log_complete" "Preflight and session validation completed successfully" }}
