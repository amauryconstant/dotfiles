#!/usr/bin/env sh

# Script: run_once_before_007_configure_gpu_drivers.sh.tmpl
# Purpose: Configure GPU drivers (NVIDIA DKMS) with Wayland support
# Requirements: Arch Linux, nvidia-open-dkms, DKMS, kernel headers
# Execution: Runs BEFORE file application to configure GPU drivers early

{{ includeTemplate "log_start" "Configure GPU drivers for Wayland" }}

# Set strict error handling
set -euo pipefail

# Add error trap for cleanup guidance
trap 'echo ""; {{ includeTemplate "log_error" "Script failed - check logs above for details" }}; echo ""; echo "To rollback changes:"; echo "  1. Restore cmdline backup: sudo cp /etc/kernel/cmdline.backup /etc/kernel/cmdline 2>/dev/null || true"; echo "  2. Remove NVIDIA config: sudo rm /etc/mkinitcpio.conf.d/nvidia.conf 2>/dev/null || true"; echo "  3. Rebuild initramfs: sudo mkinitcpio -P"; echo "  4. Remove packages: yay -Rdd --noconfirm nvidia-open-dkms nvidia-utils lib32-nvidia-utils 2>/dev/null || true"; exit 1' ERR

{{ includeTemplate "log_step" "Detect GPU vendor" }}

# Detect GPU using lspci
GPU_VENDOR=$(lspci | grep -i 'vga\|3d\|display' | grep -i nvidia)

if [ -z "$GPU_VENDOR" ]; then
    {{ includeTemplate "log_skip" "No NVIDIA GPU detected - skipping NVIDIA configuration" }}
    exit 0
fi

{{ includeTemplate "log_info" "NVIDIA GPU detected: $GPU_VENDOR" }}

{{ includeTemplate "log_step" "Clean up conflicting NVIDIA packages" }}

# Remove conflicting/old NVIDIA packages that may interfere
CONFLICTING_PACKAGES=(
    "nvidia-utils"
    "lib32-nvidia-utils"
    "nvidia"
    "nvidia-lts"
    "nvidia-dkms"
)

PACKAGES_TO_REMOVE=()
for pkg in "${CONFLICTING_PACKAGES[@]}"; do
    if pacman -Q "$pkg" >/dev/null 2>&1; then
        PACKAGES_TO_REMOVE+=("$pkg")
    fi
done

if [ ${#PACKAGES_TO_REMOVE[@]} -gt 0 ]; then
    {{ includeTemplate "log_info" "Removing ${#PACKAGES_TO_REMOVE[@]} conflicting package(s): ${PACKAGES_TO_REMOVE[*]}" }}

    # Remove using strongest available method
    if command -v yay >/dev/null 2>&1; then
        yay -Rdd --noconfirm "${PACKAGES_TO_REMOVE[@]}" || true
    else
        sudo pacman -Rdd --noconfirm "${PACKAGES_TO_REMOVE[@]}" || true
    fi

    {{ includeTemplate "log_success" "Conflict removal completed" }}
else
    {{ includeTemplate "log_success" "No conflicting packages found" }}
fi

{{ includeTemplate "log_step" "Install NVIDIA DKMS packages and dependencies" }}

# Define required packages (order matters: dependencies first)
NVIDIA_PACKAGES=(
    "dkms"                    # DKMS framework (must be installed first)
    "linux-headers"           # Headers for current kernel
    "linux-lts-headers"       # Headers for LTS kernel
    "nvidia-open-dkms"        # NVIDIA kernel modules (depends on dkms + headers)
    "nvidia-utils"            # NVIDIA userspace utilities
    "nvidia-settings"         # NVIDIA configuration GUI
    "lib32-nvidia-utils"      # 32-bit support (depends on nvidia-utils)
    "libva-nvidia-driver"     # VA-API hardware video acceleration
)

# Check which packages need to be installed
PACKAGES_TO_INSTALL=()
for pkg in "${NVIDIA_PACKAGES[@]}"; do
    if ! pacman -Q "$pkg" >/dev/null 2>&1; then
        PACKAGES_TO_INSTALL+=("$pkg")
    fi
done

# Install missing packages
if [ ${#PACKAGES_TO_INSTALL[@]} -gt 0 ]; then
    {{ includeTemplate "log_info" "Installing ${#PACKAGES_TO_INSTALL[@]} package(s): ${PACKAGES_TO_INSTALL[*]}" }}

    # Use yay if available (for AUR packages), otherwise use pacman
    # --overwrite '*' handles file conflicts from removed packages
    if command -v yay >/dev/null 2>&1; then
        yay -S --needed --noconfirm --overwrite '*' "${PACKAGES_TO_INSTALL[@]}"
    else
        sudo pacman -S --needed --noconfirm --overwrite '*' "${PACKAGES_TO_INSTALL[@]}"
    fi

    {{ includeTemplate "log_success" "NVIDIA packages installed successfully" }}
else
    {{ includeTemplate "log_success" "All NVIDIA packages already installed" }}
fi

{{ includeTemplate "log_step" "Check DKMS module status" }}

# Check if DKMS modules are built for current kernel
KERNEL_VERSION=$(uname -r)
{{ includeTemplate "log_info" "Running kernel: $KERNEL_VERSION" }}

if sudo dkms status nvidia-open | grep -q "$KERNEL_VERSION"; then
    {{ includeTemplate "log_success" "NVIDIA DKMS modules already built for current kernel" }}
else
    {{ includeTemplate "log_info" "Building NVIDIA DKMS modules for current kernel..." }}

    if sudo dkms autoinstall; then
        {{ includeTemplate "log_success" "NVIDIA DKMS modules built successfully" }}
    else
        {{ includeTemplate "log_error" "DKMS module build failed - manual intervention required" }}
        exit 1
    fi
fi

{{ includeTemplate "log_step" "Configure initramfs NVIDIA modules" }}

# Create mkinitcpio configuration directory
sudo mkdir -p /etc/mkinitcpio.conf.d

# Check if initramfs configuration already exists and is correct
INITRAMFS_CHANGED=false
NVIDIA_CONF="/etc/mkinitcpio.conf.d/nvidia.conf"

if [ -f "$NVIDIA_CONF" ]; then
    # Check if existing file has correct content (flexible whitespace handling)
    # Must include i915 for hybrid graphics
    if grep -Eq "^MODULES=\(i915 nvidia nvidia_modeset nvidia_uvm nvidia_drm\)\s*$" "$NVIDIA_CONF"; then
        {{ includeTemplate "log_success" "Initramfs NVIDIA configuration already correct" }}
    else
        {{ includeTemplate "log_info" "Updating initramfs NVIDIA configuration..." }}
        INITRAMFS_CHANGED=true
    fi
else
    {{ includeTemplate "log_info" "Creating initramfs NVIDIA configuration..." }}
    INITRAMFS_CHANGED=true
fi

# Create/update NVIDIA-specific module configuration only if needed
if [ "$INITRAMFS_CHANGED" = true ]; then
    # CRITICAL: With DKMS, we KEEP 'kms' in HOOKS (early kernel mode setting)
    # CRITICAL: On hybrid graphics (Intel + NVIDIA), load i915 BEFORE nvidia modules
    #           This prevents Electron/Chromium apps from stalling ~1min after boot
    sudo tee "$NVIDIA_CONF" > /dev/null <<EOF
# NVIDIA DKMS module configuration
# These modules enable early kernel mode setting (KMS) for NVIDIA GPUs
# IMPORTANT: DO NOT remove 'kms' from HOOKS when using DKMS
# IMPORTANT: i915 loaded first to prevent Electron/Chromium stalling on hybrid graphics
MODULES=(i915 nvidia nvidia_modeset nvidia_uvm nvidia_drm)
EOF
    {{ includeTemplate "log_success" "Created/updated $NVIDIA_CONF" }}
fi

{{ includeTemplate "log_step" "Rebuild initramfs for all installed kernels" }}

# Rebuild initramfs only if configuration changed
if [ "$INITRAMFS_CHANGED" = true ]; then
    {{ includeTemplate "log_info" "Rebuilding initramfs to include NVIDIA modules..." }}
    sudo mkinitcpio -P
    {{ includeTemplate "log_success" "Initramfs rebuilt with NVIDIA modules" }}
else
    {{ includeTemplate "log_skip" "Initramfs already up to date - skipping rebuild" }}
fi

{{ includeTemplate "log_step" "Configure kernel parameters for Unified Kernel Images (UKI)" }}

# Check if system uses UKI (Unified Kernel Images) or traditional boot entries
CMDLINE_FILE="/etc/kernel/cmdline"
UKI_REBUILD_NEEDED=false

if [ -f "$CMDLINE_FILE" ]; then
    {{ includeTemplate "log_info" "System uses Unified Kernel Images (UKI)" }}
    {{ includeTemplate "log_info" "Kernel parameters stored in: $CMDLINE_FILE" }}

    # Check if NVIDIA kernel parameters are already present
    NEEDS_MODESET=false
    NEEDS_FBDEV=false
    NEEDS_PRESERVE_VIDEO_MEM=false

    if ! grep -q "nvidia-drm.modeset=1" "$CMDLINE_FILE"; then
        NEEDS_MODESET=true
    fi
    if ! grep -q "nvidia-drm.fbdev=1" "$CMDLINE_FILE"; then
        NEEDS_FBDEV=true
    fi
    if ! grep -q "nvidia.NVreg_PreserveVideoMemoryAllocations=1" "$CMDLINE_FILE"; then
        NEEDS_PRESERVE_VIDEO_MEM=true
    fi

    if [ "$NEEDS_MODESET" = false ] && [ "$NEEDS_FBDEV" = false ] && [ "$NEEDS_PRESERVE_VIDEO_MEM" = false ]; then
        {{ includeTemplate "log_success" "NVIDIA kernel parameters already configured" }}
    else
        {{ includeTemplate "log_info" "Adding NVIDIA kernel parameters to kernel command line..." }}

        # Create backup only if it doesn't already exist
        if [ ! -f "${CMDLINE_FILE}.backup" ]; then
            sudo cp "$CMDLINE_FILE" "${CMDLINE_FILE}.backup"
            {{ includeTemplate "log_info" "Created backup: ${CMDLINE_FILE}.backup" }}
        fi

        # Read current cmdline
        CURRENT_CMDLINE=$(cat "$CMDLINE_FILE")

        # Add parameters only if missing
        if [ "$NEEDS_MODESET" = true ]; then
            CURRENT_CMDLINE="$CURRENT_CMDLINE nvidia-drm.modeset=1"
        fi
        if [ "$NEEDS_FBDEV" = true ]; then
            CURRENT_CMDLINE="$CURRENT_CMDLINE nvidia-drm.fbdev=1"
        fi
        if [ "$NEEDS_PRESERVE_VIDEO_MEM" = true ]; then
            CURRENT_CMDLINE="$CURRENT_CMDLINE nvidia.NVreg_PreserveVideoMemoryAllocations=1"
        fi

        # Write updated cmdline
        echo "$CURRENT_CMDLINE" | sudo tee "$CMDLINE_FILE" > /dev/null

        {{ includeTemplate "log_success" "NVIDIA kernel parameters added to $CMDLINE_FILE" }}
        UKI_REBUILD_NEEDED=true
    fi
else
    # Fallback: Check for traditional systemd-boot entries
    {{ includeTemplate "log_info" "Checking for traditional systemd-boot entries..." }}
    BOOT_ENTRIES=$(find /boot/loader/entries -name "*.conf" 2>/dev/null | head -1)

    if [ -z "$BOOT_ENTRIES" ]; then
        {{ includeTemplate "log_error" "No boot configuration found (neither UKI nor traditional entries)" }}
        {{ includeTemplate "log_info" "Manual configuration required: Add 'nvidia-drm.modeset=1 nvidia-drm.fbdev=1' to kernel parameters" }}
        exit 1
    fi

    {{ includeTemplate "log_info" "Found traditional boot entry: $BOOT_ENTRIES" }}

    # Check if kernel parameters are already present
    if grep -q "nvidia-drm.modeset=1" "$BOOT_ENTRIES" && grep -q "nvidia-drm.fbdev=1" "$BOOT_ENTRIES"; then
        {{ includeTemplate "log_success" "NVIDIA kernel parameters already configured" }}
    else
        {{ includeTemplate "log_info" "Adding NVIDIA kernel parameters to boot entry..." }}

        # Create backup only if it doesn't already exist
        if [ ! -f "${BOOT_ENTRIES}.backup" ]; then
            sudo cp "$BOOT_ENTRIES" "${BOOT_ENTRIES}.backup"
            {{ includeTemplate "log_info" "Created backup: ${BOOT_ENTRIES}.backup" }}
        fi

        # Add NVIDIA parameters to options line
        if ! grep -q "nvidia-drm.modeset=1" "$BOOT_ENTRIES"; then
            sudo sed -i '/^options/ s/$/ nvidia-drm.modeset=1/' "$BOOT_ENTRIES"
        fi
        if ! grep -q "nvidia-drm.fbdev=1" "$BOOT_ENTRIES"; then
            sudo sed -i '/^options/ s/$/ nvidia-drm.fbdev=1/' "$BOOT_ENTRIES"
        fi

        {{ includeTemplate "log_success" "NVIDIA kernel parameters added" }}
    fi
fi

# Rebuild UKI images if kernel parameters changed
if [ "$UKI_REBUILD_NEEDED" = true ]; then
    {{ includeTemplate "log_step" "Rebuild Unified Kernel Images with updated kernel parameters" }}
    {{ includeTemplate "log_info" "Regenerating UKI files to include NVIDIA kernel parameters..." }}
    sudo mkinitcpio -P
    {{ includeTemplate "log_success" "UKI files regenerated with NVIDIA kernel parameters" }}
fi

{{ includeTemplate "log_step" "Verify configuration" }}

# Display current configuration status
{{ includeTemplate "log_info" "DKMS status:" }}
sudo dkms status nvidia-open || {{ includeTemplate "log_info" "DKMS not yet initialized" }}

{{ includeTemplate "log_info" "Currently loaded NVIDIA modules:" }}
if lsmod | grep -q nvidia; then
    lsmod | grep nvidia
    {{ includeTemplate "log_info" "⚠️  Running modules may be outdated - reboot recommended" }}
else
    {{ includeTemplate "log_info" "No modules loaded (expected on first run - will load after reboot)" }}
fi

{{ includeTemplate "log_info" "Kernel parameters (effective after next boot):" }}
if [ -f "$CMDLINE_FILE" ]; then
    cat "$CMDLINE_FILE" | grep -o "nvidia[^ ]*" || echo "(no nvidia parameters found)"
elif [ -n "$BOOT_ENTRIES" ]; then
    grep "^options" "$BOOT_ENTRIES" | grep -o "nvidia[^ ]*" || echo "(no nvidia parameters found)"
fi

{{ includeTemplate "log_step" "Post-installation validation" }}

echo ""
echo "════════════════════════════════════════════════════════════════"
echo "  NVIDIA GPU Configuration Complete"
echo "════════════════════════════════════════════════════════════════"
echo ""
echo "  ⚠️  REBOOT REQUIRED for changes to take effect"
echo ""
echo "  After reboot, verify configuration:"
echo "  1. Check DRM modeset:"
echo "     cat /sys/module/nvidia_drm/parameters/modeset"
echo "     (should return: Y)"
echo ""
echo "  2. Test Hyprland session for stability"
echo ""
echo "════════════════════════════════════════════════════════════════"
echo ""

{{ includeTemplate "log_complete" "GPU driver configuration completed - REBOOT REQUIRED" }}
