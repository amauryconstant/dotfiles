#!/usr/bin/env bash

# Script: run_once_after_008_configure_timeshift_retention.sh.tmpl
# Purpose: Configure Timeshift automatic snapshot retention policy
# Requirements: Arch Linux, Timeshift (optional), yq

{{ includeTemplate "log_start" "Configure Timeshift retention policy" }}

set -euo pipefail

# ============================================================================
# SECTION 1: PREFLIGHT CHECKS
# ============================================================================

{{ includeTemplate "log_step" "Check if Timeshift is installed..." }}

if ! command -v timeshift >/dev/null 2>&1; then
    {{ includeTemplate "log_skip" "Timeshift not installed - skipping configuration" }}
    {{ includeTemplate "log_info" "To enable backups: Install timeshift package and run 'chezmoi apply'" }}
    exit 0
fi

{{ includeTemplate "log_success" "Timeshift is installed" }}

{{ includeTemplate "log_step" "Check Timeshift configuration file..." }}

TIMESHIFT_CONFIG="/etc/timeshift/timeshift.json"

if [ ! -f "$TIMESHIFT_CONFIG" ]; then
    {{ includeTemplate "log_info" "Timeshift configuration not found - first run setup required" }}
    
    # Check if we're in a graphical session
    if [ -z "${DISPLAY:-}" ] || [ -z "${XDG_RUNTIME_DIR:-}" ]; then
        {{ includeTemplate "log_error" "Graphical session not detected" }}
        {{ includeTemplate "log_info" "Please run 'sudo timeshift-launcher' manually to create initial configuration" }}
        {{ includeTemplate "log_info" "Then run 'chezmoi apply' to continue" }}
        exit 1
    fi
    
    # Check if GUI tools are available
    if ! command -v timeshift-launcher >/dev/null 2>&1; then
        {{ includeTemplate "log_error" "timeshift-launcher not found" }}
        {{ includeTemplate "log_info" "Please install timeshift package and run 'chezmoi apply'" }}
        exit 1
    fi
    
    {{ includeTemplate "log_step" "Launching Timeshift GUI for initial setup..." }}
    {{ includeTemplate "log_info" "Please complete the setup in the GUI window" }}
    {{ includeTemplate "log_info" "Select backup location and click 'Save' to create configuration" }}
    
    # Launch Timeshift GUI in background
    timeshift-launcher &
    LAUNCHER_PID=$!
    
    {{ includeTemplate "log_info" "Waiting for configuration file creation..." }}
    
    # Wait for config file creation with timeout (5 minutes)
    TIMEOUT=300
    ELAPSED=0
    
    while [ $ELAPSED -lt $TIMEOUT ]; do
        if [ -f "$TIMESHIFT_CONFIG" ]; then
            {{ includeTemplate "log_success" "Configuration file created successfully" }}
            break
        fi
        
        # Check if launcher process is still running
        if ! kill -0 $LAUNCHER_PID 2>/dev/null; then
            {{ includeTemplate "log_error" "Timeshift GUI was closed without creating configuration" }}
            {{ includeTemplate "log_info" "Please run 'sudo timeshift-launcher' manually and try again" }}
            exit 1
        fi
        
        # Progress indicator every 10 seconds
        if [ $((ELAPSED % 10)) -eq 0 ] && [ $ELAPSED -gt 0 ]; then
            {{ includeTemplate "log_info" "Still waiting for setup... (${ELAPSED}/${TIMEOUT} seconds)" }}
        fi
        
        sleep 1
        ELAPSED=$((ELAPSED + 1))
    done
    
    # Clean up launcher process if still running
    if kill -0 $LAUNCHER_PID 2>/dev/null; then
        kill $LAUNCHER_PID 2>/dev/null || true
        wait $LAUNCHER_PID 2>/dev/null || true
    fi
    
    # Check if we timed out
    if [ $ELAPSED -ge $TIMEOUT ]; then
        {{ includeTemplate "log_error" "Setup timed out after ${TIMEOUT} seconds" }}
        {{ includeTemplate "log_info" "Please run 'sudo timeshift-launcher' manually to complete setup" }}
        {{ includeTemplate "log_info" "Then run 'chezmoi apply' to continue" }}
        exit 1
    fi
    
    # Final validation
    if [ ! -f "$TIMESHIFT_CONFIG" ]; then
        {{ includeTemplate "log_error" "Configuration file still not found after setup" }}
        {{ includeTemplate "log_info" "Please run 'sudo timeshift-launcher' manually and try again" }}
        exit 1
    fi
else
    {{ includeTemplate "log_success" "Timeshift configuration exists" }}
fi

# ============================================================================
# SECTION 2: READ CURRENT CONFIGURATION
# ============================================================================

{{ includeTemplate "log_step" "Read current retention policy..." }}

# Read current values
# Note: yq returns quoted strings, so we remove quotes for numeric comparison
CURRENT_DAILY=$(sudo yq eval '.count_daily' "$TIMESHIFT_CONFIG" | tr -d '"')
CURRENT_WEEKLY=$(sudo yq eval '.count_weekly' "$TIMESHIFT_CONFIG" | tr -d '"')
CURRENT_MONTHLY=$(sudo yq eval '.count_monthly' "$TIMESHIFT_CONFIG" | tr -d '"')
CURRENT_BOOT=$(sudo yq eval '.count_boot' "$TIMESHIFT_CONFIG" | tr -d '"')

{{ includeTemplate "log_info" "Current retention: daily=$CURRENT_DAILY weekly=$CURRENT_WEEKLY monthly=$CURRENT_MONTHLY boot=$CURRENT_BOOT" }}

# Read desired values from globals.yaml
DESIRED_DAILY="{{ .globals.timeshift.retention.daily }}"
DESIRED_WEEKLY="{{ .globals.timeshift.retention.weekly }}"
DESIRED_MONTHLY="{{ .globals.timeshift.retention.monthly }}"
DESIRED_BOOT="{{ .globals.timeshift.retention.boot }}"

{{ includeTemplate "log_info" "Desired retention: daily=$DESIRED_DAILY weekly=$DESIRED_WEEKLY monthly=$DESIRED_MONTHLY boot=$DESIRED_BOOT" }}

# ============================================================================
# SECTION 3: CHECK IF UPDATE NEEDED
# ============================================================================

{{ includeTemplate "log_step" "Check if configuration update needed..." }}

# Read current schedule flags
CURRENT_SCHEDULE_DAILY=$(sudo yq eval '.schedule_daily' "$TIMESHIFT_CONFIG")
CURRENT_SCHEDULE_WEEKLY=$(sudo yq eval '.schedule_weekly' "$TIMESHIFT_CONFIG")
CURRENT_SCHEDULE_MONTHLY=$(sudo yq eval '.schedule_monthly' "$TIMESHIFT_CONFIG")
CURRENT_SCHEDULE_BOOT=$(sudo yq eval '.schedule_boot' "$TIMESHIFT_CONFIG")
CURRENT_SCHEDULE_HOURLY=$(sudo yq eval '.schedule_hourly' "$TIMESHIFT_CONFIG")

# Define desired schedule flags
{{- $schedule_daily := .globals.timeshift.schedule.daily | ternary "true" "false" }}
{{- $schedule_weekly := .globals.timeshift.schedule.weekly | ternary "true" "false" }}
{{- $schedule_monthly := .globals.timeshift.schedule.monthly | ternary "true" "false" }}
{{- $schedule_boot := .globals.timeshift.schedule.boot | ternary "true" "false" }}
{{- $schedule_hourly := .globals.timeshift.schedule.hourly | ternary "true" "false" }}

DESIRED_SCHEDULE_DAILY="{{ $schedule_daily }}"
DESIRED_SCHEDULE_WEEKLY="{{ $schedule_weekly }}"
DESIRED_SCHEDULE_MONTHLY="{{ $schedule_monthly }}"
DESIRED_SCHEDULE_BOOT="{{ $schedule_boot }}"
DESIRED_SCHEDULE_HOURLY="{{ $schedule_hourly }}"

# Check if retention counts match
RETENTION_MATCHES=true
if [ "$CURRENT_DAILY" != "$DESIRED_DAILY" ] || \
   [ "$CURRENT_WEEKLY" != "$DESIRED_WEEKLY" ] || \
   [ "$CURRENT_MONTHLY" != "$DESIRED_MONTHLY" ] || \
   [ "$CURRENT_BOOT" != "$DESIRED_BOOT" ]; then
    RETENTION_MATCHES=false
fi

# Check if schedule flags match
SCHEDULE_MATCHES=true
if [ "$CURRENT_SCHEDULE_DAILY" != "$DESIRED_SCHEDULE_DAILY" ] || \
   [ "$CURRENT_SCHEDULE_WEEKLY" != "$DESIRED_SCHEDULE_WEEKLY" ] || \
   [ "$CURRENT_SCHEDULE_MONTHLY" != "$DESIRED_SCHEDULE_MONTHLY" ] || \
   [ "$CURRENT_SCHEDULE_BOOT" != "$DESIRED_SCHEDULE_BOOT" ] || \
   [ "$CURRENT_SCHEDULE_HOURLY" != "$DESIRED_SCHEDULE_HOURLY" ]; then
    SCHEDULE_MATCHES=false
fi

# Exit early only if both retention and schedule are correct
if [ "$RETENTION_MATCHES" = true ] && [ "$SCHEDULE_MATCHES" = true ]; then
    {{ includeTemplate "log_success" "Retention policy and schedule already configured correctly" }}
    {{ includeTemplate "log_complete" "Timeshift retention configuration complete" }}
    exit 0
fi

{{ includeTemplate "log_info" "Configuration update required" }}

# ============================================================================
# SECTION 4: BACKUP CURRENT CONFIGURATION
# ============================================================================

{{ includeTemplate "log_step" "Create backup of current configuration..." }}

BACKUP_FILE="${TIMESHIFT_CONFIG}.backup"

if [ ! -f "$BACKUP_FILE" ]; then
    sudo cp "$TIMESHIFT_CONFIG" "$BACKUP_FILE"
    {{ includeTemplate "log_success" "Backup created: $BACKUP_FILE" }}
else
    {{ includeTemplate "log_info" "Backup already exists: $BACKUP_FILE" }}
fi

# ============================================================================
# SECTION 5: UPDATE RETENTION POLICY
# ============================================================================

{{ includeTemplate "log_step" "Update retention policy..." }}

# Update retention counts (using yq v4 with environment variables)
# Note: Timeshift expects string values, not numbers
sudo DAILY="$DESIRED_DAILY" yq eval '.count_daily = strenv(DAILY)' \
    -i -o=json "$TIMESHIFT_CONFIG"

sudo WEEKLY="$DESIRED_WEEKLY" yq eval '.count_weekly = strenv(WEEKLY)' \
    -i -o=json "$TIMESHIFT_CONFIG"

sudo MONTHLY="$DESIRED_MONTHLY" yq eval '.count_monthly = strenv(MONTHLY)' \
    -i -o=json "$TIMESHIFT_CONFIG"

sudo BOOT="$DESIRED_BOOT" yq eval '.count_boot = strenv(BOOT)' \
    -i -o=json "$TIMESHIFT_CONFIG"

{{ includeTemplate "log_success" "Retention policy updated" }}

# ============================================================================
# SECTION 6: UPDATE SCHEDULE FLAGS
# ============================================================================

{{ includeTemplate "log_step" "Update snapshot schedule flags..." }}

sudo ENABLED="$DESIRED_SCHEDULE_DAILY" yq eval \
    '.schedule_daily = (env(ENABLED) == "true")' \
    -i -o=json "$TIMESHIFT_CONFIG"

sudo ENABLED="$DESIRED_SCHEDULE_WEEKLY" yq eval \
    '.schedule_weekly = (env(ENABLED) == "true")' \
    -i -o=json "$TIMESHIFT_CONFIG"

sudo ENABLED="$DESIRED_SCHEDULE_MONTHLY" yq eval \
    '.schedule_monthly = (env(ENABLED) == "true")' \
    -i -o=json "$TIMESHIFT_CONFIG"

sudo ENABLED="$DESIRED_SCHEDULE_BOOT" yq eval \
    '.schedule_boot = (env(ENABLED) == "true")' \
    -i -o=json "$TIMESHIFT_CONFIG"

sudo ENABLED="$DESIRED_SCHEDULE_HOURLY" yq eval \
    '.schedule_hourly = (env(ENABLED) == "true")' \
    -i -o=json "$TIMESHIFT_CONFIG"

{{ includeTemplate "log_success" "Schedule flags updated" }}

# ============================================================================
# SECTION 7: VALIDATE CONFIGURATION
# ============================================================================

{{ includeTemplate "log_step" "Validate configuration changes..." }}

# Read back values to verify
# Note: yq returns quoted strings, so we remove quotes for comparison
VERIFY_DAILY=$(sudo yq eval '.count_daily' "$TIMESHIFT_CONFIG" | tr -d '"')
VERIFY_WEEKLY=$(sudo yq eval '.count_weekly' "$TIMESHIFT_CONFIG" | tr -d '"')
VERIFY_MONTHLY=$(sudo yq eval '.count_monthly' "$TIMESHIFT_CONFIG" | tr -d '"')
VERIFY_BOOT=$(sudo yq eval '.count_boot' "$TIMESHIFT_CONFIG" | tr -d '"')

{{ includeTemplate "log_info" "Verification: daily=$VERIFY_DAILY weekly=$VERIFY_WEEKLY monthly=$VERIFY_MONTHLY boot=$VERIFY_BOOT" }}

# Validate retention counts
VALIDATION_FAILED=false

if [ "$VERIFY_DAILY" != "$DESIRED_DAILY" ]; then
    {{ includeTemplate "log_error" "Daily retention validation failed: expected $DESIRED_DAILY, got $VERIFY_DAILY" }}
    VALIDATION_FAILED=true
fi

if [ "$VERIFY_WEEKLY" != "$DESIRED_WEEKLY" ]; then
    {{ includeTemplate "log_error" "Weekly retention validation failed: expected $DESIRED_WEEKLY, got $VERIFY_WEEKLY" }}
    VALIDATION_FAILED=true
fi

if [ "$VERIFY_MONTHLY" != "$DESIRED_MONTHLY" ]; then
    {{ includeTemplate "log_error" "Monthly retention validation failed: expected $DESIRED_MONTHLY, got $VERIFY_MONTHLY" }}
    VALIDATION_FAILED=true
fi

if [ "$VERIFY_BOOT" != "$DESIRED_BOOT" ]; then
    {{ includeTemplate "log_error" "Boot retention validation failed: expected $DESIRED_BOOT, got $VERIFY_BOOT" }}
    VALIDATION_FAILED=true
fi

# If validation failed, restore backup
if [ "$VALIDATION_FAILED" = true ]; then
    {{ includeTemplate "log_error" "Configuration validation failed - restoring backup" }}
    sudo cp "$BACKUP_FILE" "$TIMESHIFT_CONFIG"
    {{ includeTemplate "log_info" "Backup restored from $BACKUP_FILE" }}
    exit 1
fi

{{ includeTemplate "log_success" "Configuration validated successfully" }}

# ============================================================================
# SECTION 8: CHECK SNAPSHOT COUNT
# ============================================================================

{{ includeTemplate "log_step" "Check current snapshot count..." }}

# Count current snapshots
SNAPSHOT_COUNT=$(sudo timeshift --list --scripted 2>/dev/null | grep -c "^>" || true)
# grep -c returns 0 if no matches, so ensure we have a valid number
SNAPSHOT_COUNT=${SNAPSHOT_COUNT:-0}

{{ includeTemplate "log_info" "Current snapshot count: $SNAPSHOT_COUNT" }}

# Calculate total retention limit
TOTAL_RETENTION=$((DESIRED_DAILY + DESIRED_WEEKLY + DESIRED_MONTHLY + DESIRED_BOOT))

if [ "$SNAPSHOT_COUNT" -gt "$TOTAL_RETENTION" ]; then
    EXCESS_COUNT=$((SNAPSHOT_COUNT - TOTAL_RETENTION))
    {{ includeTemplate "log_warning" "Snapshots exceed retention limit by $EXCESS_COUNT" }}
    {{ includeTemplate "log_info" "Timeshift will auto-delete oldest snapshots on next snapshot creation" }}
    {{ includeTemplate "log_info" "To manually trigger cleanup: sudo timeshift --delete-all" }}
else
    {{ includeTemplate "log_success" "Snapshot count within retention limits" }}
fi

# ============================================================================
# FINAL SUMMARY
# ============================================================================

{{ includeTemplate "log_info" "" }}
{{ includeTemplate "log_info" "════════════════════════════════════════════════════════════════" }}
{{ includeTemplate "log_info" "  Timeshift Retention Policy Configuration" }}
{{ includeTemplate "log_info" "════════════════════════════════════════════════════════════════" }}
{{ includeTemplate "log_info" "" }}
{{ includeTemplate "log_info" "Retention Policy (automatic cleanup on next snapshot):" }}
{{ includeTemplate "log_info" "  Daily:   $DESIRED_DAILY snapshots ($DESIRED_DAILY days)" }}
{{ includeTemplate "log_info" "  Weekly:  $DESIRED_WEEKLY snapshots ($DESIRED_WEEKLY weeks)" }}
{{ includeTemplate "log_info" "  Monthly: $DESIRED_MONTHLY snapshots ($DESIRED_MONTHLY months)" }}
{{ includeTemplate "log_info" "  Boot:    $DESIRED_BOOT snapshots" }}
{{ includeTemplate "log_info" "" }}

{{- if or .globals.timeshift.schedule.daily .globals.timeshift.schedule.weekly .globals.timeshift.schedule.monthly .globals.timeshift.schedule.boot .globals.timeshift.schedule.hourly }}
{{ includeTemplate "log_info" "Automated Snapshots (systemd timers):" }}
{{- if .globals.timeshift.schedule.daily }}
{{ includeTemplate "log_info" "  ✓ Daily snapshots enabled" }}
{{- end }}
{{- if .globals.timeshift.schedule.weekly }}
{{ includeTemplate "log_info" "  ✓ Weekly snapshots enabled" }}
{{- end }}
{{- if .globals.timeshift.schedule.monthly }}
{{ includeTemplate "log_info" "  ✓ Monthly snapshots enabled" }}
{{- end }}
{{- if .globals.timeshift.schedule.boot }}
{{ includeTemplate "log_info" "  ✓ Boot snapshots enabled" }}
{{- end }}
{{- if .globals.timeshift.schedule.hourly }}
{{ includeTemplate "log_info" "  ✓ Hourly snapshots enabled" }}
{{- end }}
{{ includeTemplate "log_info" "" }}
{{- else }}
{{ includeTemplate "log_info" "Automated Snapshots: Disabled (manual snapshots only)" }}
{{ includeTemplate "log_info" "  Manual snapshots via: package-manager sync (interactive)" }}
{{ includeTemplate "log_info" "" }}
{{- end }}

{{ includeTemplate "log_info" "Current Status:" }}
{{ includeTemplate "log_info" "  Snapshots: $SNAPSHOT_COUNT total" }}
{{ includeTemplate "log_info" "  Limit:     $TOTAL_RETENTION total" }}
{{ includeTemplate "log_info" "" }}
{{ includeTemplate "log_info" "Next Steps:" }}
{{ includeTemplate "log_info" "  • Retention policy active (oldest snapshots auto-deleted)" }}
{{ includeTemplate "log_info" "  • Create snapshot: sudo timeshift --create --comments 'description'" }}
{{ includeTemplate "log_info" "  • List snapshots: sudo timeshift --list" }}
{{ includeTemplate "log_info" "  • Restore backup: sudo timeshift --restore" }}
{{ includeTemplate "log_info" "" }}
{{ includeTemplate "log_info" "Configuration Location:" }}
{{ includeTemplate "log_info" "  Config:  $TIMESHIFT_CONFIG" }}
{{ includeTemplate "log_info" "  Backup:  $BACKUP_FILE" }}
{{ includeTemplate "log_info" "  Dotfiles: ~/.local/share/chezmoi/.chezmoidata/globals.yaml" }}
{{ includeTemplate "log_info" "" }}
{{ includeTemplate "log_info" "════════════════════════════════════════════════════════════════" }}
{{ includeTemplate "log_info" "" }}

# ============================================================================
# SECTION 9: CONFIGURE SYSTEMD TIMERS (OPTIONAL)
# ============================================================================

{{ includeTemplate "log_step" "Checking for timeshift-systemd-timer package..." }}

if ! systemctl list-unit-files timeshift-hourly.timer >/dev/null 2>&1; then
    {{ includeTemplate "log_skip" "timeshift-systemd-timer not installed - automated scheduling unavailable" }}
    {{ includeTemplate "log_info" "To enable scheduled snapshots:" }}
    {{ includeTemplate "log_info" "  1. Add 'timeshift-systemd-timer' to packages.yaml" }}
    {{ includeTemplate "log_info" "  2. Run: package-manager sync" }}
    {{ includeTemplate "log_info" "  3. Re-run: chezmoi apply" }}
    {{ includeTemplate "log_complete" "Timeshift retention policy configured successfully" }}
    exit 0
fi

{{ includeTemplate "log_success" "timeshift-systemd-timer package detected" }}

{{- $scheduleDaily := .globals.timeshift.schedule.daily }}
{{- $scheduleWeekly := .globals.timeshift.schedule.weekly }}
{{- $scheduleMonthly := .globals.timeshift.schedule.monthly }}
{{- $scheduleHourly := .globals.timeshift.schedule.hourly }}
{{- $scheduleBoot := .globals.timeshift.schedule.boot }}
{{- $anyScheduleEnabled := or $scheduleDaily $scheduleWeekly $scheduleMonthly $scheduleHourly }}

{{ includeTemplate "log_step" "Reading schedule configuration from globals.yaml..." }}
{{ includeTemplate "log_info" (printf "Hourly: %v, Daily: %v, Weekly: %v, Monthly: %v, Boot: %v" $scheduleHourly $scheduleDaily $scheduleWeekly $scheduleMonthly $scheduleBoot) }}

# Configure hourly timer (if any schedule enabled)
{{- if $anyScheduleEnabled }}
{{ includeTemplate "log_step" "Configuring timeshift-hourly.timer..." }}
sudo systemctl daemon-reload

if ! sudo systemctl is-enabled timeshift-hourly.timer >/dev/null 2>&1; then
    sudo systemctl enable timeshift-hourly.timer
    {{ includeTemplate "log_success" "Timer enabled" }}
else
    {{ includeTemplate "log_info" "Timer already enabled" }}
fi

if ! sudo systemctl is-active --quiet timeshift-hourly.timer; then
    sudo systemctl start timeshift-hourly.timer
    {{ includeTemplate "log_success" "Timer started" }}
else
    {{ includeTemplate "log_info" "Timer already running" }}
fi

{{ includeTemplate "log_step" "Verifying timer status..." }}
if sudo systemctl is-active --quiet timeshift-hourly.timer; then
    {{ includeTemplate "log_success" "timeshift-hourly.timer is active" }}
    NEXT_RUN=$(systemctl status timeshift-hourly.timer | grep "Trigger:" | cut -d: -f2- || echo "Unknown")
    {{ includeTemplate "log_info" "Next run:$NEXT_RUN" }}
else
    {{ includeTemplate "log_error" "Timer failed to start" }}
    sudo systemctl status timeshift-hourly.timer --no-pager
    exit 1
fi
{{- else }}
{{ includeTemplate "log_skip" "No schedules enabled in globals.yaml - skipping hourly timer" }}
{{- end }}

# Configure boot timer (if enabled)
{{- if $scheduleBoot }}
{{ includeTemplate "log_step" "Configuring timeshift-boot.timer..." }}

if ! sudo systemctl is-enabled timeshift-boot.timer >/dev/null 2>&1; then
    sudo systemctl enable timeshift-boot.timer
    {{ includeTemplate "log_success" "Boot timer enabled" }}
else
    {{ includeTemplate "log_info" "Boot timer already enabled" }}
fi

if ! sudo systemctl is-active --quiet timeshift-boot.timer; then
    sudo systemctl start timeshift-boot.timer
    {{ includeTemplate "log_success" "Boot timer started" }}
else
    {{ includeTemplate "log_info" "Boot timer already running" }}
fi

{{ includeTemplate "log_step" "Verifying boot timer status..." }}
if sudo systemctl is-active --quiet timeshift-boot.timer; then
    {{ includeTemplate "log_success" "timeshift-boot.timer is active" }}
else
    {{ includeTemplate "log_error" "Boot timer failed to start" }}
    sudo systemctl status timeshift-boot.timer --no-pager
    exit 1
fi
{{- else }}
{{ includeTemplate "log_skip" "Boot snapshots disabled in globals.yaml" }}
{{- end }}

{{ includeTemplate "log_info" "" }}
{{ includeTemplate "log_info" "Timer Management Commands:" }}
{{ includeTemplate "log_info" "  List timers:   systemctl list-timers timeshift-*" }}
{{ includeTemplate "log_info" "  Check status:  systemctl status timeshift-hourly.timer" }}
{{ includeTemplate "log_info" "  View logs:     journalctl -u timeshift-hourly.service" }}
{{ includeTemplate "log_info" "  Manual run:    sudo systemctl start timeshift-hourly.service" }}

{{ includeTemplate "log_complete" "Timeshift retention policy and timer configuration complete" }}
