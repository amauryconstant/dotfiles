#!/bin/sh

# Script: run_once_before_009_install_arch_packages.sh.tmpl
# Purpose: Install packages for Arch Linux based on destination configuration
# Requirements: Arch Linux, pacman

{{ includeTemplate "arch_linux_check" . }}
{{- $destinationConfig := index .destinations .destination }}

{{ includeTemplate "log_start" (printf "Installing packages for %s destination..." .destination) }}
    
    # Package installation with fallback
    install_packages() {
        local packages="$*"
        {{ includeTemplate "log_progress" "Installing: $packages" }}
        
        if sudo pacman -S --noconfirm --needed $packages; then
            return 0
        elif command -v yay >/dev/null 2>&1; then
            {{ includeTemplate "log_info" "Pacman failed, trying yay..." }}
            yay -S --noconfirm --needed $packages
        else
            {{ includeTemplate "log_error" "Failed to install: $packages" }}
            return 1
        fi
    }
    
    # Remove conflicting packages
    {{- if .packages.delete.arch }}
    {{ includeTemplate "log_step" "Removing conflicting packages..." }}
    yay -R --noconfirm {{ .packages.delete.arch }} 2>/dev/null || true
    {{- end }}
    
    # Install packages by category
    {{- range $name, $config := .packages.install.arch.packages }}
        {{- if has $name $destinationConfig.packages }}
    
    {{ includeTemplate "log_step" (printf "Installing %s packages..." $name) }}
    if ! install_packages {{ join " " $config.list }}; then
        {{ includeTemplate "log_error" (printf "Failed to install %s packages" $name) }}
        exit 1
    fi
        {{- end }}
    {{- end }}
    
    {{ includeTemplate "log_complete" "Package installation completed successfully" }}
