#!/bin/sh

# Script: run_once_before_009_install_arch_packages.sh.tmpl
# Purpose: Install packages for Arch Linux based on destination configuration
# Requirements: Arch Linux, pacman

{{ if eq .osId "linux-arch" }}
    {{- $destinationConfig := index .destinations .destination }}
    
    echo "Installing packages for {{ .destination }} destination..."
    
    # Simple error logging function
    log_error() {
        echo "ERROR: $1" >&2
    }
    
    # Package installation with fallback
    install_packages() {
        local packages="$*"
        echo "Installing: $packages"
        
        if sudo pacman -S --noconfirm --needed $packages; then
            return 0
        elif command -v yay >/dev/null 2>&1; then
            echo "Pacman failed, trying yay..."
            yay -S --noconfirm --needed $packages
        else
            echo "Failed to install: $packages"
            return 1
        fi
    }
    
    # Remove conflicting packages
    {{- if .packages.delete.arch }}
    echo "Removing conflicting packages..."
    yay -R --noconfirm {{ .packages.delete.arch }} 2>/dev/null || true
    {{- end }}
    
    # Install packages by category
    {{- range $name, $config := .packages.install.arch.packages }}
        {{- if has $name $destinationConfig.packages }}
    
    echo "Installing {{ $name }} packages..."
    if ! install_packages {{ join " " $config.list }}; then
        log_error "Failed to install {{ $name }} packages"
        exit 1
    fi
        {{- end }}
    {{- end }}
    
    echo "âœ“ Package installation completed successfully"
    
{{ else }}
    echo "ERROR: Unsupported OS: {{ .osId }}"
    echo "This script requires: linux-arch"
    exit 1
{{ end }}
