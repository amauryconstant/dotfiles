#!/bin/sh

# Script: run_once_after_005_enable_topgrade_timer.sh.tmpl
# Purpose: Enable and start the topgrade systemd timer for automated system maintenance
# Requirements: Arch Linux, systemd, topgrade

{{ includeTemplate "log_start" "Enabling topgrade systemd timer for automated system maintenance..." }}

# Check if topgrade is installed
if ! command -v topgrade >/dev/null 2>&1; then
    {{ includeTemplate "log_error" "topgrade is not installed. Please install it first." }}
    exit 1
fi

# Reload systemd user daemon to pick up new service files
{{ includeTemplate "log_step" "Reloading systemd user daemon..." }}
systemctl --user daemon-reload

# Enable the topgrade timer
{{ includeTemplate "log_step" "Enabling topgrade timer..." }}
if systemctl --user enable topgrade.timer; then
    {{ includeTemplate "log_success" "Topgrade timer enabled successfully" }}
else
    {{ includeTemplate "log_error" "Failed to enable topgrade timer" }}
    exit 1
fi

# Start the topgrade timer
{{ includeTemplate "log_step" "Starting topgrade timer..." }}
if systemctl --user start topgrade.timer; then
    {{ includeTemplate "log_success" "Topgrade timer started successfully" }}
else
    {{ includeTemplate "log_error" "Failed to start topgrade timer" }}
    exit 1
fi

# Show timer status
{{ includeTemplate "log_info" "Topgrade timer status:" }}
systemctl --user status topgrade.timer --no-pager -l

# Show next scheduled run
{{ includeTemplate "log_info" "Next scheduled topgrade run:" }}
systemctl --user list-timers topgrade.timer --no-pager

{{ includeTemplate "log_complete" "Topgrade timer setup completed successfully" }}
{{ includeTemplate "log_info" "  - Timer runs monthly on the first Sunday at 10:00 AM" }}
{{ includeTemplate "log_info" "  - Manual execution: topgrade" }}
{{ includeTemplate "log_info" "  - Check status: systemctl --user status topgrade.timer" }}
{{ includeTemplate "log_info" "  - View logs: journalctl --user -u topgrade.service" }}
