{{- /* chezmoi:modify-template */ -}}
{{- $config := .chezmoi.stdin | default "{}" | fromJson -}}

{{- /* JSON Schema */ -}}
{{- $_ := set $config "$schema" "https://opencode.ai/config.json" -}}

{{- /* Provider Configuration */ -}}
{{- $provider := dict -}}
{{- $_ := set $provider "zhipuai" (dict "api" "https://api.z.ai/api/coding/paas/v4") -}}
{{- $_ := set $config "provider" $provider -}}
{{- $zai_key := joinPath .chezmoi.sourceDir "private_dot_keys" "encrypted_private_zai-opencode-key.txt.age" | include | decrypt | trim -}}

{{- /* MCP Servers */ -}}
{{- $mcp := dict -}}
{{- $_ := set $mcp "context7" (dict
  "type" "local"
  "command" (list "bunx" "-y" "@upstash/context7-mcp")
) -}}
{{- $_ := set $mcp "sequential-thinking" (dict
  "type" "local"
  "command" (list "bunx" "-y" "@modelcontextprotocol/server-sequential-thinking")
) -}}
{{- $_ := set $mcp "fetch" (dict
  "type" "local"
  "command" (list "docker" "run" "-i" "--rm" "mcp/fetch")
) -}}
{{- $_ := set $mcp "mermaid" (dict
  "type" "local"
  "command" (list "bunx" "-y" "mcp-mermaid")
) -}}
{{- $_ := set $mcp "zai-mcp-server" (dict
  "type" "local"
  "command" (list "npx" "-y" "@z_ai/mcp-server")
  "environment" (dict
    "Z_AI_API_KEY" $zai_key
    "Z_AI_MODE" "ZAI"
  )
) -}}
{{- $_ := set $mcp "zai-web-reader" (dict
  "type" "remote"
  "url" "https://api.z.ai/api/mcp/web_reader/mcp"
  "headers" (dict
    "Authorization" (printf "Bearer %s" $zai_key)
  )
) -}}
{{- $_ := set $mcp "zai-web-search" (dict
  "type" "remote"
  "url" "https://api.z.ai/api/mcp/web_search_prime/mcp"
  "headers" (dict
    "Authorization" (printf "Bearer %s" $zai_key)
  )
) -}}
{{- $_ := set $mcp "zai-zread" (dict
  "type" "remote"
  "url" "https://api.z.ai/api/mcp/zread/mcp"
  "headers" (dict
    "Authorization" (printf "Bearer %s" $zai_key)
  )
) -}}
{{- $_ := set $config "mcp" $mcp -}}

{{- /* Tool Toggles */ -}}
{{- $tools := dict -}}
{{- $_ := set $tools "context7" true -}}
{{- $_ := set $tools "sequential-thinking" true -}}
{{- $_ := set $tools "fetch" true -}}
{{- $_ := set $config "tools" $tools -}}

{{- /* Skill Permissions */ -}}
{{- $skills := dict -}}
{{- $_ := set $skills "commit" "allow" -}}
{{- $_ := set $skills "skill-creator" "allow" -}}
{{- $_ := set $config "permission" (dict "skill" $skills) -}}

{{- /* Runtime-managed: "theme" - managed by theme-apply-opencode.sh */ -}}
{{- /* Do NOT set "theme" key here - it's runtime state */ -}}

{{- /* Output modified config */ -}}
{{- $config | toPrettyJson -}}
