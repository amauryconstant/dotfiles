#!/usr/bin/env bash

# Package Manager - Interactive package management tool
# Purpose: User-friendly interface for package operations
# Requirements: Arch Linux, pacman, yay, gum

package-manager() {
    # Check if gum is installed
    if ! command -v gum >/dev/null 2>&1; then
        echo "âŒ gum is required but not installed. Install with: pacman -S gum"
        return 1
    fi
    
    # Helper function for styled output
    print_message() {
        local type="$1"
        local message="$2"
        
        case "$type" in
            "title")
                gum style --foreground "#00aaff" --bold --border double --padding "1 2" --margin "1 0" "$message"
                ;;
            "success")
                gum style --foreground "#00ff00" "âœ… $message"
                ;;
            "error")
                gum style --foreground "#ff0000" --bold "âŒ $message"
                ;;
            "warning")
                gum style --foreground "#ffaa00" "âš ï¸  $message"
                ;;
            "info")
                gum style --foreground "#00aaff" "â„¹ï¸  $message"
                ;;
            *)
                echo "$message"
                ;;
        esac
    }
    
    # Function to run command with spinner
    run_with_progress() {
        local title="$1"
        local command="$2"
        gum spin --spinner dot --title "$title" -- sh -c "$command"
    }
    
    # Function to ask for confirmation
    confirm_action() {
        local message="$1"
        gum confirm "$message"
    }
    
    # Function to get user input
    get_input() {
        local prompt="$1"
        local placeholder="$2"
        gum input --placeholder "$placeholder" --header "$prompt"
    }
    
    # Main interactive loop
    while true; do
        print_message "title" "ðŸ“¦ Package Manager"
        
        ACTION=$(gum choose --header "Select a package operation:" \
            "ðŸ” Search - Search for packages" \
            "ðŸ“¥ Install - Install packages" \
            "ðŸ—‘ï¸  Remove - Remove packages" \
            "â„¹ï¸  Info - Show package information" \
            "ðŸ“‹ List - List installed packages" \
            "ðŸ”„ Update - Update packages" \
            "ðŸ§¹ Clean - Clean package cache" \
            "ðŸ” AUR Search - Search AUR packages" \
            "ðŸ“¥ AUR Install - Install from AUR" \
            "ðŸ“Š Statistics - Show package statistics" \
            "ðŸ‘¥ Dependencies - Show package dependencies" \
            "ðŸšª Exit")
        
        case "$ACTION" in
            "ðŸ” Search - Search for packages")
                local search_term=$(get_input "Enter search term" "package name or keyword")
                if [[ -n "$search_term" ]]; then
                    gum spin --spinner dot --title "Searching packages..." -- sleep 0.5
                    print_message "info" "Search results for: $search_term"
                    echo ""
                    
                    local search_results=$(pacman -Ss "$search_term" 2>/dev/null)
                    if [[ -n "$search_results" ]]; then
                        echo "$search_results" | while IFS= read -r line; do
                            if [[ "$line" =~ ^[a-zA-Z0-9_-]+/[a-zA-Z0-9_+-]+ ]]; then
                                gum style --foreground "#00aaff" --bold "$line"
                            else
                                gum style --foreground "#666666" "    $line"
                            fi
                        done
                    else
                        gum style --foreground "#ffaa00" "No packages found matching '$search_term'"
                    fi
                else
                    print_message "error" "No search term provided"
                fi
                ;;
                
            "ðŸ“¥ Install - Install packages")
                local packages=$(get_input "Enter package name(s) to install" "package1 package2 ...")
                if [[ -n "$packages" ]]; then
                    if confirm_action "Install packages: $packages?"; then
                        print_message "info" "Installing packages..."
                        sudo pacman -S $packages
                        print_message "success" "Package installation completed!"
                    else
                        print_message "info" "Operation cancelled"
                    fi
                else
                    print_message "error" "No packages specified"
                fi
                ;;
                
            "ðŸ—‘ï¸  Remove - Remove packages")
                local packages=$(get_input "Enter package name(s) to remove" "package1 package2 ...")
                if [[ -n "$packages" ]]; then
                    print_message "warning" "The following packages will be removed:"
                    pacman -Qi $packages 2>/dev/null | grep "Name" | awk '{print "  â€¢ " $3}' || echo "  â€¢ $packages"
                    
                    if confirm_action "Remove these packages and their dependencies?"; then
                        print_message "info" "Removing packages..."
                        sudo pacman -Rs $packages
                        print_message "success" "Package removal completed!"
                    else
                        print_message "info" "Operation cancelled"
                    fi
                else
                    print_message "error" "No packages specified"
                fi
                ;;
                
            "â„¹ï¸  Info - Show package information")
                local package=$(get_input "Enter package name" "package-name")
                if [[ -n "$package" ]]; then
                    print_message "info" "Package information for: $package"
                    echo ""
                    pacman -Qi "$package" 2>/dev/null || pacman -Si "$package" 2>/dev/null || print_message "error" "Package not found"
                else
                    print_message "error" "No package specified"
                fi
                ;;
                
            "ðŸ“‹ List - List installed packages")
                local list_type=$(gum choose --header "What would you like to list?" \
                    "All installed packages" \
                    "Explicitly installed packages" \
                    "Recently installed packages" \
                    "Largest packages")
                
                case "$list_type" in
                    "All installed packages")
                        local total_packages=$(pacman -Q | wc -l)
                        print_message "info" "All installed packages (Total: $total_packages)"
                        echo ""
                        
                        # Use gum filter for searchable package list
                        local selected_package=$(pacman -Q | gum filter --placeholder "Type to search packages...")
                        if [[ -n "$selected_package" ]]; then
                            local pkg_name=$(echo "$selected_package" | awk '{print $1}')
                            gum style --foreground "#00aaff" --bold "Package Details: $pkg_name"
                            echo ""
                            pacman -Qi "$pkg_name" 2>/dev/null || echo "Package details not available"
                        fi
                        ;;
                    "Explicitly installed packages")
                        print_message "info" "Explicitly installed packages:"
                        echo ""
                        
                        # Create a table for explicitly installed packages
                        echo "Package|Version|Repository" > /tmp/explicit_packages.txt
                        pacman -Qe | while read -r pkg ver; do
                            local repo=$(pacman -Qi "$pkg" 2>/dev/null | grep "Repository" | awk '{print $3}' || echo "local")
                            echo "$pkg|$ver|$repo" >> /tmp/explicit_packages.txt
                        done
                        
                        gum table < /tmp/explicit_packages.txt
                        rm -f /tmp/explicit_packages.txt
                        ;;
                    "Recently installed packages")
                        print_message "info" "Recently installed packages:"
                        echo ""
                        
                        # Format recent installations with better styling
                        grep -E "installed|upgraded" /var/log/pacman.log | tail -20 | while IFS= read -r line; do
                            local date_time=$(echo "$line" | awk '{print $1, $2}')
                            local action=$(echo "$line" | grep -o -E "(installed|upgraded)")
                            local package=$(echo "$line" | awk '{print $4}')
                            
                            if [[ "$action" == "installed" ]]; then
                                gum style --foreground "#00ff00" "ðŸ“¦ $date_time - INSTALLED: $package"
                            else
                                gum style --foreground "#00aaff" "ðŸ”„ $date_time - UPGRADED: $package"
                            fi
                        done
                        ;;
                    "Largest packages")
                        print_message "info" "Largest installed packages:"
                        echo ""
                        
                        # Create table for largest packages
                        echo "Size|Package|Description" > /tmp/largest_packages.txt
                        pacman -Qi | awk '
                            /^Name/{name=$3} 
                            /^Description/{desc=substr($0,14)} 
                            /^Installed Size/{
                                size=$4 " " $5; 
                                print size"|"name"|"desc
                            }' | sort -hr | head -10 >> /tmp/largest_packages.txt
                        
                        gum table < /tmp/largest_packages.txt
                        rm -f /tmp/largest_packages.txt
                        ;;
                esac
                ;;
                
            "ðŸ”„ Update - Update packages")
                # Check for available updates first
                print_message "info" "Checking for available updates..."
                local updates=$(checkupdates 2>/dev/null)
                
                if [[ -n "$updates" ]]; then
                    local update_count=$(echo "$updates" | wc -l)
                    print_message "warning" "$update_count package update(s) available:"
                    echo "$updates" | head -10
                    if [[ $update_count -gt 10 ]]; then
                        echo "... and $((update_count - 10)) more"
                    fi
                    
                    if confirm_action "Update all packages?"; then
                        print_message "info" "Updating packages..."
                        sudo pacman -Syu
                        print_message "success" "Package updates completed!"
                    else
                        print_message "info" "Operation cancelled"
                    fi
                else
                    print_message "success" "System is up to date!"
                fi
                ;;
                
            "ðŸ§¹ Clean - Clean package cache")
                print_message "info" "Package cache cleanup options:"
                local cache_size=$(du -sh /var/cache/pacman/pkg/ 2>/dev/null | cut -f1 || echo "unknown")
                print_message "info" "Current cache size: $cache_size"
                
                local clean_type=$(gum choose --header "Select cleanup type:" \
                    "Clean uninstalled packages only" \
                    "Clean all cached packages" \
                    "Clean all except 3 most recent versions")
                
                case "$clean_type" in
                    "Clean uninstalled packages only")
                        if confirm_action "Clean cache of uninstalled packages?"; then
                            sudo pacman -Sc
                            print_message "success" "Cache cleanup completed!"
                        fi
                        ;;
                    "Clean all cached packages")
                        if confirm_action "Clean ALL cached packages? (Warning: this will remove all cached packages)"; then
                            sudo pacman -Scc
                            print_message "success" "Full cache cleanup completed!"
                        fi
                        ;;
                    "Clean all except 3 most recent versions")
                        if command -v paccache >/dev/null 2>&1; then
                            if confirm_action "Keep only 3 most recent versions of each package?"; then
                                sudo paccache -r
                                print_message "success" "Cache cleanup completed!"
                            fi
                        else
                            print_message "error" "paccache not available (install pacman-contrib)"
                        fi
                        ;;
                esac
                ;;
                
            "ðŸ” AUR Search - Search AUR packages")
                if command -v yay >/dev/null 2>&1; then
                    local search_term=$(get_input "Enter AUR search term" "package name or keyword")
                    if [[ -n "$search_term" ]]; then
                        print_message "info" "Searching AUR for: $search_term"
                        echo ""
                        yay -Ss "$search_term"
                    else
                        print_message "error" "No search term provided"
                    fi
                else
                    print_message "error" "yay is not installed. Install with: pacman -S yay"
                fi
                ;;
                
            "ðŸ“¥ AUR Install - Install from AUR")
                if command -v yay >/dev/null 2>&1; then
                    local packages=$(get_input "Enter AUR package name(s)" "aur-package1 aur-package2 ...")
                    if [[ -n "$packages" ]]; then
                        if confirm_action "Install AUR packages: $packages?"; then
                            print_message "info" "Installing AUR packages..."
                            yay -S $packages
                            print_message "success" "AUR package installation completed!"
                        else
                            print_message "info" "Operation cancelled"
                        fi
                    else
                        print_message "error" "No packages specified"
                    fi
                else
                    print_message "error" "yay is not installed. Install with: pacman -S yay"
                fi
                ;;
                
            "ðŸ“Š Statistics - Show package statistics")
                print_message "info" "Package Statistics:"
                echo ""
                
                local total_packages=$(pacman -Q | wc -l)
                local explicit_packages=$(pacman -Qe | wc -l)
                local dependency_packages=$(pacman -Qd | wc -l)
                local foreign_packages=$(pacman -Qm | wc -l)
                
                echo "ðŸ“¦ Total installed packages: $total_packages"
                echo "ðŸŽ¯ Explicitly installed: $explicit_packages"
                echo "ðŸ”— Dependencies: $dependency_packages"
                echo "ðŸŒ Foreign (AUR/manual): $foreign_packages"
                
                if command -v checkupdates >/dev/null 2>&1; then
                    local available_updates=$(checkupdates 2>/dev/null | wc -l)
                    echo "ðŸ”„ Available updates: $available_updates"
                fi
                
                local orphaned=$(pacman -Qtdq 2>/dev/null | wc -l)
                echo "ðŸ—‘ï¸  Orphaned packages: $orphaned"
                
                # Cache size
                local cache_size=$(du -sh /var/cache/pacman/pkg/ 2>/dev/null | cut -f1 || echo "unknown")
                echo "ðŸ’¾ Package cache size: $cache_size"
                ;;
                
            "ðŸ‘¥ Dependencies - Show package dependencies")
                local package=$(get_input "Enter package name" "package-name")
                if [[ -n "$package" ]]; then
                    local dep_type=$(gum choose --header "What dependencies to show?" \
                        "Dependencies of this package" \
                        "Packages that depend on this package" \
                        "Dependency tree")
                    
                    case "$dep_type" in
                        "Dependencies of this package")
                            print_message "info" "Dependencies of $package:"
                            pacman -Qi "$package" 2>/dev/null | grep "Depends On" | cut -d: -f2
                            ;;
                        "Packages that depend on this package")
                            print_message "info" "Packages that depend on $package:"
                            pacman -Qi "$package" 2>/dev/null | grep "Required By" | cut -d: -f2
                            ;;
                        "Dependency tree")
                            if command -v pactree >/dev/null 2>&1; then
                                print_message "info" "Dependency tree for $package:"
                                pactree "$package"
                            else
                                print_message "error" "pactree not available (install pacman-contrib)"
                            fi
                            ;;
                    esac
                else
                    print_message "error" "No package specified"
                fi
                ;;
                
            "ðŸšª Exit"|"")
                print_message "info" "Goodbye! ðŸ‘‹"
                break
                ;;
                
            *)
                print_message "error" "Unknown action. Please try again."
                ;;
        esac
        
        # Pause before showing menu again (except for exit)
        if [[ "$ACTION" != "ðŸšª Exit" && "$ACTION" != "" ]]; then
            echo ""
            gum style --foreground "#666666" "Press any key to continue..."
            read -r -n 1
            echo ""
        fi
    done
}