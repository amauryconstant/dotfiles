#!/usr/bin/env zsh

# Switch between git worktrees with fuzzy selection
# Usage: worktree-switch

local project workspace_dir selected worktrees

# Check if we're in a git repository for context
if git rev-parse --git-dir >/dev/null 2>&1; then
    project=$(basename $(git rev-parse --show-toplevel))
    workspace_dir="$HOME/Workspaces/$project"
    gum style --foreground="#268bd2" "ğŸ“‹ Switching worktrees for project: $project"
else
    workspace_dir="$HOME/Workspaces"
    gum style --foreground="#268bd2" "ğŸ“‹ Switching between all worktrees"
fi

# Find all worktrees
if [[ ! -d "$workspace_dir" ]]; then
    gum style --foreground="#b58900" "âš ï¸  No worktrees found in $workspace_dir"
    return 1
fi

# Collect worktree information
worktrees=()
while IFS= read -r line; do
    if [[ -n "$line" ]]; then
        worktree_path=$(echo "$line" | sed 's|/.git||')
        if [[ -d "$worktree_path" ]]; then
            # Get relative path for display
            rel_path=${worktree_path#$HOME/Workspaces/}
            # Get current branch if possible
            if [[ -d "$worktree_path/.git" ]] || [[ -f "$worktree_path/.git" ]]; then
                current_branch=$(cd "$worktree_path" && git branch --show-current 2>/dev/null || echo "unknown")
                worktrees+=("$rel_path â†’ $current_branch|$worktree_path")
            else
                worktrees+=("$rel_path|$worktree_path")
            fi
        fi
    fi
done < <(find "$workspace_dir" -name ".git" -type f -o -name ".git" -type d 2>/dev/null)

if [[ ${#worktrees[@]} -eq 0 ]]; then
    gum style --foreground="#b58900" "âš ï¸  No worktrees found"
    echo
    gum style --foreground="#586e75" "Tip: Create a worktree with 'worktree-create <branch-name>'"
    return 1
fi

# Let user select worktree
echo
selected=$(printf '%s\n' "${worktrees[@]}" | \
    gum choose --height=15 --header="Select worktree to switch to:")

if [[ -n "$selected" ]]; then
    worktree_path=$(echo "$selected" | cut -d'|' -f2)
    cd "$worktree_path"
    
    # Show success with current status
    branch=$(git branch --show-current 2>/dev/null || echo "unknown")
    gum style --border rounded --margin "1" --padding "1 2" --border-foreground "#859900" \
        "âœ… Switched to worktree" \
        "" \
        "ğŸ“ $(pwd)" \
        "ğŸŒ¿ Branch: $branch"
else
    gum style --foreground="#586e75" "No worktree selected"
fi