#!/usr/bin/env zsh
#
# .zshrc - Zsh file loaded on interactive shell sessions.
#

# Source common interactive shell configuration
. $HOME/.config/shell/interactive

if [[ -n "$ZSH_DEBUGRC" ]]; then
  zmodload zsh/zprof
fi

# Lazy-load (autoload) lightweight Zsh function files from a directory.
ZFUNCDIR=${ZDOTDIR:-$HOME}/.zfunctions
fpath=($ZFUNCDIR $fpath)

# Only autoload lightweight functions immediately
autoload -Uz $ZFUNCDIR/br(.:t) $ZFUNCDIR/commands(.:t) $ZFUNCDIR/debug-zsh-startup(.:t) $ZFUNCDIR/init-zsh-cmd(.:t) $ZFUNCDIR/ts(.:t) $ZFUNCDIR/reorder-json(.:t) $ZFUNCDIR/rm-empty-dirs(.:t) $ZFUNCDIR/twiggit(.:t)

# Lazy loading system for heavy commands
_lazy_load_commands() {
    # Command registry: "command:script_path"
    local commands_registry=(
        "system-health:$HOME/.local/bin/system-health"
        "package-manager:$HOME/.local/bin/package-manager"
        "random-wallpaper:$HOME/.local/bin/random-wallpaper"
        "set-wallpaper:$HOME/.local/bin/set-wallpaper"
        "tailscale:$HOME/.local/bin/tailscale"
        "screenshot:$HOME/.local/bin/screenshot"
        "launch-or-focus:$HOME/.local/bin/launch-or-focus"
        "git-prune-branch:$HOME/.local/bin/git-prune-branch"
        "system-troubleshoot:$HOME/.local/bin/system-troubleshoot"
        "system-maintenance:$HOME/.local/bin/system-maintenance"
    )
    
    for entry in "$commands_registry[@]"; do
        local cmd="${entry%%:*}"
        local script="${entry##*:}"
        
        # Create lazy loading wrapper
        eval "$cmd() { 
            unset -f $cmd
            '$script' \"\$@\"
        }"
    done
}

# Initialize lazy loading
_lazy_load_commands

# Set any zstyles you might use for configuration.
[[ ! -f ${ZDOTDIR:-$HOME}/.zstyles ]] || source ${ZDOTDIR:-$HOME}/.zstyles

# Create an amazing Zsh config using antidote plugins.
if [[ -f /usr/share/zsh-antidote/antidote.zsh ]]; then
  source /usr/share/zsh-antidote/antidote.zsh

  # Try to load plugins, but handle offline/initial setup gracefully
  if ! antidote load 2>/dev/null; then
    echo "⚠️  antidote plugins not initialized. Attempting to bundle..."
    # Try to bundle plugins if online, otherwise skip
    if antidote bundle <${ZDOTDIR:-$HOME}/.zsh_plugins.txt >${ZDOTDIR:-$HOME}/.zsh_plugins.zsh 2>/dev/null; then
      echo "✓ Plugins bundled successfully"
      source ${ZDOTDIR:-$HOME}/.zsh_plugins.zsh
    else
      echo "⚠️  Unable to download plugins (offline?). Using fallback configuration."
      echo "   Run 'antidote bundle <~/.config/zsh/.zsh_plugins.txt >~/.config/zsh/.zsh_plugins.zsh' when online."
    fi
  fi
else
  echo "⚠️  zsh-antidote not found. Run: yay -S zsh-antidote"
fi

# Source anything in .zshrc.d.
for _rc in ${ZDOTDIR:-$HOME}/.zshrc.d/*.zsh; do
  # Ignore tilde files.
  if [[ $_rc:t != '~'* ]]; then
    source "$_rc"
  fi
done
unset _rc

if [[ -n "$ZSH_DEBUGRC" ]]; then
  zprof
fi
