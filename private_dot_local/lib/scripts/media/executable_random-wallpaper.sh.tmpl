#!/usr/bin/env sh

# Script: random-wallpaper.sh
# Purpose: Select and set a random wallpaper from current theme's collection
# Requirements: Arch Linux, swww, find, shuf

{{ includeTemplate "log_start" "Selecting random wallpaper" }}

set -euo pipefail

# Lock file to prevent concurrent executions
LOCK_FILE="${XDG_RUNTIME_DIR:-/tmp}/random-wallpaper.lock"
LOCK_TIMEOUT=120  # 2 minutes

# Function to cleanup lock file on exit
cleanup_lock() {
    if [ -f "$LOCK_FILE" ]; then
        rm -f "$LOCK_FILE"
    fi
}

# Set up trap to cleanup lock file
trap cleanup_lock EXIT INT TERM

# Check for existing lock file
if [ -f "$LOCK_FILE" ]; then
    # Check if lock file is older than timeout
    if [ "$(find "$LOCK_FILE" -mmin +2 2>/dev/null)" ]; then
        {{ includeTemplate "log_warning" "Removing stale lock file" }}
        rm -f "$LOCK_FILE"
    else
        {{ includeTemplate "log_warning" "Another wallpaper change is in progress, exiting" }}
        exit 0
    fi
fi

# Create lock file with timestamp
echo "$(date +%s)" > "$LOCK_FILE"

# Pre-flight checks for required dependencies
for cmd in swww find shuf; do
    if ! command -v "$cmd" >/dev/null 2>&1; then
        {{ includeTemplate "log_error" "Required command not found: $cmd" }}
        exit 1
    fi
done

# Wallpaper directory - organized by theme
WALLPAPERS_ROOT="${HOME}/.config/wallpapers"
CURRENT_THEME_LINK="${HOME}/.config/themes/current"

# Determine wallpaper directory based on current theme
if [ ! -L "$CURRENT_THEME_LINK" ]; then
    {{ includeTemplate "log_error" "No theme is currently set (symlink $CURRENT_THEME_LINK not found)" }}
    exit 1
fi

# Extract theme name from symlink target
THEME_NAME="$(basename "$(readlink -f "$CURRENT_THEME_LINK")")"
WALLPAPER_DIR="$WALLPAPERS_ROOT/$THEME_NAME"

# Validate wallpaper directory exists and is not empty
if [ ! -d "$WALLPAPER_DIR" ]; then
    {{ includeTemplate "log_error" "Theme wallpaper directory not found: $WALLPAPER_DIR" }}
    exit 1
fi

if [ -z "$(ls -A "$WALLPAPER_DIR" 2>/dev/null)" ]; then
    {{ includeTemplate "log_error" "No wallpapers found in theme directory: $WALLPAPER_DIR" }}
    {{ includeTemplate "log_info" "Run 'chezmoi apply --refresh-externals' to download wallpapers" }}
    exit 1
fi

# Transition settings (can be overridden by arguments)
TRANSITION_TYPE="${1:-fade}"      # Default: fade (smoother than simple)
TRANSITION_DURATION="${2:-2}"     # Default: 2 seconds
TRANSITION_FPS="${3:-30}"         # Default: 30 fps

{{ includeTemplate "log_step" "Finding available wallpapers" }}

# Find all image files and select one randomly
# Supported formats: jpg, jpeg, png, gif, webp, bmp, tiff, tga, pnm
WALLPAPER=$(find "$WALLPAPER_DIR" -type f \
    \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" \
    -o -iname "*.gif" -o -iname "*.webp" -o -iname "*.bmp" \
    -o -iname "*.tiff" -o -iname "*.tga" -o -iname "*.pnm" \) \
    | shuf -n 1)

# Validate that a wallpaper was found
if [ -z "$WALLPAPER" ]; then
    {{ includeTemplate "log_error" "No wallpapers found in $WALLPAPER_DIR" }}
    exit 1
fi

{{ includeTemplate "log_step" "Setting selected wallpaper" }}

# Call the main set-wallpaper script with the random wallpaper
# Pass transition settings as arguments
SET_WALLPAPER_SCRIPT="$HOME/.local/lib/scripts/media/set-wallpaper.sh"
if [ ! -f "$SET_WALLPAPER_SCRIPT" ]; then
    {{ includeTemplate "log_error" "set-wallpaper script not found at $SET_WALLPAPER_SCRIPT" }}
    exit 1
fi

exec "$SET_WALLPAPER_SCRIPT" "$WALLPAPER" "$TRANSITION_TYPE" "$TRANSITION_DURATION"
