#!/usr/bin/env bash

# Script: set-wallpaper
# Purpose: Change wallpaper using swww
# Requirements: Arch Linux, swww

{{ includeTemplate "log_start" "Setting wallpaper" }}

set -euo pipefail

# Validate arguments
if [ $# -eq 0 ]; then
    {{ includeTemplate "log_error" "No wallpaper path provided" }}
    echo "Usage: set-wallpaper /path/to/wallpaper.jpg"
    echo ""
    echo "Examples:"
    echo "  set-wallpaper ~/Pictures/Wallpapers/sunset.jpg"
    echo "  set-wallpaper \$(find ~/Pictures/Wallpapers -type f | shuf -n1)  # Random"
    exit 1
fi

WALLPAPER_PATH="$1"
TRANSITION_TYPE="${2:-fade}"  # Default to fade, allow override
TRANSITION_DURATION="${3:-2}"  # Default to 2 seconds

# Validate wallpaper file exists
if [ ! -f "$WALLPAPER_PATH" ]; then
    {{ includeTemplate "log_error" "Wallpaper file not found: $WALLPAPER_PATH" }}
    exit 1
fi

# Check if swww daemon is running
if ! pgrep -x swww-daemon > /dev/null; then
    {{ includeTemplate "log_step" "Starting swww daemon" }}
    swww-daemon 2>/dev/null &
    sleep 1
fi

{{ includeTemplate "log_step" "Setting wallpaper with swww" }}
swww img "$WALLPAPER_PATH" \
    --transition-type "$TRANSITION_TYPE" \
    --transition-duration "$TRANSITION_DURATION"

# Call user hook
if [ -f "$HOME/.local/lib/scripts/core/hook-runner" ]; then
    "$HOME/.local/lib/scripts/core/hook-runner" wallpaper-change "$WALLPAPER_PATH" 2>/dev/null || true
fi

{{ includeTemplate "log_complete" "Wallpaper updated successfully" }}
