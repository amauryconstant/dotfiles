#!/usr/bin/env sh

# Script: session-save.sh
# Purpose: Save Hyprland session using hyprdrover with CWD enrichment + launch command mapping
# Requirements: Arch Linux, hyprdrover, hyprctl, jaq

SESSION_DIR="$HOME/.local/state/dotfiles"
DENYLIST_FILE="$HOME/.config/dotfiles/session-denylist.conf"
# Apps whose own restoration dialog handles multi-window/tab recovery.
# Only the first window (lowest workspace ID) is saved; the app restores the rest.
BROWSERS_FILE="$HOME/.config/dotfiles/session-browsers.conf"

# Default slot name
SLOT="${1:-default}"

# Debug logging (for AI debugging)
log_debug() {
    logger -t hypr-session "[DEBUG] $*"
}

log_info() {
    logger -t hypr-session "[INFO] $*"
}

# Validate slot name (alphanumeric, dash, underscore only)
if ! echo "$SLOT" | grep -qE '^[a-zA-Z0-9_-]+$'; then
    timeout 1 notify-send "Session Manager" "❌ Invalid slot name: $SLOT" -u critical -t 3000 2>/dev/null || true
    exit 1
fi

# Ensure directories exist
mkdir -p "$SESSION_DIR"

# Load denylist (one class per line)
load_denylist() {
    if [ -f "$DENYLIST_FILE" ]; then
        grep -v '^#' "$DENYLIST_FILE" | grep -v '^$'
    else
        # Default denylist (ephemeral/UI elements)
        printf "wofi\nwlogout\ndunst\nwaybar\nhyprpicker\n"
    fi
}

# Load browsers list (one class per line, lowercase)
# Only the first window of each browser class is saved.
load_browsers() {
    if [ -f "$BROWSERS_FILE" ]; then
        grep -v '^#' "$BROWSERS_FILE" | grep -v '^$'
    else
        printf "firefox\nchromium\nbrave\nvivaldi\nopera\n"
    fi
}

# Map window class to proper launch command
get_launch_command() {
    class="$1"

    # Case-insensitive class matching
    class_lower=$(echo "$class" | tr '[:upper:]' '[:lower:]')

    case "$class_lower" in
        # Code editors (Electron apps)
        "code-oss"|"code")
            echo "code"
            ;;
        "vscodium")
            echo "vscodium"
            ;;

        # Browsers
        "firefox")
            echo "firefox"
            ;;
        "chromium"|"chromium-browser")
            echo "chromium"
            ;;
        "brave"|"brave-browser")
            echo "brave"
            ;;

        # Terminals
        "com.mitchellh.ghostty"|"ghostty")
            echo "ghostty"
            ;;
        "kitty")
            echo "kitty"
            ;;
        "alacritty")
            echo "alacritty"
            ;;
        "foot")
            echo "foot"
            ;;

        # Flatpak apps (detect by class pattern or explicit mapping)
        "slack")
            if printf '%s\n' "$_flatpak_apps" | grep -q "com.slack.Slack"; then
                echo "flatpak run com.slack.Slack"
            else
                echo "slack"
            fi
            ;;
        "spotify")
            if printf '%s\n' "$_flatpak_apps" | grep -q "com.spotify.Client"; then
                echo "flatpak run com.spotify.Client"
            else
                echo "spotify"
            fi
            ;;
        "discord")
            if printf '%s\n' "$_flatpak_apps" | grep -q "com.discordapp.Discord"; then
                echo "flatpak run com.discordapp.Discord"
            else
                echo "discord"
            fi
            ;;

        # File managers
        "dolphin")
            echo "dolphin"
            ;;
        "thunar")
            echo "thunar"
            ;;
        "nautilus")
            echo "nautilus"
            ;;

        # Default: Use class name as command (lowercase)
        *)
            echo "$class_lower"
            ;;
    esac
}

# Check critical dependencies
check_dependencies() {
    for cmd in hyprdrover hyprctl jaq; do
        if ! command -v "$cmd" >/dev/null 2>&1; then
            timeout 1 notify-send "Session Manager" "❌ Missing dependency: $cmd\nRun: package-manager sync" -u critical -t 5000 2>/dev/null || true
            logger -t hypr-session "[ERROR] session-save: missing dependency $cmd"
            exit 1
        fi
    done
    log_debug "session-save: dependencies OK"
}

# Wait for Hyprland to be ready
wait_for_hyprland() {
    local timeout="${1:-30}"
    local elapsed=0
    
    log_debug "session-save: waiting for Hyprland (timeout: ${timeout}s)"
    while [ $elapsed -lt $timeout ]; do
        if hyprctl version >/dev/null 2>&1; then
            log_debug "session-save: Hyprland ready"
            return 0
        fi
        sleep 0.5
        elapsed=$((elapsed + 1))
    done
    
    timeout 1 notify-send "Session Manager" "❌ Hyprland not responding after ${timeout}s" -u critical -t 5000 2>/dev/null || true
    logger -t hypr-session "[ERROR] session-save: Hyprland not responding after ${timeout}s"
    return 1
}

check_dependencies
wait_for_hyprland || exit 1

# Main save logic
save_session() {
    timeout 1 notify-send "Session Manager" "Saving Hyprland session to slot: $SLOT..." -t 2000 2>/dev/null || true
    log_info "session-save: started slot=$SLOT"

    # Phase 1: Capture session from Hyprland (source of truth)
    windows_json=$(hyprctl clients -j)
    monitors_json=$(hyprctl monitors -j 2>/dev/null || echo "[]")
    log_debug "session-save: captured $(echo "$windows_json" | jaq 'length') windows (sorted by ws):"
    echo "$windows_json" | jaq -r 'sort_by(.workspace.id) | .[] |
        "  class=\(.class) ws=\(.workspace.id) addr=\(.address) title=\"\(.title[0:50] // "")\""' \
        2>/dev/null | while IFS= read -r line; do
        log_debug "session-save:$line"
    done

    # Update hyprdrover index in parallel (non-blocking; for hyprdrover users)
    timeout 30 hyprdrover --save "$SLOT" >/dev/null 2>&1 || \
        logger -t hypr-session "[WARN] session-save: hyprdrover update skipped (non-critical)"

    # Phase 2: Extract terminal CWDs for enrichment

    # Get denylist as JSON array
    denylist_json=$(load_denylist | jaq -R -s 'split("\n") | map(select(length > 0))')
    log_debug "session-save: denylist=$(load_denylist | tr '\n' ',' | sed 's/,$//')"

    # Build CWD map for terminal windows
    temp_pids=$(mktemp)
    temp_cwds=$(mktemp)

    # Extract terminal window PIDs
    echo "$windows_json" | jaq -r '
        .[] |
        select(.class | test("ghostty|kitty|alacritty|foot|wezterm|Ghostty|Kitty|Alacritty|Foot|WezTerm|com.mitchellh.ghostty"; "i")) |
        "\(.pid)|\(.class)|\(.address)"
    ' > "$temp_pids"

    # Collect CWD for each terminal
    while IFS='|' read -r pid _class address; do
        cwd=""
        cwd_method="none"

        if [ -d "/proc/$pid" ]; then
            # Try shell child process first (reflects current shell dir, not terminal launch dir)
            shell_pid=$(pgrep -P "$pid" 2>/dev/null | head -n 1)
            if [ -n "$shell_pid" ] && [ -d "/proc/$shell_pid" ]; then
                shell_cwd=$(readlink "/proc/$shell_pid/cwd" 2>/dev/null || echo "")
                if [ -n "$shell_cwd" ] && [ -d "$shell_cwd" ]; then
                    cwd="$shell_cwd"
                    cwd_method="shell-child(pid=$shell_pid)"
                fi
            fi
            # Fall back to terminal process's own CWD
            if [ -z "$cwd" ]; then
                direct_cwd=$(readlink "/proc/$pid/cwd" 2>/dev/null || echo "")
                if [ -n "$direct_cwd" ] && [ -d "$direct_cwd" ]; then
                    cwd="$direct_cwd"
                    cwd_method="terminal-proc"
                fi
            fi
        else
            cwd_method="pid-not-found"
        fi

        log_debug "session-save: cwd class=$_class addr=$address pid=$pid method=$cwd_method cwd=${cwd:-(none)}"

        # Store as JSON if CWD found
        if [ -n "$cwd" ]; then
            jaq -n --arg addr "$address" --arg cwd "$cwd" \
                '{($addr): $cwd}' >> "$temp_cwds"
        fi
    done < "$temp_pids"

    # Aggregate CWD map
    if [ -s "$temp_cwds" ]; then
        cwd_map=$(jaq -s 'reduce .[] as $item ({}; . + $item)' < "$temp_cwds")
    else
        cwd_map="{}"
    fi

    rm -f "$temp_pids" "$temp_cwds"

    # Phase 3: Build launch command map
    # Cache flatpak app list once (avoids repeated subprocess calls per window)
    _flatpak_apps=$(flatpak list --app 2>/dev/null || echo "")
    temp_launch=$(mktemp)

    echo "$windows_json" | jaq -r '.[] | "\(.address)|\(.class)"' | while IFS='|' read -r address class; do
        launch_cmd=$(get_launch_command "$class")
        log_debug "session-save: launch_cmd class=$class addr=$address cmd='$launch_cmd'"
        jaq -n --arg addr "$address" --arg cmd "$launch_cmd" \
            '{($addr): $cmd}' >> "$temp_launch"
    done

    if [ -s "$temp_launch" ]; then
        launch_map=$(jaq -s 'reduce .[] as $item ({}; . + $item)' < "$temp_launch")
    else
        launch_map="{}"
    fi

    rm -f "$temp_launch"

    # Get browsers list as JSON array (lowercase class names)
    browsers_json=$(load_browsers | tr '[:upper:]' '[:lower:]' | jaq -R -s 'split("\n") | map(select(length > 0))')
    log_debug "session-save: browsers=$(load_browsers | tr '\n' ',' | sed 's/,$//')"

    # Phase 4: Apply denylist + enrich with CWD, launch commands, and monitor names
    # Uses hyprctl data directly — captures all windows regardless of hyprdrover filters
    filtered_session=$(echo "$windows_json" | jaq \
        --argjson denylist "$denylist_json" \
        --argjson browsers "$browsers_json" \
        --argjson cwdMap "$cwd_map" \
        --argjson launchMap "$launch_map" \
        --argjson monitors "$monitors_json" '
        # Build monitor ID → name map (hyprctl reports integer IDs, dispatch needs names)
        ($monitors | map({key: (.id | tostring), value: .name}) | from_entries) as $monitorMap |
        ($browsers | map({key: ., value: true}) | from_entries) as $browserSet |
        # Filter by denylist + enrich
        {clients:
            map(select([.class] | inside($denylist) | not)) |
            # For browsers (apps with their own session restore dialog), keep only the
            # first window by workspace ID. The app restores the rest itself.
            sort_by(.workspace.id) |
            group_by(.class) |
            map(
                if ($browserSet[.[0].class | ascii_downcase] // false) then [.[0]]
                else .
                end
            ) |
            flatten(1) |
            map(
                .address as $addr |
                . + {
                    launchCommand: $launchMap[$addr],
                    monitor: $monitorMap[.monitor | tostring]
                } + (if $cwdMap[$addr] then {cwd: $cwdMap[$addr]} else {} end)
            )
        }
    ')

    # Log what the denylist removed
    echo "$windows_json" | jaq -r --argjson denylist "$denylist_json" \
        '[.[] | select([.class] | inside($denylist))] | .[] |
        "  class=\(.class) ws=\(.workspace.id) title=\"\(.title[0:40] // "")\" (denied)"' \
        2>/dev/null | while IFS= read -r line; do
        log_debug "session-save:$line"
    done

    # Log what browser dedup removed (windows saved before dedup vs after)
    echo "$windows_json" | jaq -r \
        --argjson denylist "$denylist_json" \
        --argjson browsers "$browsers_json" '
        ($browsers | map({key: ., value: true}) | from_entries) as $browserSet |
        [.[] | select([.class] | inside($denylist) | not)] |
        sort_by(.workspace.id) | group_by(.class) |
        map(select($browserSet[.[0].class | ascii_downcase] // false) | .[1:] | .[]) |
        .[] | "  class=\(.class) ws=\(.workspace.id) title=\"\(.title[0:40] // "")\" (browser-deduped)"
    ' 2>/dev/null | while IFS= read -r line; do
        log_debug "session-save:$line"
    done

    # Log final saved entries
    log_debug "session-save: final saved entries ($(echo "$filtered_session" | jaq '.clients | length')):"
    echo "$filtered_session" | jaq -r '.clients[] |
        "  class=\(.class) ws=\(.workspace.id) monitor=\(.monitor // "?") launch=\(.launchCommand // "(none)") cwd=\(.cwd // "(none)") title=\"\(.title[0:40] // "")\""' \
        2>/dev/null | while IFS= read -r line; do
        log_debug "session-save:$line"
    done

    # Phase 5: Write enrichment file with metadata
    enrichment_file="$SESSION_DIR/hyprland-session-$SLOT.json"
    timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

    echo "$filtered_session" | jaq \
        --arg timestamp "$timestamp" \
        --arg slot "$SLOT" \
        '. + {
            metadata: {
                timestamp: $timestamp,
                slot: $slot,
                source: "hyprctl-native"
            }
        }' > "$enrichment_file"

    # Create symlink for current slot
    ln -sf "$enrichment_file" "$SESSION_DIR/hyprland-session.json"

    window_count=$(echo "$filtered_session" | jaq '.clients | length')
    timeout 1 notify-send "Session Manager" "✅ Saved $window_count windows to slot: $SLOT" -t 3000 2>/dev/null || true
    log_info "session-save: completed windows=$window_count slot=$SLOT"
}

save_session
