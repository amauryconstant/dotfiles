#!/usr/bin/env sh

# Script: session-save.sh
# Purpose: Save Hyprland session using hyprdrover with CWD enrichment + launch command mapping
# Requirements: Arch Linux, hyprdrover, hyprctl, jaq

SESSION_DIR="$HOME/.local/state/dotfiles"
DENYLIST_FILE="$HOME/.config/dotfiles/session-denylist.conf"
HYPRDROVER_DIR="$HOME/.config/hyprdrover/sessions"

# Default slot name
SLOT="${1:-default}"

# Debug logging (for AI debugging)
log_debug() {
    logger -t hypr-session "[DEBUG] $*"
}

log_info() {
    logger -t hypr-session "[INFO] $*"
}

# Validate slot name (alphanumeric, dash, underscore only)
if ! echo "$SLOT" | grep -qE '^[a-zA-Z0-9_-]+$'; then
    timeout 1 notify-send "Session Manager" "❌ Invalid slot name: $SLOT" -u critical -t 3000 2>/dev/null || true
    exit 1
fi

# Ensure directories exist
mkdir -p "$SESSION_DIR" "$HYPRDROVER_DIR"

# Load denylist (one class per line)
load_denylist() {
    if [ -f "$DENYLIST_FILE" ]; then
        grep -v '^#' "$DENYLIST_FILE" | grep -v '^$'
    else
        # Default denylist (ephemeral/UI elements)
        printf "wofi\nwlogout\ndunst\nwaybar\nhyprpicker\n"
    fi
}

# Map window class to proper launch command
get_launch_command() {
    class="$1"

    # Case-insensitive class matching
    class_lower=$(echo "$class" | tr '[:upper:]' '[:lower:]')

    case "$class_lower" in
        # Code editors (Electron apps)
        "code-oss"|"code")
            echo "code"
            ;;
        "vscodium")
            echo "vscodium"
            ;;

        # Browsers
        "firefox")
            echo "firefox"
            ;;
        "chromium"|"chromium-browser")
            echo "chromium"
            ;;
        "brave"|"brave-browser")
            echo "brave"
            ;;

        # Terminals
        "com.mitchellh.ghostty"|"ghostty")
            echo "ghostty"
            ;;
        "kitty")
            echo "kitty"
            ;;
        "alacritty")
            echo "alacritty"
            ;;
        "foot")
            echo "foot"
            ;;

        # Flatpak apps (detect by class pattern or explicit mapping)
        "slack")
            if flatpak list --app 2>/dev/null | grep -q "com.slack.Slack"; then
                echo "flatpak run com.slack.Slack"
            else
                echo "slack"
            fi
            ;;
        "spotify")
            if flatpak list --app 2>/dev/null | grep -q "com.spotify.Client"; then
                echo "flatpak run com.spotify.Client"
            else
                echo "spotify"
            fi
            ;;
        "discord")
            if flatpak list --app 2>/dev/null | grep -q "com.discordapp.Discord"; then
                echo "flatpak run com.discordapp.Discord"
            else
                echo "discord"
            fi
            ;;

        # File managers
        "dolphin")
            echo "dolphin"
            ;;
        "thunar")
            echo "thunar"
            ;;
        "nautilus")
            echo "nautilus"
            ;;

        # Default: Use class name as command (lowercase)
        *)
            echo "$class_lower"
            ;;
    esac
}

# Check critical dependencies
check_dependencies() {
    for cmd in hyprdrover hyprctl jaq; do
        if ! command -v "$cmd" >/dev/null 2>&1; then
            timeout 1 notify-send "Session Manager" "❌ Missing dependency: $cmd\nRun: package-manager sync" -u critical -t 5000 2>/dev/null || true
            logger -t hypr-session "[ERROR] session-save: missing dependency $cmd"
            exit 1
        fi
    done
    log_debug "session-save: dependencies OK"
}

# Wait for Hyprland to be ready
wait_for_hyprland() {
    local timeout="${1:-30}"
    local elapsed=0
    
    log_debug "session-save: waiting for Hyprland (timeout: ${timeout}s)"
    while [ $elapsed -lt $timeout ]; do
        if hyprctl version >/dev/null 2>&1; then
            log_debug "session-save: Hyprland ready"
            return 0
        fi
        sleep 0.5
        elapsed=$((elapsed + 1))
    done
    
    timeout 1 notify-send "Session Manager" "❌ Hyprland not responding after ${timeout}s" -u critical -t 5000 2>/dev/null || true
    logger -t hypr-session "[ERROR] session-save: Hyprland not responding after ${timeout}s"
    return 1
}

check_dependencies
wait_for_hyprland || exit 1

# Main save logic
save_session() {
    timeout 1 notify-send "Session Manager" "Saving Hyprland session to slot: $SLOT..." -t 2000 2>/dev/null || true
    log_info "session-save: started slot=$SLOT"

    # Phase 1: Use hyprdrover to save core session (with timeout)
    log_debug "session-save: calling hyprdrover --save $SLOT"
    if ! timeout 30 hyprdrover --save "$SLOT" >/dev/null 2>&1; then
        local exit_code=$?
        if [ $exit_code -eq 124 ]; then
            timeout 1 notify-send "Session Manager" "❌ hyprdrover save timed out (30s)" -u critical -t 5000 2>/dev/null || true
            logger -t hypr-session "[ERROR] session-save: hyprdrover timeout (30s)"
        else
            timeout 1 notify-send "Session Manager" "❌ Failed to save session with hyprdrover" -u critical -t 5000 2>/dev/null || true
            logger -t hypr-session "[ERROR] session-save: hyprdrover failed exit=$exit_code"
        fi
        exit 1
    fi
    log_debug "session-save: hyprdrover save completed"

    # Phase 2: Extract terminal CWDs for enrichment
    windows_json=$(hyprctl clients -j)

    # Get denylist as JSON array
    denylist_json=$(load_denylist | jaq -R -s 'split("\n") | map(select(length > 0))')

    # Build CWD map for terminal windows
    temp_pids=$(mktemp)
    temp_cwds=$(mktemp)

    # Extract terminal window PIDs
    echo "$windows_json" | jaq -r '
        .[] |
        select(.class | test("ghostty|kitty|alacritty|foot|wezterm|Ghostty|Kitty|Alacritty|Foot|WezTerm|com.mitchellh.ghostty"; "i")) |
        "\(.pid)|\(.class)|\(.address)"
    ' > "$temp_pids"

    # Collect CWD for each terminal
    while IFS='|' read -r pid _class address; do
        cwd=""

        # Try direct CWD first
        if [ -d "/proc/$pid" ]; then
            direct_cwd=$(readlink "/proc/$pid/cwd" 2>/dev/null || echo "")
            if [ -n "$direct_cwd" ] && [ -d "$direct_cwd" ]; then
                cwd="$direct_cwd"
            else
                # Try shell child process
                shell_pid=$(pgrep -P "$pid" 2>/dev/null | head -n 1)
                if [ -n "$shell_pid" ] && [ -d "/proc/$shell_pid" ]; then
                    shell_cwd=$(readlink "/proc/$shell_pid/cwd" 2>/dev/null || echo "")
                    if [ -n "$shell_cwd" ] && [ -d "$shell_cwd" ]; then
                        cwd="$shell_cwd"
                    fi
                fi
            fi
        fi

        # Store as JSON if CWD found
        if [ -n "$cwd" ]; then
            jaq -n --arg addr "$address" --arg cwd "$cwd" \
                '{($addr): $cwd}' >> "$temp_cwds"
        fi
    done < "$temp_pids"

    # Aggregate CWD map
    if [ -s "$temp_cwds" ]; then
        cwd_map=$(jaq -s 'reduce .[] as $item ({}; . + $item)' < "$temp_cwds")
    else
        cwd_map="{}"
    fi

    rm -f "$temp_pids" "$temp_cwds"

    # Phase 3: Build launch command map
    temp_launch=$(mktemp)

    echo "$windows_json" | jaq -r '.[] | "\(.address)|\(.class)"' | while IFS='|' read -r address class; do
        launch_cmd=$(get_launch_command "$class")
        jaq -n --arg addr "$address" --arg cmd "$launch_cmd" \
            '{($addr): $cmd}' >> "$temp_launch"
    done

    if [ -s "$temp_launch" ]; then
        launch_map=$(jaq -s 'reduce .[] as $item ({}; . + $item)' < "$temp_launch")
    else
        launch_map="{}"
    fi

    rm -f "$temp_launch"

    # Phase 4: Load hyprdrover's JSON and apply custom filters
    hyprdrover_file="$HYPRDROVER_DIR/$SLOT.json"

    if [ ! -f "$hyprdrover_file" ]; then
        timeout 1 notify-send "Session Manager" "❌ hyprdrover session file not found" -u critical -t 5000 2>/dev/null || true
        exit 1
    fi

    # Read hyprdrover session
    hyprdrover_session=$(cat "$hyprdrover_file")

    # Apply custom denylist + enrich with CWD and launch commands
    filtered_session=$(echo "$hyprdrover_session" | jaq \
        --argjson denylist "$denylist_json" \
        --argjson cwdMap "$cwd_map" \
        --argjson launchMap "$launch_map" '
        # Filter clients by denylist
        .clients |= map(select([.class] | inside($denylist) | not)) |
        # Enrich with CWD data and launch commands
        .clients |= map(
            .address as $addr |
            . + {
                launchCommand: $launchMap[$addr]
            } + (
                if $cwdMap[$addr] then
                    {cwd: $cwdMap[$addr]}
                else
                    {}
                end
            )
        )
    ')

    # Phase 5: Write enrichment file with metadata
    enrichment_file="$SESSION_DIR/hyprland-session-$SLOT.json"
    timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

    echo "$filtered_session" | jaq \
        --arg timestamp "$timestamp" \
        --arg slot "$SLOT" \
        '. + {
            metadata: {
                timestamp: $timestamp,
                slot: $slot,
                source: "hyprdrover-hybrid"
            }
        }' > "$enrichment_file"

    # Create symlink for current slot
    ln -sf "$enrichment_file" "$SESSION_DIR/hyprland-session.json"

    window_count=$(echo "$filtered_session" | jaq '.clients | length')
    timeout 1 notify-send "Session Manager" "✅ Saved $window_count windows to slot: $SLOT" -t 3000 2>/dev/null || true
    log_info "session-save: completed windows=$window_count slot=$SLOT"
}

save_session
