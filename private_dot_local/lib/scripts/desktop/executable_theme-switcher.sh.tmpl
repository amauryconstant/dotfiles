#!/usr/bin/env sh

# Script: theme-switcher.sh
# Purpose: Switch between themes and reload applications
# Requirements: Arch Linux, Hyprland, Waybar, Dunst, Ghostty

# Source UI library for monitor-focused notifications
if [ -n "$UI_LIB" ] && [ -f "$UI_LIB" ]; then
    # shellcheck source=/home/amaury/.local/lib/scripts/core/gum-ui.sh
    . "$UI_LIB"
elif [ -f "$HOME/.local/lib/scripts/core/gum-ui.sh" ]; then
    . "$HOME/.local/lib/scripts/core/gum-ui.sh"
fi

THEMES_DIR="$HOME/.config/themes"
CURRENT_LINK="$THEMES_DIR/current"

# Format theme name for display (kebab-case → Title Case)
# Usage: format_theme_name "catppuccin-latte" → "Catppuccin Latte"
format_theme_name() {
    echo "$1" | sed -E 's/(^|-)([a-z])/\1\u\2/g; s/-/ /g'
}

# Display usage information
show_usage() {
    cat <<EOF
Usage: theme-switcher.sh <command> [theme-name]

Commands:
    switch <theme-name>    Switch to the specified theme
    list                   List all available themes
    current                Show the currently active theme

Available themes:
$(list_themes | sed 's/^/    /')

EOF
}

# List all available themes
list_themes() {
    for theme_dir in "$THEMES_DIR"/*; do
        [ -d "$theme_dir" ] || continue
        theme=$(basename "$theme_dir")
        [ "$theme" = "current" ] && continue
        format_theme_name "$theme"
    done | sort
}

# Get current theme name
get_current_theme() {
    if [ -L "$CURRENT_LINK" ]; then
        theme=$(readlink "$CURRENT_LINK" | xargs basename)
        format_theme_name "$theme"
    else
        echo "none"
    fi
}

# Validate theme exists
validate_theme() {
    theme_name="$1"
    theme_path="$THEMES_DIR/$theme_name"

    if [ ! -d "$theme_path" ]; then
        echo "Error: Theme '$theme_name' does not exist" >&2
        echo "" >&2
        echo "Available themes:" >&2
        list_themes | sed 's/^/  /' >&2
        return 1
    fi
    return 0
}

# Reload applications to pick up new theme
reload_applications() {
    # Reload Hyprland configuration
    if command -v hyprctl >/dev/null 2>&1; then
        hyprctl reload >/dev/null 2>&1
    fi

    # Reload Waybar
    if pgrep -x waybar >/dev/null; then
        killall -SIGUSR2 waybar 2>/dev/null
    fi

    # Restart Dunst to reload theme
    if pgrep -x dunst >/dev/null; then
        killall dunst 2>/dev/null
        sleep 0.5
        dunst >/dev/null 2>&1 &
    fi

    # Reload Ghostty
    if pgrep -x ghostty >/dev/null; then
        killall -SIGUSR2 ghostty 2>/dev/null
    fi
}

# Switch to a new theme
switch_theme() {
    theme_name="$1"

    if [ -z "$theme_name" ]; then
        echo "Error: No theme specified" >&2
        show_usage
        return 1
    fi

    # Validate theme exists
    validate_theme "$theme_name" || return 1

    theme_path="$THEMES_DIR/$theme_name"
    current_theme=$(get_current_theme)

    # Check if already on this theme
    if [ "$current_theme" = "$theme_name" ]; then
        echo "Already using theme: $theme_name"
        return 0
    fi

    # Update symlink
    rm -f "$CURRENT_LINK"
    ln -s "$theme_path" "$CURRENT_LINK"

    echo "Switched to theme: $theme_name"

    # Select random wallpaper from new theme if wallpapers exist
    wallpaper_dir="$HOME/.config/wallpapers/$theme_name"
    if [ -d "$wallpaper_dir" ] && find "$wallpaper_dir" -maxdepth 1 -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.webp" \) -print -quit 2>/dev/null | grep -q .; then
        wallpaper=$(find "$wallpaper_dir" -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.webp" \) 2>/dev/null | shuf -n 1)
        if [ -n "$wallpaper" ] && [ -f "$wallpaper" ]; then
            # Call set-wallpaper script if it exists
            if [ -x "$HOME/.local/lib/scripts/media/set-wallpaper.sh" ]; then
                "$HOME/.local/lib/scripts/media/set-wallpaper.sh" "$wallpaper" fade 2 >/dev/null 2>&1 &
            fi
        fi
    fi

    # Reload applications
    reload_applications

    # Apply theme to additional applications
    if [ -f "$HOME/.local/lib/scripts/desktop/theme-apply-vscode.sh" ]; then
        "$HOME/.local/lib/scripts/desktop/theme-apply-vscode.sh" 2>/dev/null || true
    fi
    if [ -f "$HOME/.local/lib/scripts/desktop/theme-apply-firefox.sh" ]; then
        "$HOME/.local/lib/scripts/desktop/theme-apply-firefox.sh" 2>/dev/null || true
    fi
    if [ -f "$HOME/.local/lib/scripts/desktop/theme-apply-spotify.sh" ]; then
        "$HOME/.local/lib/scripts/desktop/theme-apply-spotify.sh" 2>/dev/null || true
    fi

    # Call user hook
    if [ -f "$HOME/.local/lib/scripts/core/hook-runner.sh" ]; then
        "$HOME/.local/lib/scripts/core/hook-runner.sh" theme-change "$theme_name"
    fi

    # Send desktop notification (monitor-focused if available)
    formatted_name=$(format_theme_name "$theme_name")
    if command -v ui_notify_focused >/dev/null 2>&1; then
        ui_notify_focused "Theme Changed" "Switched to $formatted_name"
    elif command -v notify-send >/dev/null 2>&1; then
        notify-send "Theme Changed" "Switched to $formatted_name" -t 3000 2>/dev/null
    fi
}

# Main command dispatcher
main() {
    command="$1"
    shift

    case "$command" in
        switch)
            switch_theme "$@"
            ;;
        list)
            list_themes
            ;;
        current)
            get_current_theme
            ;;
        *)
            show_usage
            return 1
            ;;
    esac
}

main "$@"
